"use strict";var WSB;(function(n){let r;(function(n){n[n.MsbAjaxMakeHttpRequestAsyncError=-1]="MsbAjaxMakeHttpRequestAsyncError";n[n.ResponseJsonParseError=-2]="ResponseJsonParseError";n[n.ReadResponseError=-3]="ReadResponseError";n[n.ReadErrorStatusResponseError=-4]="ReadErrorStatusResponseError";n[n.NoToken=-5]="NoToken";n[n.FetchError=-6]="FetchError";n[n.UncaughtError=-7]="UncaughtError";n[n.NoMsbLokiAccessToken=-8]="NoMsbLokiAccessToken";n[n.Aborted=-9]="Aborted";n[n.TimedOut=-11]="TimedOut";n[n.XhrError=-12]="XhrError";n[n.XhrCompleted=-13]="XhrCompleted";n[n.MsbTokenExpiredBeforeRequest=-14]="MsbTokenExpiredBeforeRequest";n[n.UrlUnavailable=-15]="UrlUnavailable";n[n.RefreshTokenFailure=-16]="RefreshTokenFailure";n[n.MsbHttpBuildApiParameterError=-17]="MsbHttpBuildApiParameterError"})(r=n.ClientErrorCode||(n.ClientErrorCode={}));let t;(function(n){n[n.Unknown=0]="Unknown";n[n.Enabled=1]="Enabled";n[n.Disabled=2]="Disabled"})(t=n.TenantMsbStatus||(n.TenantMsbStatus={}));n.MsbStateExpiryTimeInMs=432e6;const u=50;class i{static init(){this.isMsbSupported()&&(n.msbHost=new i)}static isMsbSupported(){return n.RuntimeConfig.EntryPointApp==0}constructor(){this.midgardLanguageChecked=!1;n.config.msbEnableAccountManager?(this.accountCache=new n.MsbAccountCache,this.accountManager=new n.MsbAccountManager(n.getAccessTokenManager()),this.verticalManager=new n.MsbVerticalManager2(this.accountManager)):(this.tokenManager=new n.MsbTokenManager(n.getAccessTokenManager()),this.tenantManager=new n.MsbTenantManager(this.tokenManager),this.verticalManager=new n.MsbVerticalManager(this.tokenManager,this.tenantManager),this.userConfigManager=new n.MsbUserConfigManager(this.tokenManager,this.tenantManager));this.features=new n.MsbFeatureUtils;this.httpWrapper=new n.MsbHttpWrapper;this.dataAccess=new n.MsbDataAccess;this.prefetchManager=new n.MsbPrefetchManager;this.substrateLogger=new n.MsbSubstrateLogger;n.config.msbEnableProactiveSearchTransfers&&n.MsbProactiveSearchManager&&(this.proactiveSearchManager=new n.MsbProactiveSearchManager);this.photoManager=new n.MsbPhotoManager;this.qfUtils=new n.MsbQfUtils;this.urlUtils=new n.MsbUrlUtils;this.iconUtils=new n.MsbIconUtils;n.config.msbEnableAccountManager&&n.config.msbLoadQfScriptEarly&&n.safeSetTimeout(()=>{n.msbHost.shouldForceEnterprise()&&_w.postMessage({messageType:"BingAtWork:WsbQfScriptLoad"},"*")},u,"MsbTokenManager Constructor");n.config.msbEnableChatUpsell&&(this.msbWorkChatUtils=new n.MsbWorkChatUtils);n.config.msbRefreshMidgardResroucesList&&n.Host.bindBootstrapDone(()=>{this.refreshMidgardResourcesListAsync()})}getClientType(t){let i="Wsb";return t===n.Scope.Work&&(i="WsbBingVertical"),i}isTenantMsbEnabled(){var t,i;return n.config.msbEnableAccountManager?(i=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.tenantSettings.data)===null||i===void 0?void 0:i.isEnabled:n.msbHost.tenantManager.isTenantMsbEnabled()}getTenantMsbStatus(){var i,r;if(n.config.msbEnableAccountManager){const n=(r=(i=this.accountManager.getCurrentAccount())===null||i===void 0?void 0:i.tenantSettings.data)===null||r===void 0?void 0:r.isEnabled;return n===!0?t.Enabled:n===!1?t.Disabled:t.Unknown}return n.msbHost.tenantManager.getTenantMsbStatus()}isMsbInternalTenant(){var t,i;return n.config.msbEnableAccountManager?(i=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.tenantSettings.data)===null||i===void 0?void 0:i.isMsitInternal:n.msbHost.tenantManager.getIsMsbInternalTenant()}isEduTenant(){var t;if(n.config.msbEnableAccountManager){const i=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.tenantSettings.data,r=i===null||i===void 0?void 0:i.isEnabled,u=i===null||i===void 0?void 0:i.isEdu;return(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbEDUTenant)?r:r&&u}return n.msbHost.tenantManager.getIsMsbEduTenantEnabled()}isGccTenant(){var t,i;return n.config.msbEnableAccountManager?!!((i=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.authInfo.data)===null||i===void 0?void 0:i.gccRegion):n.msbHost.tenantManager.isGccTenant()}isGccModerateTenant(){var t,i;if(n.config.msbEnableAccountManager)return((i=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.authInfo.data)===null||i===void 0?void 0:i.gccRegion)===1;throw new Error("New code behind MsbAccountManager");}isGccHighTenant(){var t,i;return n.config.msbEnableAccountManager?((i=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.authInfo.data)===null||i===void 0?void 0:i.gccRegion)===2:n.msbHost.tenantManager.isGccHighTenant()}getTenantName(){var t,i,r,u,f,e;return n.config.msbEnableAccountManager?(u=(r=(i=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.authInfo.data)===null||i===void 0?void 0:i.tenantName)!==null&&r!==void 0?r:n.SubstrateTenantName)!==null&&u!==void 0?u:"":(e=(f=n.msbHost.tenantManager.getStoredMsbTenantName())!==null&&f!==void 0?f:n.SubstrateTenantName)!==null&&e!==void 0?e:""}isIconUrlEnabled(t){return!!(t&&n.config.msbEnableIconUrl)}tenantHasLogo(){var t;if(n.config.msbEnableAccountManager){const n=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.tenantSettings.data;if(!n)return!1;const{iconLargeDataUri:i,iconLargeIsDefault:r,iconUrl:u}=n;return!!(i&&!r||this.isIconUrlEnabled(u))}return n.msbHost.tenantManager.tenantHasLogo()}getTenantBranding(){if(n.config.msbEnableAccountManager){const t=this.accountManager.getCurrentAccount();if(!t)return undefined;const i=t.authInfo.data,r=t.tenantSettings.data;if(!i||!r)return undefined;const{tenantName:n}=i,{iconLargeDataUri:u,iconLargeIsDefault:e,iconUrl:f,themeBackColor:o,themeForeColor:s}=r;return u||n||this.isIconUrlEnabled(f)?{logoDataUri:u,iconLargeIsDefault:e,iconUrl:f,backColor:o,companyName:n!==null&&n!==void 0?n:"",fontColor:s}:undefined}return n.msbHost.tenantManager.getMsbBranding()}getTenantVariants(){var t,i,r;if(n.config.msbEnableAccountManager){const n=(r=(i=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.tenantSettings.data)===null||i===void 0?void 0:i.variants)!==null&&r!==void 0?r:[];return n.join(",")}return n.msbHost.tenantManager.getMsbTenantVariants()}hasBeenMsbUser(){return n.config.msbEnableAccountManager?this.isTenantMsbEnabled()||n.config.msbUseCachedMsbState&&this.isTenantRecentlyEnabled():n.msbHost.tenantManager.hasBeenMsbUser()}isTenantRecentlyEnabled(){var t;if(n.config.msbEnableAccountManager){const i=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.runtimeInfo.lastTenantSuccessEnabledTime;if(typeof i!="number")return undefined;const r=n.getCurrentTime()-i;return r<n.MsbStateExpiryTimeInMs}return this.tenantManager.isLastEnabledTimeValid()}shouldForceEnterprise(){var t,i;return n.config.msbEnableAccountManager?((i=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.tenantSettings.data)===null||i===void 0?void 0:i.isEnabled)||n.config.msbUseCachedMsbState&&this.isTenantRecentlyEnabled():n.msbHost.tenantManager.shouldForceEnterpriseAccount()}getAadUserInfo(){if(n.config.msbEnableAccountManager){const t=n.msbHost.accountManager.getCurrentAccount();if(!t||!t.authInfo.data)return undefined;const{tenantId:i,tenantName:r,userObjectId:u,userFirstName:f}=t.authInfo.data;return{tenantId:i,tenantName:r,userAadId:u,email:t.accountUserName,userFirstName:f}}return n.msbHost.tokenManager.getAadUserInfo()}mapRedirectTarget(t){if(n.config.msbEnableAccountManager)switch(t){case"RecommendedPeople":case"ExpandedOrgChart":return this.features.isWorkScopeDsbRedirectEnabled()?"Work":"People";case"PopularSearchesFeedFallback":return this.features.isWorkScopeDsbRedirectEnabled()?"Work":"Web";case"People":case"Bookmarks":return this.features.isWorkScopeSHRedirectEnabled()?"Work":"People";case"MFIL":return"Documents";case"MPPL":case"MGRP":return"People";case"MBKS":return"Web";default:return undefined}else return n.msbHost.tenantManager.redirectScope(t)}hasEduAssignments(){var t,i;return n.config.msbEnableAccountManager?(i=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.userConfig.data)===null||i===void 0?void 0:i.hasEduAssignments:n.msbHost.userConfigManager.getHasEduAssignmentsFlags()}isEduHigherEducationTenant(){var t,i,r,u;return n.config.msbEnableAccountManager?this.isEduTenant()&&((r=(i=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.userConfig.data)===null||i===void 0?void 0:i.industry)===null||r===void 0?void 0:r.includes("higher education")):(u=n.msbHost.userConfigManager)===null||u===void 0?void 0:u.isEduHigherEducationEnabled()}isEduK12Tenant(){var t,i,r,u;return n.config.msbEnableAccountManager?this.isEduTenant()&&((r=(i=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.userConfig.data)===null||i===void 0?void 0:i.industry)===null||r===void 0?void 0:r.includes("k-12")):(u=n.msbHost.userConfigManager)===null||u===void 0?void 0:u.isEduK12Enabled()}isEduFacultyTenant(){var t,i,r,u;return n.config.msbEnableAccountManager?this.isEduTenant()&&((r=(i=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.userConfig.data)===null||i===void 0?void 0:i.licenseNames)===null||r===void 0?void 0:r.includes("EduFaculty")):(u=n.msbHost.userConfigManager)===null||u===void 0?void 0:u.isEduLicenseEnabled("EduFaculty")}isWorkScope(t,i){return n.config.msbEnableAccountManager?this.features.isWorkScopeApplicable()&&(t===21||i==n.Scope.Work):n.msbHost.tenantManager.isMsbWorkScope(t,i)}getChatEligibility(){var t,i,r;return(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbForceChatEligibility)&&this.msbWorkChatUtils.isValidTestHookEligibilityState(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbForceChatEligibility)?n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbForceChatEligibility:n.config.msbEnableAccountManager?(r=(i=(t=this.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.authInfo.data)===null||i===void 0?void 0:i.chatEligibilityType)!==null&&r!==void 0?r:"None":n.msbHost.tokenManager.getChatEligibility()}async refreshMidgardResourcesListAsync(){try{const i=this.urlUtils.getMidgardRsourcesListUrl(),r={method:"GET",url:i,skipToken:!0},{result:u}=await this.httpWrapper.sendHttpAsync(r),{midgardResources:n,qfResources:t}=u,{midgardResources:f,qfResources:e}=BingAtWork,o=(n===null||n===void 0?void 0:n.length)>0?n:f,s=(t===null||t===void 0?void 0:t.length)>0?t:e;Object.assign(BingAtWork,{midgardResources:o,qfResources:s})}catch(t){const u="refreshMidgardResourcesListAsync",i=this.isMsbInternalTenant(),r="Wsb Refresh Midgard Resources List Failed";if(t instanceof n.MsbHttpError){const{message:f,stack:e,isBrowserOnline:o,hResultString:s,responseContext:h,innerError:c}=t,{statusCode:l,serverTraceId:a,requestSentTime:v,responseReceivedTime:y}=h,p=i?`innerError=${n.stringifyError(c)}`:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError(r,f,{statusCode:l,stackTrace:e,serverTraceId:a,additionalMessage:p},{Online:o,HResult:s,ReqTS:v,ResTS:y,caller:u})}else{const u=i?n.stringifyError(t):"";_w.bfbWsbTel&&bfbWsbTel.logError(r,"non-HTTP",{additionalMessage:u})}}}checkMidgardLanguage(){if(!this.midgardLanguageChecked)try{const t=this.getLowerCaseLangPart(this.getSystemLanguage()),i=this.getLowerCaseLangPart(this.getMidgardLanguage());if(t&&i&&t!=i){const t="MsbLangMis",i=n.LightweightStorage.getItem(t);if(i&&n.getCurrentTime()-Number(i)<864e5)return;const r=this.formatLanguageInfo();_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Midgard Language Mismatch",r);n.LightweightStorage.setItem(t,n.getCurrentTime().toString())}this.midgardLanguageChecked=!0}catch(t){}}resetLanguageCookie(){try{const n=this.getSystemLanguage();n&&sj_cook.set("SRCHHPGUSR","SRCHLANG",n)}catch(t){const i=`langInfo=${this.formatLanguageInfo()}&error=${n.stringifyError(t)}`;_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Reset Language Cookie Failed",i)}}switchScope(t){if(n.isDsbGleamSwitchToScopeEnabled(t)){const t=this.getDisplayedGleamScope();n.Host.switchToScope(t)}else n.isWorkScopeDsbGleamRedirect(t)&&n.Host.switchToScope(n.Scope.Work)}getDisplayedGleamScope(){var r,u;let t=n.Scope.All;const f=(u=(r=n.msbDsbHost.gleamManager.getDynamicSearchBoxContent())===null||r===void 0?void 0:r.attributes)===null||u===void 0?void 0:u.contentKey,i=f===null||f===void 0?void 0:f.split("_"),e=(i===null||i===void 0?void 0:i.length)>1?i[1]:"";switch(e){case"People":t=n.Scope.People;break;case"File":t=n.Scope.Documents;break;case"BriefCase":t=n.Scope.Work;break;default:t=n.Scope.Work}return t}getLowerCaseLangPart(n){var t,i;if((i=(t=n===null||n===void 0?void 0:n.split("-"))===null||t===void 0?void 0:t[0])!==null&&i!==void 0)return i.toLowerCase()}getSystemLanguage(){return SearchAppWrapper.CortanaApp.systemLanguage||SearchAppWrapper.CortanaApp.uiLanguage}getMidgardLanguage(){var n;if((n=_w.WsbStrings)!==null&&n!==void 0)return n.culture}formatLanguageInfo(){try{const{systemLanguage:t,uiLanguage:i,region:r}=SearchAppWrapper.CortanaApp,{language:u,languages:n}=navigator,f=sj_cook.get("SRCHHPGUSR","SRCHLANG"),e=this.getMidgardLanguage();return`sys=${t};ui=${i};r=${r};nl=${u};nll=${n===null||n===void 0?void 0:n.join(",")};cook=${f};midg=${e}`}catch(t){return`<error> ${n.stringifyError(t)}`}}}n.MsbHost=i})(WSB||(WSB={})),function(n){class t{isQwsEnabled(){return!n.shouldShowDSBLayout()&&!n.msbHost.isGccHighTenant()}isHideTopAppEnabled(){return this.isQwsEnabled()&&n.config.msbHideTopApp}isQwsTopListEnabled(){return this.isQwsEnabled()&&n.config.msbQwsShowTopList}isQwsCacheEnabled(){return this.isQwsEnabled()&&n.config.msbEnableQwsCache}isQwsRecDocsEnabled(){return this.isQwsEnabled()&&n.config.msbQwsShowRecommendedDocs}isQwsDocSrcEnabled(t){const i=this.isQwsRecDocsEnabled()&&n.isMsbEnterprise(),r=n.config.use3sRecRecommendedFiles&&n.isMsftAccountConnected;switch(t){case"SSUE":return i&&!r;case"SREE":return i&&r;default:return!1}}isTopBrandingBarEnabled(){return!n.config.useCobaltCSS&&this.isBrandingEnabled()}isScopeListBrandingLogoEnabled(){return n.config.useCobaltCSS&&this.isBrandingEnabled()&&(!n.msbHost.isMsbInternalTenant()||n.config.msbCompanyLogoScopeBarEnabledMS)}isBrandingEnabled(){return n.msbHost.shouldForceEnterprise()&&!n.msbHost.isGccHighTenant()}isAuthLogEnabled(){return n.config.msbEnableAuthLog}isThorProxyEnabled(){return n.msbHost.isMsbInternalTenant()?n.config.msbEnabledThorProxyMS:n.msbHost.isEduTenant()?n.config.msbEnabledThorProxyEdu:n.config.msbEnabledThorProxy}isServerGleamEnabled(){return n.msbHost.isMsbInternalTenant()?n.config.msbDsbUseServerGleamMS:n.config.msbDsbUseServerGleam}isEnterpriseScopeEnabled(){return n.config.msbEnableAccountManager?this.isWorkScopeApplicable():n.msbHost.tenantManager.isMsbEnterpriseScopeEnabled()}isWorkScopeApplicable(){return n.config.msbEnableAccountManager?(n.config.msbVerticalWorkScopeEnabled&&!n.msbHost.isEduTenant()||this.isEduScopeApplicable())&&n.msbHost.shouldForceEnterprise()&&!n.msbHost.isGccTenant():n.msbHost.tenantManager.isWorkScopeApplicable()}isEduScopeApplicable(){return n.config.msbEnableAccountManager?n.config.msbWorkScopeEduEnabled&&n.msbHost.isEduTenant():n.msbHost.tenantManager.isEduScopeApplicable()}isEduScopeApplicableFromStoredValue(){return n.config.msbEnableAccountManager?this.isEduScopeApplicable():n.msbHost.tenantManager.isEduScopeApplicable(!0)}isWorkScopeZiPageContentEnabled(){return n.config.msbEnableAccountManager?!n.config.msbWorkScopeZiPageContentDisabled&&this.isWorkScopeApplicable()&&!n.msbHost.isEduTenant():n.msbHost.tenantManager.isWorkScopeZiPageContentEnabled()}isWorkMruEnabled(){return n.config.msbEnableAccountManager?n.msbHost.shouldForceEnterprise()&&!n.msbHost.isEduTenant():n.msbHost.tenantManager.isWorkMruEnabled()}isWorkScopeDsbRedirectEnabled(){return n.config.msbEnableAccountManager?this.isWorkScopeApplicable()&&(n.config.msbWorkScopeDsbRedirectEnabled&&n.msbHost.isMsbInternalTenant()||n.config.msbWorkScopeDsbRedirectEnabledWW):n.msbHost.tenantManager.isMsbWorkScopeDsbRedirectEnabled()}isWorkScopeSHRedirectEnabled(){return n.config.msbEnableAccountManager?this.isWorkScopeApplicable()&&(n.config.msbEnableSearchHomeWSRedirect&&n.msbHost.isMsbInternalTenant()||n.config.msbEnableSearchHomeWSRedirectWW):n.msbHost.tenantManager.isMsbWorkScopeSHRedirectEnabled()}isWorkScopeListViewEnabled(){return n.config.msbEnableAccountManager?this.isWorkScopeApplicable()&&(n.config.msbWorkScopeListEnabledWW||n.config.msbWorkScopeListEnabled&&n.msbHost.isMsbInternalTenant()):n.msbHost.tenantManager.isWorkScopeListViewEnabled()}isWorkUpsellApplicable(){return n.config.msbEnableAccountManager?(n.config.msbWorkScopeBannerIndicatorEnabledWW||n.config.msbWorkScopeBannerIndicatorEnabled&&n.msbHost.isMsbInternalTenant())&&this.isWorkScopeApplicable()&&(!n.MockUrlParameters||(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.showWorkUpsell)):n.msbHost.tenantManager.isMsbWorkUpsellApplicable()}isEduMessagesCardEnabled(){return n.config.msbEnableAccountManager?n.config.msbEduMessagesCardEnabled:n.msbHost.tenantManager.isEduMessagesCardEnabled()}isEduViewButtonEnabled(){return n.config.msbEnableAccountManager?n.config.msbEduViewButtonEnabled:n.msbHost.tenantManager.isEduViewButtonEnabled()}isPeopleZeroQueryEnabled(t){return n.config.msbEnablePeopleZQ&&n.isPeopleScopeZI(t)}}n.MsbFeatureUtils=t}(WSB||(WSB={})),function(n){function r(){return{status:"NotStarted"}}function u(){return{status:"Loading"}}function f(n){return{status:"Done",data:n}}function e(n){return{status:"Error",error:n}}function o(n){n.status="Loading"}function s(n,t){n.status="Done";n.data=t}function h(n,t){n.status="Error";n.error=t}function c(n,t){return Math.random()*t+n}function t(n){if(!n)return undefined;try{const t=n.split(".")[1],i=t.replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(i).split("").map(n=>"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(r)}catch(t){return undefined}}function l(n){var i;if((i=t(n))!==null&&i!==void 0)return i.exp}function a(n){if(!n)return{error:"BingAtWork.wsb.wsbAccessToken - not set"};const i=t(n);if(!i)return{error:"BingAtWork.wsb.wsbAccessToken - failed to parse token"};const{appid:r,aud:u,iss:f,scp:e,amr:o}=i;return{appid:r,aud:u,iss:f,scp:e,amr:o}}function v(n){const t=n===null||n===void 0?void 0:n.trim();if(!t)return undefined;const i=t.indexOf(" ");if(i<=0)return undefined;const r=t.substring(0,i),u=t.substring(i+1);return{firstName:r,lastName:u}}function y(n){var r,u;const i=t(n),e=(r=i===null||i===void 0?void 0:i.tenant_region_sub_scope)===null||r===void 0?void 0:r.toLowerCase(),f=(u=i===null||i===void 0?void 0:i.tenant_region_scope)===null||u===void 0?void 0:u.toLowerCase();return e==="gcc"?1:f==="usg"||f==="usgov"?2:0}function d(n){if(!n)return undefined;const r=typeof n.get=="function"?n.get(i):n[i];if(!r)return undefined;const t=r.match(p);if((t===null||t===void 0?void 0:t.length)!=w)return undefined;const u=t[b],f=t[k],e=new Date(f).getTime();return{traceId:u,timestamp:e}}function g(n){try{return n instanceof Error?JSON.stringify(n,Object.getOwnPropertyNames(n)):JSON.stringify(n)}catch(t){return"<failed to stringify error>"}}function nt(n){const i=n<0?4294967296+n:n,r="0x"+i.toString(16);let t="";switch(n){case-2147024891:t="E_ACCESSDENIED";break;case-2147012865:t="WININET_E_CONNECTION_RESET"}return`${n}|${r}|${t}`}function tt(n){let t=n.length,i=0;while(t!==0)i=Math.floor(Math.random()*t),t--,[n[t],n[i]]=[n[i],n[t]];return n}n.makeNotStartedAsyncData=r;n.makeLoadingAsyncData=u;n.makeDoneAsyncData=f;n.makeErrorAsyncData=e;n.setAsyncDataLoading=o;n.setAsyncDataDone=s;n.setAsyncDataError=h;n.getRandomNumInRange=c;n.parseJwt=t;n.parseJwtExp=l;n.getReducedTokenInfo=a;n.getFirstAndLastName=v;n.getGccRegionFromToken=y;const p=/Ref A: ([A-Z0-9]+)\sRef B: ([^\s]+) Ref C: (.+)/,w=4,b=1,k=3,i="x-msedge-ref";n.getMsEdgeRef=d;n.stringifyError=g;n.formatHResultString=nt;n.shuffle=tt}(WSB||(WSB={})),function(n){class t{constructor(){this.setupGlobalFunctions();n.Host.bindShown(()=>{this.transferIg=n.cleanGuid(n.Host.createGuid())})}setupGlobalFunctions(){_w.BingAtWork||(_w.BingAtWork={});BingAtWork.Wsb=BingAtWork.Wsb||{};BingAtWork.Wsb.addMsbUserInfoParameterToUrlAsync=this.addMsbUserInfoParameterToUrlAsync.bind(this);BingAtWork.Wsb.launchUriAsync=this.launchUriAsync.bind(this)}getMsbUrl(t){var i;const r={[0]:n.config.msbApiBaseUrl,[1]:n.config.msbGccApiBaseUrl,[2]:n.config.msbGccHighApiBaseUrl},u=((i=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||i===void 0?void 0:i.gccRegion)?r[BingAtWork.wsb.gccRegion]:n.config.msbApiBaseUrl;return`${u}/${t}`}getDsbUrl(t){var i;const r=n.config.msbDsbUseLocal?n.config.msbDsbApiBaseLocalUrl:n.config.msbDsbApiBaseUrl,u={[0]:r,[1]:n.config.msbDsbGccApiBaseUrl,[2]:n.config.msbDsbGccHighApiBaseUrl},f=((i=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||i===void 0?void 0:i.gccRegion)?u[BingAtWork.wsb.gccRegion]:r;return`${f}/${t}`}getLokiUrl(t){var r,u;let i=n.config.lokiBaseApiUri;return n.msbHost.isMsbInternalTenant()&&n.isMsbEnterprise()&&n.config.lokiBaseApiUriOverrideEnabled&&(i=n.config.lokiMsitBaseApiUri),((r=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||r===void 0?void 0:r.gccRegion)===1?i=n.config.lokiGccBaseApiUri:((u=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||u===void 0?void 0:u.gccRegion)===2&&(i=n.config.lokiGccHighBaseApiUri),`${i}/${t}`}getProactiveWorkSearchUrl(){const n=this.getMsbUrl("v3/proactive/work/search/init");return`${n}?use3s=true&startSearchInInit=true`}getMidgardRsourcesListUrl(){var t;const i=(t=n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.midgLang)!==null&&t!==void 0?t:n.Host.getLanguage(),r=n.config.msbMidgardResourcesListUrl;return r.replace("{sysLang}",i)}appendHash(n,t){return`${n}#${t}`}async buildBfbSearchUrlAsync(n){var t;const{url:i}=(t=await this.buildWorkSearchUrlAsync(n))!==null&&t!==void 0?t:{url:""};return i}async buildWorkSearchUrlAsync(t){const{query:o,intent:r,entityId:s,formCode:a,verticalHash:h}=t;if(!n.config||!o||!r)return null;const v=encodeURIComponent(o);let u="",c="";if(r!="Person"){const n={triggeringMode:"Explicit",intent:r};s&&(n.entityId=s);u=JSON.stringify(n);c=encodeURIComponent(u)}let i=n.formatString(n.config.bfbSearchUrl||"",[v,c,a]);i=await this.addMsbUserInfoParameterToUrlAsync(i);const l=_G.IG||n.cleanGuid(n.Host.createGuid());i=this.insertParameter(i,`cvid=${encodeURIComponent(l)}`);let f=undefined;n.config.msbEnableProactiveSearchTransfers&&(f=n.cleanGuid(n.Host.createGuid()),i=this.insertParameter(i,`ssat=${encodeURIComponent(f)}`));let e=undefined;return n.config.msbEnableProactiveSearchTransfers&&(e=n.cleanGuid(n.Host.createGuid()),i=this.insertParameter(i,`lgid=${encodeURIComponent(e)}`)),i=this.addMsbCodeParameterToUrl(i),i=this.addTransferIgToUrl(i),h&&(i=this.appendHash(i,h)),{url:i,urlParams:{cvid:l,msbd:u,ssat:f,lgid:e}}}async buildMsbWorkSearchUrlAsync(t,i,r){let u=n.formatString(t.bfbSearchUrl||"",[i,"",r]);return u=await this.addMsbUserInfoParameterToUrlAsync(u),this.addConversationIdToUrl(u)}mapGccRegionToMsbApiEnv(n){return n==1?"prod_gcc":n==2?"prod_gcch":undefined}addMsbCodeParameterToUrl(t){if(n.config.msbEnableProactiveSearchTransfers)t=this.insertParameter(t,`msb=${"bfbwsbpsttf"}`);return t}async addMsbUserInfoParameterToUrlAsync(t){if(!t||typeof crypto!="object")return _w.bfbWsbTel&&bfbWsbTel.logError("Wsb add user info to URL error",`No "window.crypto" object`),t;const i=n.msbHost.getAadUserInfo();if(!(i===null||i===void 0?void 0:i.tenantId)||!(i===null||i===void 0?void 0:i.userAadId))return _w.bfbWsbTel&&bfbWsbTel.logError("Wsb add user info to URL error",`No user info.`),t;const u=this.getSecureSalt();if(!u)return t;try{const r=`${i===null||i===void 0?void 0:i.userAadId.toLowerCase()}@${i===null||i===void 0?void 0:i.tenantId.toLowerCase()}@${u.toLowerCase()}`,f=Uint8Array.from(r.split("").map(n=>n.charCodeAt(0))),e=await crypto.subtle.digest("SHA-256",f),o=new Uint8Array(e);let n="";for(const t of o)n+=t.toString(16).padStart(2,"0");const s=`olu=${n}&olus=${u}`;return this.insertParameter(t,s)}catch(r){return _w.bfbWsbTel&&bfbWsbTel.logError("Wsb add user info to URL error",`Exception: ${(r===null||r===void 0?void 0:r.message)||JSON.stringify(r)}`),t}}async launchUriAsync(t){return await n.Host.launchUriAsync(t)}addConversationIdToUrl(n){if(!n)return n;const t=(_G===null||_G===void 0?void 0:_G.IG)?`cvid=${encodeURIComponent(_G.IG)}`:undefined;return t?this.insertParameter(n,t):n}getSecureSalt(){try{const n=new Uint8Array(16);return _w.crypto.getRandomValues(n),Array.from(n).map(n=>n.toString(16).padStart(2,"0")).join("")}catch(n){return _w.bfbWsbTel&&bfbWsbTel.logError("Wsb add user info to URL error",`Generate salt throws: ${(n===null||n===void 0?void 0:n.message)||JSON.stringify(n)}`),""}}addTransferIgToUrl(n){return n?this.insertParameter(n,`ig=${encodeURIComponent(this.transferIg)}`):n}getTransferIg(){return this.transferIg}insertParameter(n,t){if(!n||!t)return n;const i=n.indexOf("#");if(i<0)return this.appendParameter(n,t);else{const r=n.substring(0,i),u=n.substring(i);return`${this.appendParameter(r,t)}${u}`}}appendParameter(n,t){const i=n.indexOf("?"),r=i<0?"?":"&";return`${n}${r}${t}`}getUrlBaseInfo(n){var t;if((t=n===null||n===void 0?void 0:n.match(/[^?#]*/))!==null&&t!==void 0)return t[0]}}n.MsbUrlUtils=t}(WSB||(WSB={})),function(n){class t{getFluentIcon(n){switch(n){case"microsoft365Icon":return this.getMicrosoft365Icon();case"outlookIcon":return this.getOutlookIcon();case"teamsIcon":return this.getTeamsIcon();case"webSearchDarkIcon":return this.getWebSearchDarkIcon();case"webSearchLightIcon":return this.getWebSearchLightIcon();case"atIcon":return this.getAtIcon();case"atCommentIcon":return this.getAtCommentIcon();case"bookmarkIcon":return this.getBookmarkIcon();case"commentIcon":return this.getCommentIcon();case"editIcon":return this.getEditIcon();case"openFolderIcon":return this.getOpenFolderIcon();case"postIcon":return this.getPostIcon();case"recordingIcon":return this.getRecordingIcon();case"trendingIcon":return this.getTrendingIcon();case"peopleIcon":return this.getPeopleIcon();case"viewedIcon":return this.getViewedIcon();case"calendarIcon":return this.getCalendarIcon();case"linkIcon":return this.getLinkIcon();case"checkIcon":return this.getCheckIcon();case"infoIcon":return this.getInfoIcon();case"infoIconHover":return this.getInfoIconHoverIcon();case"cancelIcon":return this.getCancelIcon();case"searchIcon":return this.getSearchIcon();case"orgIcon":return this.getOrgIcon();case"personIcon":return this.getPersonIcon();case"folderIcon":return this.getFolderIcon();case"historyIcon":return this.getHistoryIcon();case"newsIcon":return this.getNewsIcon();case"arrowTrendingIcon":return this.getArrowTrendingIcon();case"backpackIcon":return this.getBackpackIcon();case"caretRight":return this.getCaretRightIcon();case"caretLeft":return this.getCaretLeftIcon();case"acronymsIcon":return this.getAcronymsIcon();case"listBceIcon":return this.getListBceIcon();case"chatBceIcon":return this.getChatBceIcon();case"editBceIcon":return this.getEditBceIcon();case"composeBcbIcon":return this.getComposeBcbIcon();case"dataUsageBcbIcon":return this.getDataUsageBcbIcon();case"scalesBcbIcon":return this.getScalesBcbIcon();case"shieldIcon":return this.getShieldIcon();case"previewIcon":return this.getPreviewIcon();case"colorfulBookmarkIcon":return this.getColorfulBookmarkIcon();case"workIcon":return this.getWorkIcon();case"msbQnaIcon":return this.getMsbQnaIcon();case"acronymIcon":return this.getAcronymIcon();default:return undefined}}getMicrosoft365Icon(){return{type:0,content:n.getImageUrl("ODSWG.127c5f77-db04-46d6-88ee-c15fdb5ac572")}}getOutlookIcon(){return{type:0,content:n.getImageUrl("ODSWG.b4161fae-7206-40b0-b5a3-3c6b97cdb7c0")}}getTeamsIcon(){return{type:0,content:n.getImageUrl("ODSWG.da4d429b-20bd-4875-8d22-fffa7025c146")}}getWebSearchDarkIcon(){return{type:0,content:n.getImageUrl("ODSWG.b75f295a-545d-4d58-ada8-0b1442214b58")}}getWebSearchLightIcon(){return{type:0,content:n.getImageUrl("ODSWG.1888f892-680f-41e2-85ed-7b60767e32ba")}}getAtIcon(){return{type:0,content:n.getImageUrl("ODSWG.a1fde47c-a964-4b19-a2de-6bc5ba7b1e96")}}getAtCommentIcon(){return{type:0,content:n.getImageUrl("ODSWG.98562bb6-d611-4890-b537-57e43497a0bc")}}getBookmarkIcon(){return{type:0,content:n.getImageUrl("ODSWG.357f24c9-153e-4dc1-8778-b92337fda1fc")}}getCommentIcon(){return{type:0,content:n.getImageUrl("ODSWG.411739d3-beb5-4b2b-a781-60213fa4cf87")}}getEditIcon(){return{type:0,content:n.getImageUrl("ODSWG.69b339e9-45f3-4eca-b294-d3e78aea2152")}}getOpenFolderIcon(){return{type:0,content:n.getImageUrl("ODSWG.b9d01896-15cd-4010-ab7d-d4a97704f5be")}}getPostIcon(){return{type:0,content:n.getImageUrl("ODSWG.9f33a1e6-eaf4-4749-b4d5-1c6ce0dfa797")}}getRecordingIcon(){return{type:0,content:n.getImageUrl("ODSWG.9f068dfe-4e4c-43c5-b92a-69e80cd8ac44")}}getTrendingIcon(){return{type:0,content:n.getImageUrl("ODSWG.b30c50c8-bfbd-4b5b-9500-8153da0c9b62")}}getPeopleIcon(){return{type:0,content:n.getImageUrl("ODSWG.5b08e224-7dd5-4df7-8bf9-33ec5171f0a9")}}getViewedIcon(){return{type:0,content:n.getImageUrl("ODSWG.7322d533-2e2b-4dec-a485-c66e432e3898")}}getCalendarIcon(){return{type:0,content:n.getImageUrl("ODSWG.3a519ee0-7799-450e-947c-49673f688461")}}getLinkIcon(){return{type:0,content:n.getImageUrl("ODSWG.fc0de4ec-705c-4f99-bc74-c683d6795c8f")}}getCheckIcon(){return{type:0,content:n.getImageUrl("ODSWG.c143d02f-c1f1-4775-93ec-885ab80c98c3")}}getInfoIcon(){return{type:0,content:n.getImageUrl("ODSWG.d1896b17-077e-4e0e-a0e5-a2f03f0e894a")}}getInfoIconHoverIcon(){return{type:0,content:n.getImageUrl("ODSWG.3f565229-5700-450d-8986-ec28675835b9")}}getCancelIcon(){return{type:0,content:n.getImageUrl("ODSWG.5d6f842f-006f-4c89-afc3-6a4417ab74de")}}getSearchIcon(){return{type:0,content:n.getImageUrl("ODSWG.f1b4a79e-ac18-4faa-aef9-ee96b5542fe1")}}getOrgIcon(){return{type:0,content:n.getImageUrl("ODSWG.33803b19-f174-4bd0-9573-be3dd21178df")}}getPersonIcon(){return{type:0,content:n.getImageUrl("ODSWG.49df98b5-400a-49b7-9d2a-3507005d9262")}}getFolderIcon(){return{type:0,content:n.getImageUrl("ODSWG.a5c7eb0a-890d-4847-9661-67c7e2e67387")}}getHistoryIcon(){return{type:0,content:n.getImageUrl("ODSWG.7db9948d-3ad6-4d40-8cb3-ae54b2cb00d7")}}getNewsIcon(){return{type:0,content:n.getImageUrl("ODSWG.f41dd3b1-c1b7-4d73-9122-488e4ac7fb82")}}getArrowTrendingIcon(){return{type:0,content:n.getImageUrl("ODSWG.2104b23b-a66c-4c36-99c6-27c375b4ed4e")}}getBackpackIcon(){return{type:0,content:n.getImageUrl("ODSWG.cdd81c7c-1ff0-4671-91cd-dbba44092548")}}getCaretRightIcon(){return{type:0,content:n.getImageUrl("ODSWG.7925a41d-eecf-4db2-9ec5-ac78ec395f03")}}getCaretLeftIcon(){return{type:0,content:n.getImageUrl("ODSWG.f36ba2b4-7e6a-4d2b-b6a9-914452f0c468")}}getAcronymsIcon(){return{type:0,content:n.getImageUrl("ODSWG.efba8ddd-de08-4ce7-94d8-01e0988d6896")}}getListBceIcon(){return{type:0,content:n.getImageUrl("ODSWG.a81f658a-ca12-43ef-85f8-d96428e48ab2")}}getChatBceIcon(){return{type:0,content:n.getImageUrl("ODSWG.35385236-9396-4c15-ae84-89f709dd0828")}}getEditBceIcon(){return{type:0,content:n.getImageUrl("ODSWG.e91947a4-e474-457f-baa7-ff2f6f5fe949")}}getComposeBcbIcon(){return{type:0,content:n.getImageUrl("ODSWG.e88a8266-e907-409c-8966-df2d6cbf412e")}}getDataUsageBcbIcon(){return{type:0,content:n.getImageUrl("ODSWG.0a7ad212-3e00-41c3-b840-47ad11c6ed91")}}getScalesBcbIcon(){return{type:0,content:n.getImageUrl("ODSWG.0cf6145f-728f-4026-9395-7678d5b0bdbe")}}getShieldIcon(){return{type:0,content:n.getImageUrl("ODSWG.5a7584f7-379d-49e6-84fe-0a5a9e450ae4")}}getPreviewIcon(){return{type:0,content:n.getImageUrl("ODSWG.2a51392d-1594-4dec-9d33-241cca4651be")}}getColorfulBookmarkIcon(){return{type:0,content:n.getImageUrl("ODSWG.00573644-4332-488d-ab0f-98c0e4d28d5a")}}getWorkIcon(){return{type:0,content:n.getImageUrl("ODSWG.a12ef35a-10f6-4fcf-810e-58495f6f13e1")}}getMsbQnaIcon(){return{type:0,content:n.getImageUrl("ODSWG.cae3d039-2287-471d-b89e-c27d0909c6c9")}}getAcronymIcon(){return{type:0,className:"msb-acronymIcon",content:n.getImageUrl("ODSWG.b4789ea5-21f1-4bb6-bf32-cf8bdd3103fa")}}}n.MsbIconUtils=t}(WSB||(WSB={})),function(n){const t="X-Client-Language",i="X-Client-LocalTime",r="Client-Request-Id",u="User-Agent",f="6ba82e35-cb33-52a3-710a-75b1290faba1.1000.01",e="https://substrate.office.com/search/api/v1/events?scenario=",o="SearchEntityActions";class s{logSearchEntityActions(s,h){var a,v,y,p,w,b;const k=e+s,c=n.msbHost.getAadUserInfo(),g=[{Key:(a=window===null||window===void 0?void 0:window._G)===null||a===void 0?void 0:a.IG,Value:[{Name:o,Attributes:[{Key:"Id",Value:f},{Key:"LocalTime",Value:n.getDateWithTimezone()},{Key:"EventType",Value:"EntityClicked"},{Key:"UserId",Value:(v=c===null||c===void 0?void 0:c.userAadId)!==null&&v!==void 0?v:""},{Key:"TenantId",Value:(y=c===null||c===void 0?void 0:c.tenantId)!==null&&y!==void 0?y:""},{Key:"TraceId",Value:(p=window===null||window===void 0?void 0:window._G)===null||p===void 0?void 0:p.IG},{Key:"LogicalId",Value:h?h:(w=window===null||window===void 0?void 0:window._G)===null||w===void 0?void 0:w.IG},{Key:"Version",Value:"2"}]}]}],d=JSON.stringify(g),l={};if(l[r]=(b=window===null||window===void 0?void 0:window._G)===null||b===void 0?void 0:b.IG,l[t]=n.uiLanguageCache,l[i]=n.getDateWithTimezone(),l[u]=n.getUserAgent(),n.config.msbEnableAccountManager)this.postRequestAsync(k,l,d).catch(t=>{});else{const t={url:k,requestType:"POST",headers:l,body:d,useToken:"WSB3S"};n.msbHost.tokenManager.refresh3sTokenAndCall(()=>{n.Msb.sendAjax(t)})}}async postRequestAsync(t,i,r){const{token:u}=await n.msbHost.accountManager.refresh3STokenAsync(),f={method:"POST",url:t,token:u,headers:i,body:r};await n.msbHost.httpWrapper.sendHttpAsync(f)}}n.MsbSubstrateLogger=s}(WSB||(WSB={})),function(n){const r="AadUserId",u="WsbVerifyAccountRequired",t="AadChatEligibility",f=3e5,e=6e4,o=6e4,s=50;class i{constructor(n){this.codeLocation=n}}n.MsbNoMsbTokenError=i;class h{constructor(t){this.accessTokenManager=t;this.tokenChanged=!1;this.tokenChangedHandlers=[];this.aadNotAvailableHandlers=[];this.wsbAadReadyNotified=!1;this.accountTypeChangedIsFiring=!1;n.Host.bindAccountChanged(()=>{n.Host.clearWorkQuery(),this.clearMemoryCachedInfo()});t.bindAccountTypesChanged(()=>{this.handleAccountTypeChanged()});t.bindVerifyAccountRequired((n,t)=>{this.handleWsbVerifyAccountRequired(n,t)});t.bindAccessTokenAvailable((n,t)=>{this.handleWsbAccessTokenAvailable(n,t)});t.bindSelectedAccountChanged(()=>{this.handleWsbSelectedAccountChanged()});n.config.msbLoadQfScriptEarly&&n.safeSetTimeout(()=>{n.msbHost.shouldForceEnterprise()&&_w.postMessage({messageType:"BingAtWork:WsbQfScriptLoad"},"*")},s,"MsbTokenManager Constructor");n.config.msbEnableChat&&this.loadChatEligibilityCache()}bindMsbAccountAvailableTenantSettingHandler(n){this.msbAccountAvailableTenantSettingHandler=n}bindAadNotAvailable(n){this.aadNotAvailableHandlers.push(n)}clearMemoryCachedInfo(){this.lokiAccount=undefined}bindTokenChanged(n){this.tokenChangedHandlers.push(n);const t=this.getMsbToken();t&&n(t)}refreshMsbTokenAndCall(t,i,r,u){r=r&&[...r,`MsbTokenManager::refreshMsbTokenAndCall`];let f;n.msbPerfLogger&&(typeof this.lastPerfMarkCallId=="undefined"&&(this.lastPerfMarkCallId=0),f=this.lastPerfMarkCallId++);const e=this.getMsbToken("refreshMsbTokenAndCall:1");if(!e||(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbAlwaysAuthBaw)){const e=n.getCurrentTime();this.callGetMsbAccount(!0,()=>{const r=this.getMsbToken("refreshMsbTokenAndCall:2"),u=n.getCurrentTime(),f=!r;n.msbHost.features.isAuthLogEnabled()&&u-e>100&&_w.bfbWsbTel&&bfbWsbTel.logError("Wsb long token refresh delay",`Token error: ${f}`,undefined,{durationInMs:u-e});r?n.safeExecute(()=>t(r),"MsbTokenManager::refreshMsbTokenAndCall:callback - fetched token"):i&&n.safeExecute(i,"MsbTokenManager::refreshMsbTokenAndCall:noTokenCallback")},`${u}:refreshMsbTokenAndCall`,r,f)}else n.safeExecute(()=>t(e),"MsbTokenManager::refreshMsbTokenAndCall:callback - cached token")}async refreshMsbTokenAsync(){const t="MsbTokenManager::refreshMsbTokenAsync";return new Promise((r,u)=>{this.refreshMsbTokenAndCall(n=>{var t,i;const u=(t=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||t===void 0?void 0:t.wsbAccessTokenJwtExp,f=(i=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||i===void 0?void 0:i.wsbAccessTokenRefreshTime;return r({token:n,tokenJwtExp:u,tokenRefreshTime:f})},()=>u(new i(t)),(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?[t]:undefined,t)})}refresh3sTokenAndCall(t,i,r){r=r&&[...r,`MsbTokenManager::refresh3sTokenAndCall`];const u=this.get3sToken();u?n.safeExecute(()=>t(u),"MsbTokenManager::refresh3sTokenAndCall:callback - cached token"):this.refreshMsbTokenAndCall(()=>{this.callFetch3sAccount(()=>{this.after3sAccountRefreshed(t,i)})},()=>{i&&n.safeExecute(()=>i(),"MsbTokenManager::refresh3sTokenAndCall:noTokenCallback")},r,"Refresh3sTokenAndCall")}isAadAvailable(){return this.accessTokenManager.isAadAvailable()}getSelectedAccountId(){return this.accessTokenManager.getSelectedAccountId()}after3sAccountRefreshed(t,i){const r=this.get3sToken();r?n.safeExecute(()=>t(r),"MsbTokenManager::refresh3sTokenAndCall:callback - fetched token"):i&&n.safeExecute(i,"MsbTokenManager::refresh3sTokenAndCall:noTokenCallback")}getMsbToken(t){if(!this.msbAccount)return undefined;const i=n.getCurrentTime(),r=i>this.msbAccount.ExpireDateTime;if((n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbAuthFailed)||r){if(BingAtWork.wsb&&(BingAtWork.wsb.wsbAccessToken=undefined,BingAtWork.wsb.wsbAccessTokenWamExp=undefined,BingAtWork.wsb.wsbAccessTokenJwtExp=undefined),n.isMsftAccountConnected&&r&&t){const n=`Token expired by ${(i-this.msbAccount.ExpireDateTime)/e} mins and caller: ${t}`;bfbWsbTel===null||bfbWsbTel===void 0?void 0:bfbWsbTel.logError("MsbTokenExpired",n)}return this.msbAccount=undefined,undefined}return this.msbAccount.Token}get3sToken(){if(!this.substrateAccount)return undefined;const t=n.getCurrentTime();return t>this.substrateAccount.ExpireDateTime?(this.substrateAccount=undefined,BingAtWork.wsb&&(BingAtWork.wsb.wsb3sAccessToken=undefined),undefined):this.substrateAccount.Token}getMsbAccountRoutingHint(){var n;if((n=this.msbAccount)!==null&&n!==void 0)return n.RoutingHint}getLokiToken(){if(!this.lokiAccount)return undefined;const t=n.getCurrentTime();return t>this.lokiAccount.ExpireDateTime?(this.lokiAccount=undefined,(BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)&&(BingAtWork.wsb.wsbLokiAccessToken=undefined),undefined):this.lokiAccount.Token}refreshLokiTokenAndCall(t,i,r){const u=this.getLokiToken();if(u)n.safeExecute(()=>t(),`MsbTokenManager::refreshLokiTokenAndCall:${r} - cached token`);else{const r=this.getMsbToken("refreshLokiTokenAndCall");r?this.callFetchLokiAccount(()=>{this.afterLokiAccountRefreshed(t,i)}):i&&n.safeExecute(()=>i("RefreshMsbTokenAndCall:No Msb Token"),"MsbTokenManager::refreshLokiTokenAndCall:noTokenCallback")}}afterLokiAccountRefreshed(t,i){const r=this.getLokiToken();r?n.safeExecute(()=>t(),"MsbTokenManager::refreshLokiTokenAndCall:callback - fetched token"):i&&n.safeExecute(()=>{i("AfterLokiAccountRefreshed: No Loki token")},"MsbTokenManager::refreshLokiTokenAndCall:noTokenCallback")}handleLokiAccount(n){(n===null||n===void 0?void 0:n.Token)&&this.setLokiAccount(n)}fetchMsbLokiAccount(t,i){var r;const u=this.getMsbToken("fetchMsbLokiAccount");u||(_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch Loki Token No Msb Token"),i());const f={clientContext:{clientType:n.msbHost.getClientType(n.Scope.Work)}},e=n.msbHost.urlUtils.getMsbUrl("v3/user/token/Loki"),s=`${e}?cvid=${(r=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.context)===null||r===void 0?void 0:r.conversationId}`,h={url:s,requestType:"POST",body:JSON.stringify(f),checkServerTime:!0,onSuccess:r=>{const u=this.makeAccountInfo(r,o);if(u)t(u);else{const t=`[MSB.Error] fetching loki token returns no token. response=${JSON.stringify(r)}`,u=n.msbHost.isMsbInternalTenant()?t:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch Loki Token Returns Invalid Response","",{additionalMessage:u});i()}},onError:(t,r)=>{if(t!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){const{responseText:f,message:e,stackTrace:i,serverTraceId:u,requestSentTime:o,responseReceivedTime:s,isBrowserOnline:h,hResultString:c}=r,l=`[MSB.Error] fetching loki token has error, details=${JSON.stringify({statusCode:t,responseText:f,message:e,stackTrace:i,serverTraceId:u})}`,a=n.msbHost.isMsbInternalTenant()?l:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Loki Token Failed","",{stackTrace:i,serverTraceId:u,additionalMessage:a,statusCode:t},{Online:h,HResult:c,ReqTS:o,ResTS:s})}i()}};n.Msb.sendAjax(h)}setLokiAccount(n){this.lokiAccount=n;(BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)&&(BingAtWork.wsb.wsbLokiAccessToken=n.Token)}callFetchLokiAccount(t){this.fetchMsbLokiAccount(i=>{n.safeExecute(()=>{this.handleLokiAccount(i),t()},"Calling handleLokiAccount")},()=>{n.safeExecute(()=>{t()},"Calling handleMsbAccount with null loki account")})}getTokenExpiry(t,i){var u;const r=n.parseJwt((u=this.msbAccount)===null||u===void 0?void 0:u.Token);if(r===null||r===void 0?void 0:r.exp){const t=n.config.msbTokenExpirySafetyShiftInMins*6e4;return(r===null||r===void 0?void 0:r.exp)*1e3-t}return i}notifyWsbAadReady(){this.wsbAadReadyNotified||!n.msbHost.isTenantMsbEnabled()||n.msbHost.isGccHighTenant()||(this.wsbAadReadyNotified=!0,BingAtWork.wsb&&(BingAtWork.wsb.isBackgroundRefreshEnabledInInit=n.isDynamicSearchContentPossible()),n.msbHost.resetLanguageCookie(),_w.postMessage({messageType:"BingAtWork:WsbAadReady",userId:this.userId,tenantId:this.tenantId},"*"),n.msbHost.qfUtils.setWsbAadReadyNotified())}callGetMsbAccount(t,i,r,u,f){if(u=u&&[...u,`MsbTokenManager::callGetMsbAccount(caller=${r})`],!this.accessTokenManager.isAadAvailable()&&!n.config.msbMockToken){n.msbHost.tenantManager.setTenantMsbDisabledStatus();this.clearUserTenantContext();this.aadNotAvailableHandlers.forEach(t=>{sb_st(()=>n.safeExecute(()=>t(),"MsbTokenManager::fireAadNotAvailable"),1)});i===null||i===void 0?void 0:i(!1);return}n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.MsbTokenRequested,f);this.accessTokenManager.getAccount(1,n.config.msbDsbUseLocal?"ef47e344-4bff-4e28-87da-6551a21ffbe0":"9ea1ad79-fdb6-4f9a-8bc3-2b70f96e34c7",t,!0,t=>{let e=t;n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.MsbTokenResponded,f);n.config.msbMockToken&&(e=this.getMsbMockAccount());(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbAuthFailed)&&(e=undefined);n.safeExecute(()=>{this.handleMsbAccount(e,i,r,u)},"Calling handleMsbAccount")},undefined,u)}callFetch3sAccount(t){this.fetchMsb3sAccount(i=>{n.safeExecute(()=>{this.handleSubstrateAccount(i),t===null||t===void 0?void 0:t()},"Calling handleSubstrateAccount")},()=>{n.safeExecute(()=>{this.handleSubstrateAccount(undefined),t===null||t===void 0?void 0:t()},"Calling handleMsbAccount with null 3s account")})}handleMsbAccount(t,i,u,f){f=f&&[...f,"MsbTokenManager::handleMsbAccount"];const o=t===null||t===void 0?void 0:t.Token;const e=this.createAadUserInfo(t);if(this.setAadUserInfo(e),this.updateTelemetryContext(e),(e===null||e===void 0?void 0:e.userAadId)&&(t===null||t===void 0?void 0:t.RoutingHint)&&this.trySendValueEvents(r,t.RoutingHint,{name:"LogAadUserId",value:u}),o){this.setMsbAccount(t);const f=this.tokenChanged,r=()=>{this.handleMsbTokenChanged(),i===null||i===void 0?void 0:i(f)},e=()=>{r()},o=n=>{(n===null||n===void 0?void 0:n.hasTokenIssue)&&(this.msbAccount=undefined,BingAtWork.wsb&&(BingAtWork.wsb.wsbAccessToken=undefined,BingAtWork.wsb.wsbAccessTokenWamExp=undefined,BingAtWork.wsb.wsbAccessTokenJwtExp=undefined)),r()};this.msbAccountAvailableTenantSettingHandler?n.safeExecute(()=>this.msbAccountAvailableTenantSettingHandler(e,o,u,this.msbAccount),"MsbTokenManager::msbAccountAvailableTenantSettingHandler"):r()}else n.logAuthRelatedInfo("getAccountOnFailure",`authenticate failed ${f===null||f===void 0?void 0:f.join(" -> ")}`),this.setMsbAccount(undefined),n.msbHost.tenantManager.setTenantMsbDisabledStatus(),i===null||i===void 0?void 0:i(!1)}handleSubstrateAccount(t,i){i=i&&[...i,"MsbTokenManager::handleSubstrateAccount"];const r=t===null||t===void 0?void 0:t.Token;r?this.setSubstrateAccount(t):n.logAuthRelatedInfo("getAccountOnFailure",`authenticate failed ${i===null||i===void 0?void 0:i.join(" -> ")}`)}fetchMsb3sAccount(t,i){const u=this.getMsbToken("fetchMsb3sAccount");u||(_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch 3S Token No Msb Token"),i());const e=n.msbHost.urlUtils.getMsbUrl("v3/user/token/Substrate"),r=BingAtWork.context.conversationId,o=`${e}?cvid=${r}`,s={url:o,checkServerTime:!0,onSuccess:u=>{const e=this.makeAccountInfo(u,f);if(e)t(e);else{const t=`[MSB.Error] fetching 3S token returns no token. response=${JSON.stringify(u)}`;const f=n.msbHost.isMsbInternalTenant()?t:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch 3S Token Returns Invalid Response","",{additionalMessage:f,cvid:r});i()}},onError:(t,u)=>{if(t!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){const{responseText:s,message:i,stackTrace:f,serverTraceId:e,requestSentTime:h,responseReceivedTime:c,isBrowserOnline:l,hResultString:a}=u,o=`[MSB.Error] fetching 3S token has error, details=${JSON.stringify({statusCode:t,responseText:s,message:i,stackTrace:f,serverTraceId:e})}`;const v=n.msbHost.isMsbInternalTenant()?o:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch 3S Token Failed",i,{stackTrace:f,serverTraceId:e,additionalMessage:v,statusCode:t,cvid:r},{Online:l,HResult:a,ReqTS:h,ResTS:c})}i()}};n.Msb.sendAjax(s)}makeAccountInfo(t,i){if(!t||!t.token||!t.tokenExpiry||!t.tenant||!t.tenant.id||!t.user||!t.user.id||!t.user.displayName)return undefined;const{token:f,tokenExpiry:e,tenant:{id:r},user:{id:u,displayName:o}}=t;return{Token:f,ExpireDateTime:e-i,UserName:o,RoutingHint:`OID:${r}:${u}`,LastUpdated:n.getCurrentDate().getTime(),TenantId:r,UserObjectId:u}}setMsbAccount(t){var r,u,f;const e=(r=this.msbAccount)===null||r===void 0?void 0:r.Token,i=t===null||t===void 0?void 0:t.Token;if(this.msbAccount=t,!!i&&e!=i){if(this.tokenChanged=!0,BingAtWork.wsb){BingAtWork.wsb.wsbAccessToken=i;const e=t.ExpireDateTime;BingAtWork.wsb.wsbAccessTokenWamExp=e;const o=n.parseJwt(i),r=Number(o===null||o===void 0?void 0:o.exp)*1e3;if(!r){const t=`typeof(parsedToken)=${typeof o}, typeof(jwtExp)=${typeof r}`,i=n.msbHost.isMsbInternalTenant()?`account=${JSON.stringify(this.msbAccount)}`:undefined;bfbWsbTel.logError("Wsb WAM-JWT expiry no value",t,{additionalMessage:i})}BingAtWork.wsb.wsbAccessTokenJwtExp=r;BingAtWork.wsb.wsbAccessTokenRefreshTime=n.getCurrentTime();const s=r-e;s<0&&bfbWsbTel.logError("Wsb WAM-JWT expiry mismatch",`RefreshTime=${BingAtWork.wsb.wsbAccessTokenRefreshTime} WamExp=${e}, JwtExp=${r}`);BingAtWork.wsb.gccRegion=n.getGccRegionFromToken(i);!this.initialMsbApiEnv&&((u=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.context)===null||u===void 0?void 0:u.msbApiEnv)&&(this.initialMsbApiEnv=BingAtWork.context.msbApiEnv);this.initialMsbApiEnv&&(BingAtWork.context.msbApiEnv=(f=n.msbHost.urlUtils.mapGccRegionToMsbApiEnv(BingAtWork.wsb.gccRegion))!==null&&f!==void 0?f:this.initialMsbApiEnv)}if(this.msbAccount){const n=this.getTokenExpiry(i,this.msbAccount.ExpireDateTime);n&&this.msbAccount.ExpireDateTime<n&&(this.msbAccount.ExpireDateTime=n)}}}setSubstrateAccount(n){this.substrateAccount=n;BingAtWork.wsb&&(BingAtWork.wsb.wsb3sAccessToken=n.Token)}getChatFeatureParams(){const t=[];if(n.config.msbForceBizChatEligibilityCheck&&t.push("bfbwsbchatmt"),t.length>0){const n=t.join(",");return`setflight=${n}&features=${n}`}return""}sendMsbProactiveSignIn(t){var r;const u={["Content-Type"]:"text/plain"},f={Authentication:t};let i=n.msbHost.urlUtils.getMsbUrl("v3/user/proactive/signin");const e=n.config.msbProactiveSignInNoCredentials?!1:!0;if(n.config.msbEnableChat){const t=this.getChatFeatureParams(),o=(r=this.msbAccount)===null||r===void 0?void 0:r.RoutingHint;i=t?n.msbHost.urlUtils.insertParameter(i,t):i;n.fetchUrl(i,u,JSON.stringify(f),n=>{if((n===null||n===void 0?void 0:n.status)===200)try{const t=JSON.parse(n.responseText);this.setChatEligibilityCache(t===null||t===void 0?void 0:t.chatEligibilityType,o)}catch(t){}},undefined,undefined,e,undefined,!0)}else n.fetchUrl(i,u,JSON.stringify(f),undefined,undefined,undefined,e,undefined,!0)}setChatEligibilityCache(i,r){r&&i?(this.accountChatEligibility={routingHint:r,eligibility:i},n.LightweightStorage.setItem(t,JSON.stringify(this.accountChatEligibility))):(this.accountChatEligibility=undefined,n.LightweightStorage.removeItem(t))}getChatEligibility(){var n,t,i;return((n=this.accountChatEligibility)===null||n===void 0?void 0:n.routingHint)&&this.accountChatEligibility.routingHint===((t=this.msbAccount)===null||t===void 0?void 0:t.RoutingHint)?(i=this.accountChatEligibility.eligibility)!==null&&i!==void 0?i:"None":"None"}loadChatEligibilityCache(){const i=n.LightweightStorage.getItem(t);if(i)try{this.accountChatEligibility=JSON.parse(i)}catch(r){this.accountChatEligibility=undefined}}handleMsbTokenChanged(){if(this.tokenChanged&&n.msbHost.isTenantMsbEnabled()){this.tokenChanged=!1;const t=this.getMsbToken();t&&(n.msbHost.isGccHighTenant()||this.sendMsbProactiveSignIn(t),this.tokenChangedHandlers&&this.tokenChangedHandlers.forEach(i=>{n.safeExecute(()=>i(t),"MsbTokenManager::fireTokenChanged")}))}}handleWsbAccessTokenAvailable(t){t==1&&(this.accountTypeChangedIsFiring||this.callGetMsbAccount(!1,t=>{var i;this.notifyWsbAadReady();!t||(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.isTest)||(n.Host.refreshCurrentPane(!0),n.config.msbVerticalWorkScopeEnabled&&n.Host.updateScopeList(!0));n.config.msbSkip3sTokenWarmUp||((i=BingAtWork.wsb)===null||i===void 0?void 0:i.gccRegion)==2||this.refresh3sTokenAndCall(()=>undefined,undefined,(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbTokenManager::handleWsbAccessTokenAvailable"]:undefined)},"WsbAccessTokenAvailable",(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbTokenManager::handleWsbAccessTokenAvailable"]:undefined))}handleAccountTypeChanged(){this.accountTypeChangedIsFiring=!0;const t=t=>{this.callGetMsbAccount(!0,()=>{var t;this.notifyWsbAadReady();this.accountTypeChangedIsFiring=!1;n.Host.refreshCurrentPane(!0);n.config.msbVerticalWorkScopeEnabled&&n.Host.updateScopeList(!0);n.config.msbSkip3sTokenWarmUp||((t=BingAtWork.wsb)===null||t===void 0?void 0:t.gccRegion)==2||this.refresh3sTokenAndCall(()=>undefined,undefined,(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbTokenManager::handleAccountTypeChanged"]:undefined)},t,(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbTokenManager::handleAccountTypeChanged"]:undefined)};n.config.msbMockToken?this.getMockToken(()=>{t("AccountTypesChanged_withMockToken")}):t("AccountTypesChanged")}handleWsbSelectedAccountChanged(){this.msbAccount=undefined;this.substrateAccount=undefined;this.lokiAccount=undefined;this.userId=undefined;this.tenantId=undefined}handleWsbVerifyAccountRequired(n,t){let r;switch(n){case 1:r="AAD";break;case 0:r="MSA";break;default:r="Unknown"}if(r!="MSA"){let i;switch(t){case"9ea1ad79-fdb6-4f9a-8bc3-2b70f96e34c7":i="BingAtWork";break;case"https://www.bing.com/cortana":i="Cortana";break;case"https://graph.windows.net/":i="GraphWindowsApi";break;case"394866fc-eedb-4f01-8536-3ff84b16be2a":i="PeopleCard";break;case"https://outlook.office.com/":i="ProfilePictureApi";break;case"https://substrate.office.com":i="SubstrateEnterprise";break;case"service::cortana.bing.com::mbi_ssl":i="Cortana";break;case"LiveProfileCard.Access":i="PeopleCard";break;case"https://outlook.office.com/User.ReadWrite":case"https://outlook.office.com/M365.Access":i="ProfilePictureApi";break;case"https://substrate.office.com/SubstrateSearch-Internal.ReadWrite":case"https://substrate.office.com/M365.Access":i="SubstrateConsumer";break;default:i="Unknown"}const f=`${r}@${i}`;this.trySendValueEvents(u,f,{name:"WsbVerifyAccountRequired",value:"",kv:{authType:r,resourceOrScope:i}})}}setAadUserInfo(n){this.aadUserInfo=n}getAadUserInfo(){return this.aadUserInfo}createAadUserInfo(n){var t,i,r,u;return n?{tenantId:(t=n.TenantId)!==null&&t!==void 0?t:"",tenantName:(i=n.TenantName)!==null&&i!==void 0?i:"",userAadId:(r=n.UserObjectId)!==null&&r!==void 0?r:"",email:n.UserName,userFirstName:(u=n.UserFirstName)!==null&&u!==void 0?u:""}:undefined}updateTelemetryContext(t){var i,r;this.userId=t===null||t===void 0?void 0:t.userAadId;this.tenantId=t===null||t===void 0?void 0:t.tenantId;_w.bfbWsbTel&&bfbWsbTel.setUid((i=this.userId)!==null&&i!==void 0?i:"");_w.bfbWsbTel&&bfbWsbTel.setTenantId((r=this.tenantId)!==null&&r!==void 0?r:"");n.msbHost.tenantManager.checkAndSetIsMsbInternalTenant(this.tenantId)}clearUserTenantContext(){_w.bfbWsbTel&&bfbWsbTel.setUid("");_w.bfbWsbTel&&bfbWsbTel.setTenantId("");n.msbHost.tenantManager.checkAndSetIsMsbInternalTenant(undefined)}isThrottledLogInfoExpired(t,i){const u=n.LightweightStorage.getItem(i),r=this.parseCachedLogInfo(u);if(r==null||r.LogKey!=t)return!0;const f=n.config.msbLogThrottlingTimeInHours*36e5;return n.getCurrentTime()>r.SavedTimestamp+f?!0:!1}parseCachedLogInfo(n){const t=n===null||n===void 0?void 0:n.split(";");return!t||t.length!=2?undefined:{LogKey:t[1],SavedTimestamp:+t[0]}}trySendValueEvents(t,i,r){if(this.isThrottledLogInfoExpired(i,t)){_w.bfbWsbTel&&r&&bfbWsbTel.logValue(r.name,r.value,r.kv);const u=`${n.getCurrentTime()};${i}`;n.LightweightStorage.setItem(t,u)}}getMsbMockAccount(){var t;const i=n.getCurrentTime();return{Token:(t=this.mockToken)!==null&&t!==void 0?t:"",ExpireDateTime:i+36e5,RoutingHint:"OID:65e1aedd-5fe9-4100-8b57-7973687b78c4@72f988bf-86f1-41af-91ab-2d7cd011db47",UserObjectId:"65e1aedd-5fe9-4100-8b57-7973687b78c4",UserName:"msbtest",TenantId:"72f988bf-86f1-41af-91ab-2d7cd011db47",TenantName:"Microsoft",LastUpdated:i}}getMockToken(t){var i;const r=(i=n.config.msbMockTokenUrl)!==null&&i!==void 0?i:"";n.fetchUrl(r,undefined,undefined,n=>{if(n.status===200){try{this.mockToken=JSON.parse(n.responseText)}catch(i){this.mockToken=undefined}t()}else this.mockToken=undefined,t()},undefined,undefined,!0)}}n.MsbTokenManager=h}(WSB||(WSB={})),function(n){const u=["Edu"],f=n=>u.indexOf(n)!==-1,t=1440,i=360,r="MsbTenantSetting",e="000000",o="ffffff";class s{constructor(t){this.fetchingTenant=!1;this.tenantEnabledHandlers=[];this.tenantDisabledHandlers=[];this.tenantMsbStatus=n.TenantMsbStatus.Unknown;this.msbTenantVariants=[];this.isMsbEduTenantEnabled=!1;this.setTenantMsbUnknownStatus();n.config.msbCleanTenantSettingLocalStorage&&this.cleanLocalTenantSettingState();const i=this.getLocalTenantSettingState();this.setLastMsbEnabledTime(i===null||i===void 0?void 0:i.lastMsbEnabledTimestamp);t.bindMsbAccountAvailableTenantSettingHandler((n,t,i,r)=>{this.checkTenantSettings(n,t,i,r)});t.bindAadNotAvailable(()=>{this.cleanLocalTenantSettingState()})}bindTenantEnabled(n){this.tenantEnabledHandlers.push(n)}bindTenantDisabled(n){this.tenantDisabledHandlers.push(n)}shouldForceEnterpriseAccount(){return this.isTenantMsbEnabled()||n.config.msbUseCachedMsbState&&this.isTenantMsbStatusUnknown()&&this.isLastEnabledTimeValid()}hasBeenMsbUser(){return this.isTenantMsbEnabled()||n.config.msbUseCachedMsbState&&this.isLastEnabledTimeValid()}isLastEnabledTimeValid(){if(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.lastAadEnabledTimeValid)return!0;const t=n.getCurrentTime()-n.MsbStateExpiryTimeInMs;return typeof this.lastMsbEnabledTime=="number"&&this.lastMsbEnabledTime>t}setLastMsbEnabledTime(n){this.lastMsbEnabledTime=n}getLastMsbEnabledTime(){return this.lastMsbEnabledTime}getTenantMsbStatus(){return this.tenantMsbStatus}isTenantMsbEnabled(){return this.tenantMsbStatus===n.TenantMsbStatus.Enabled}isTenantMsbDisabled(){return this.tenantMsbStatus===n.TenantMsbStatus.Disabled}isTenantMsbStatusUnknown(){return this.tenantMsbStatus===n.TenantMsbStatus.Unknown}setTenantMsbEnabledStatus(){this.tenantMsbStatus=n.TenantMsbStatus.Enabled}setTenantMsbDisabledStatus(){this.tenantMsbStatus=n.TenantMsbStatus.Disabled;this.setIsMsbEduTenantEnabled(!1)}setTenantMsbUnknownStatus(){this.tenantMsbStatus=n.TenantMsbStatus.Unknown;this.setIsMsbEduTenantEnabled(!1)}getMsbTenantVariants(){return this.msbTenantVariants.join(",")}setMsbTenantVariants(n){this.msbTenantVariants=n}getIsMsbEduTenantEnabled(){return(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbEDUTenant)?this.isTenantMsbEnabled():this.isTenantMsbEnabled()&&this.isMsbEduTenantEnabled}setIsMsbEduTenantEnabled(n){this.isMsbEduTenantEnabled=n}setLocalTenantSettingState(t){const i=JSON.stringify(t);n.LightweightStorage.setItem(r,i)}cleanLocalTenantSettingState(){n.LightweightStorage.removeItem(r)}getLocalTenantSettingState(){const t=n.LightweightStorage.getItem(r);if(t)try{return JSON.parse(t)}catch(i){this.cleanLocalTenantSettingState()}return null}getStoredMsbTenantName(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.tenantDisplayName}getStoredMsbIcon(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.iconLarge}getStoredMsbIconLargeIsDefault(){var n,t;return((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)===null||t===void 0?void 0:t.iconLargeIsDefault)||!1}getStoredMsbIconUrl(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.iconUrl}getStoredMsbNavColor(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.navColor}getStoredMsbFontColor(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.fontColor}getStoredMsbIsEdu(){var n,t;return((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)===null||t===void 0?void 0:t.isEdu)||!1}getStoredMsbTenantVariants(){var n,t;return((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)===null||t===void 0?void 0:t.tenantVariants)||[]}getStoredMsbTenantGroup(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.tenantGroup}checkAndSetIsMsbInternalTenant(t){this.isMsbInternalTenant=n.config.msbInternalTenants&&!!t&&n.contains(n.config.msbInternalTenants,t)}getIsMsbInternalTenant(){var t;return!n.config.disableMsbInternalTenants&&(((t=this.getStoredMsbTenantGroup())===null||t===void 0?void 0:t.toLowerCase())==="msft"||this.isMsbInternalTenant)}getIsLightHouseTenant(){var n;return((n=this.getStoredMsbTenantGroup())===null||n===void 0?void 0:n.toLowerCase())==="lighthouse"}isGccTenant(){var n;return typeof BingAtWork=="undefined"?!1:!!((n=BingAtWork.wsb)===null||n===void 0?void 0:n.gccRegion)}isGccHighTenant(){var n;return typeof BingAtWork=="undefined"?!1:((n=BingAtWork.wsb)===null||n===void 0?void 0:n.gccRegion)===2}isMsbEnterpriseScopeEnabled(){return this.isWorkScopeApplicable(!0)}isWorkScopeZiPageContentEnabled(){return!n.config.msbWorkScopeZiPageContentDisabled&&this.isWorkScopeApplicable(!0)&&!this.isEduTenant(!0)}isWorkMruEnabled(){return this.shouldForceEnterpriseAccount()&&!this.isEduTenant(!0)}isEduMessagesCardEnabled(){return n.config.msbEduMessagesCardEnabled}isEduViewButtonEnabled(){return n.config.msbEduViewButtonEnabled}isWorkScopeApplicable(t){return(n.config.msbVerticalWorkScopeEnabled&&!this.isEduTenant(t)||this.isEduScopeApplicable(t))&&this.shouldForceEnterpriseAccount()&&!this.isGccTenant()}isEduScopeApplicable(t){return this.isEduTenant(t)&&n.config.msbWorkScopeEduEnabled}isEduTenant(n){return n?this.getStoredMsbIsEdu():this.getIsMsbEduTenantEnabled()}isMsbWorkScope(t,i){return this.isWorkScopeApplicable()&&(t===21||i==n.Scope.Work)}isMsbWorkScopeDsbRedirectEnabled(){return this.isWorkScopeApplicable()&&(n.config.msbWorkScopeDsbRedirectEnabled&&this.getIsMsbInternalTenant()||n.config.msbWorkScopeDsbRedirectEnabledWW)}isMsbWorkScopeSHRedirectEnabled(){return this.isWorkScopeApplicable()&&(n.config.msbEnableSearchHomeWSRedirect&&this.getIsMsbInternalTenant()||n.config.msbEnableSearchHomeWSRedirectWW)}isMsbWorkUpsellApplicable(){return(n.config.msbWorkScopeBannerIndicatorEnabledWW||n.config.msbWorkScopeBannerIndicatorEnabled&&this.getIsMsbInternalTenant())&&this.isWorkScopeApplicable()&&(!n.MockUrlParameters||(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.showWorkUpsell))}isWorkScopeListViewEnabled(){return this.isWorkScopeApplicable()&&(n.config.msbWorkScopeListEnabledWW||n.config.msbWorkScopeListEnabled&&this.getIsMsbInternalTenant())}redirectScope(n){switch(n){case"RecommendedPeople":case"ExpandedOrgChart":return this.isMsbWorkScopeDsbRedirectEnabled()?"Work":"People";case"PopularSearchesFeedFallback":return this.isMsbWorkScopeDsbRedirectEnabled()?"Work":"Web";case"People":case"Bookmarks":return this.isMsbWorkScopeSHRedirectEnabled()?"Work":"People";case"MFIL":return"Documents";case"MPPL":case"MGRP":return"People";case"MBKS":return"Web";default:return undefined}}getMsbBrandUri(){var n;try{const t=(n=this.getStoredMsbIcon())!==null&&n!==void 0?n:"";if(t==="")return"";const i=atob(t),r=i.startsWith("<svg")||i.startsWith("<?xml"),u=r?"svg+xml":"jpeg";return`data:image/${u};base64,${t}`}catch(t){return""}}getMsbBranding(){try{const i=this.getMsbBrandUri(),r=this.getStoredMsbIconUrl(),u=this.getStoredMsbIconLargeIsDefault(),f=`#${this.getStoredMsbNavColor()}`,e=`#${this.getStoredMsbFontColor()}`,t=this.getStoredMsbTenantName();return i||t||n.msbHost.isIconUrlEnabled(r)?{logoDataUri:i,iconLargeIsDefault:u,backColor:f,companyName:t!==null&&t!==void 0?t:"",fontColor:e,iconUrl:r}:undefined}catch(t){return undefined}}tenantHasLogo(){const t=this.getMsbBranding(),i=t===null||t===void 0?void 0:t.logoDataUri,r=t===null||t===void 0?void 0:t.iconUrl,u=t===null||t===void 0?void 0:t.iconLargeIsDefault;return!!(i&&!u||n.msbHost.isIconUrlEnabled(r))}checkTenantSettings(t,i,r,u){let f=t,e;n.msbPerfLogger&&(typeof this.lastPerfMarkCallId=="undefined"&&(this.lastPerfMarkCallId=0),e=this.lastPerfMarkCallId++,n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsStarted,e),f=()=>{n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsReturned,e),t()});const o=n.getCurrentTime();this.shouldGetTenantSettings(o,u===null||u===void 0?void 0:u.RoutingHint)?this.checkTenantSettingsFromServer(f,n=>{this.checkTenantSettingsFromCache(f,()=>{(n===null||n===void 0?void 0:n.hasNativeIssue)||_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Tenant Settings Auth Fails and No Cached Results Available"),i(n)},r,u)},r,u,e):this.checkTenantSettingsFromCache(f,()=>{_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Tenant Settings No Cached Results Available"),i({})},r,u)}checkTenantSettingsFromCache(n,t,i,r){const u=this.getLocalTenantSetting();u?(this.updateTenantFlags(u,r,i),n()):(this.cleanLocalTenantSettingState(),t({}))}checkTenantSettingsFromServer(t,i,r,u,s){if(!this.fetchingTenant){this.fetchingTenant=!0;const h=(h,c)=>{var l,a,v,y;if(n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsResponded,s),h===null||h===void 0?void 0:h.tenantSettings){const i={tenantId:h.tenantSettings.tenantObjectId,isEnabled:h.tenantSettings.isEnabled,isEdu:((l=h.tenantSettings.variants)===null||l===void 0?void 0:l.indexOf("Edu"))>=0,tenantVariants:(a=h.tenantSettings.variants)===null||a===void 0?void 0:a.filter(n=>f(n)),tenantDisplayName:h.tenantSettings.tenantDisplayName,iconLarge:h.tenantSettings.iconLargeIsDefault?"":h.tenantSettings.iconLarge,iconLargeIsDefault:h.tenantSettings.iconLargeIsDefault,navColor:((v=h.tenantSettings.themeColors)===null||v===void 0?void 0:v[1])||e,fontColor:((y=h.tenantSettings.themeColors)===null||y===void 0?void 0:y[2])||o,tenantGroup:h.tenantSettings.tenantGroup,iconUrl:h.tenantSettings.iconUrl},s=n.getCurrentTime(),c=h.tenantSettings.isEnabled?s:undefined;this.updateTenantFlags(i,u,r);this.setLastMsbEnabledTime(c);this.updateTenantSettingStateCache(u===null||u===void 0?void 0:u.RoutingHint,200,s,c,i);this.fetchingTenant=!1;t()}else{const n=`Response: ${JSON.stringify(h)}`;const t=this.getIsMsbInternalTenant()?n:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Empty Tenant Settings","",{serverTraceId:c,statusCode:200,additionalMessage:t},{caller:r});this.fetchingTenant=!1;i({})}},c=(f,e)=>{const c=`[MSB.Error] checkTenantSettings: onError: ${JSON.stringify({statusCode:f,ajaxErrorInfo:e})}`;const o=f===404,s=f===401||f===403,l=f===-1,h=n.getCurrentTime();if(o)this.handleMsbDisable(),this.setLastMsbEnabledTime(undefined),this.updateTenantSettingStateCache(u===null||u===void 0?void 0:u.RoutingHint,404,h,undefined,{tenantId:"",isEnabled:!1,tenantDisplayName:"",iconLarge:"",iconLargeIsDefault:!1,navColor:"",fontColor:"",isEdu:!1,tenantVariants:[],tenantGroup:""});else{const n=this.getLocalTenantSettingState();this.updateTenantSettingStateCache(u===null||u===void 0?void 0:u.RoutingHint,f,h,n===null||n===void 0?void 0:n.lastMsbEnabledTimestamp,n===null||n===void 0?void 0:n.tenantSettings)}if(f!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){const i=o?"Wsb Fetch Tenant Settings Non MSB":"Wsb Fetch Tenant Settings Failed",{message:u,errorMessage:h,responseText:c,stackTrace:l,serverTraceId:a,requestSentTime:v,responseReceivedTime:y,isBrowserOnline:p,hResultString:w}=e,t=this.getIsMsbInternalTenant()?`ResponseText: ${c}, ErrorMessages: ${h}`:"",b=s?`${t}, token=${JSON.stringify(n.getReducedTokenInfo(BingAtWork.wsb.wsbAccessToken))}`:t,k=this.getIsMsbInternalTenant()?l:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError(i,u,{stackTrace:k,serverTraceId:a,statusCode:f,additionalMessage:b},{caller:r,Online:p,HResult:w,ReqTS:v,ResTS:y})}this.fetchingTenant=!1;o?t():i({hasTokenIssue:s,hasNativeIssue:l})};n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsRequested,s);n.msbHost.dataAccess.getTenantSetting(h,c)}}updateTenantSettingStateCache(n,t,i,r,u){const f=this.getLocalTenantSettingState(),o=(f===null||f===void 0?void 0:f.failedTimes)||0;let e=o+1;(t===200||t===404||t==-1)&&(e=0);const s=this.getNextIntervalWaitTime(t,e),h={lastMsbEnabledTimestamp:r,lastTimestamp:i,nextRequestIntervalInMinutes:s,failedTimes:e,routingHint:n,tenantSettings:u};this.setLocalTenantSettingState(h)}shouldGetTenantSettings(n,t){const i=this.getLocalTenantSettingState();let r=!0;if(i){const{lastTimestamp:u,nextRequestIntervalInMinutes:f,routingHint:e}=i;t===e&&(r=n>u+f*6e4)}return r}handleMsbDisable(){this.setTenantMsbDisabledStatus();this.tenantDisabledHandlers&&this.tenantDisabledHandlers.forEach(t=>{n.safeExecute(()=>t(),"MsbTenantManager::fireTenantDisabled")})}getLocalTenantSetting(){const n=this.getLocalTenantSettingState();if(n!==null&&n!==void 0)return n.tenantSettings}updateTenantFlags(t,i,r){const{isEnabled:u,isEdu:f,tenantVariants:e}=t;u?(this.setTenantMsbEnabledStatus(),this.setIsMsbEduTenantEnabled(f),this.setMsbTenantVariants(e),this.tenantEnabledHandlers&&this.tenantEnabledHandlers.forEach(t=>{n.safeExecute(()=>t(i===null||i===void 0?void 0:i.RoutingHint,r),"MsbTenantManager::fireTenantEnabled")})):this.handleMsbDisable()}getNextIntervalWaitTime(r,u){let f=0;if(r===200||r===404)f=n.getRandomNumInRange(t,i);else if(u<=n.config.msbTenantSettingRetryNoWaitFailedTimes||r==-1)f=0;else{const e=(u-n.config.msbTenantSettingRetryNoWaitFailedTimes)*n.config.msbTenantSettingRetryInMin;f=r==503||r==429?f+e*3:f+e*4;f>=t+i&&(f=n.getRandomNumInRange(t,i))}return f}}n.MsbTenantManager=s}(WSB||(WSB={})),function(n){const f=21600,e=10080,t=1440,i=360,r="MsbUserConfig",u=1,o=4;class s{constructor(t,i){this.msbTokenManager=t;this.msbTenantManager=i;this.fetchingUserConfig=!1;n.Host.bindAccountChanged(()=>{this.cleanLocalUserConfigState(),this.setHasEduAssignmentsFlags(!1)});i.bindTenantEnabled(()=>{n.msbHost.isEduTenant()&&this.checkUserConfig(()=>{},()=>{},"MsbUserConfigManagerTenantEnabled",t.getMsbAccountRoutingHint())});t.bindTokenChanged(()=>{n.msbHost.isEduTenant()&&this.checkUserConfig(()=>{},()=>{},"MsbUserConfigManagerTokenChanged",t.getMsbAccountRoutingHint())})}setHasEduAssignmentsFlags(n){this.hasEduAssignments=n}getHasEduAssignmentsFlags(){return this.hasEduAssignments}setLicenseNames(n){this.licenseNames=n}isEduLicenseEnabled(t){var i;return!!n.msbHost.isEduTenant()&&((i=this.licenseNames)===null||i===void 0?void 0:i.includes(t))}isEduK12Enabled(){var t;return!!n.msbHost.isEduTenant()&&((t=this.industry)===null||t===void 0?void 0:t.includes("k-12"))}isEduHigherEducationEnabled(){var t;return!!n.msbHost.isEduTenant()&&((t=this.industry)===null||t===void 0?void 0:t.includes("higher education"))}setIndustry(n){this.industry=n}checkUserConfig(t,i,r,u){let e=t,f;n.msbPerfLogger&&(typeof this.lastPerfMarkCallId=="undefined"&&(this.lastPerfMarkCallId=0),f=this.lastPerfMarkCallId++,n.msbPerfLogger.mark(n.MsbPerfProbe.UserConfigStarted,f),e=()=>{n.msbPerfLogger.mark(n.MsbPerfProbe.UserConfigReturned,f),t()});const o=n.getCurrentTime();this.shouldGetUserConfigState(o,u)?this.checkUserConfigFromServer(e,n=>{(n===null||n===void 0?void 0:n.hasNativeIssue)||_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch User Config Auth Fails and No Cached Results Available"),i(n)},r,u,undefined):this.checkUserConfigFromCache(()=>undefined,()=>undefined,r,u)}shouldGetUserConfigState(n,t){const i=this.getLocalUserConfigState();let r=!0;if(i){const{lastTimestamp:u,nextRequestIntervalInMinutes:f,routingHint:e}=i;t===e&&(r=n>u+f*6e4)}return r}checkUserConfigFromCache(n,t){var i;const r=(i=this.getLocalUserConfigState())===null||i===void 0?void 0:i.userConfig;r?this.setHasEduAssignmentsFlags(r.hasAssignments):t({})}getUserConfigsRequest(){return{clientContext:{clientType:"Wsb"},requiredConfigs:["LicenseSettings","EduSettings"]}}checkUserConfigFromServer(t,i,r,u,f){if(!this.fetchingUserConfig){this.fetchingUserConfig=!0;const e=n.msbHost.urlUtils.getMsbUrl("v3/user/data/configs"),o={url:e,body:JSON.stringify(this.getUserConfigsRequest()),requestType:"POST",onSuccess:(e,o)=>{var s,h,c,l;if(n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.UserConfigResponded,f),e===null||e===void 0?void 0:e.user){const i={id:e.user.id,hasAssignments:(s=e.eduSettings)===null||s===void 0?void 0:s.hasAssignments,hasClasses:(h=e.eduSettings)===null||h===void 0?void 0:h.hasClasses,LicenseNames:e.licenseSettings?e.licenseSettings.enabledLicenses:[],industry:((c=e.userStatus)===null||c===void 0?void 0:c.industry)?(l=e.userStatus)===null||l===void 0?void 0:l.industry:""};this.setLicenseNames(i===null||i===void 0?void 0:i.LicenseNames);this.setIndustry(i===null||i===void 0?void 0:i.industry);const r=n.getCurrentTime();this.setHasEduAssignmentsFlags(i===null||i===void 0?void 0:i.hasAssignments);this.updateUserConfigStateCache(u,200,r,r,i);this.fetchingUserConfig=!1;t()}else{const t=`Response: ${JSON.stringify(e)}`;const u=n.msbHost.isMsbInternalTenant()?t:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Empty User Config","",{serverTraceId:o,statusCode:200,additionalMessage:u},{caller:r});this.fetchingUserConfig=!1;i({})}},onError:(f,e)=>{const l=`[MSB.Error] checkUserConfig: onError: ${JSON.stringify({statusCode:f,ajaxErrorInfo:e})}`;const o=f===404,s=f===401||f===403,a=f===-1,h=n.getCurrentTime();if(o)this.updateUserConfigStateCache(u,404,h,undefined,{id:"",hasAssignments:!1,hasClasses:!1});else{const n=this.getLocalUserConfigState();this.updateUserConfigStateCache(u,f,h,n===null||n===void 0?void 0:n.lastMsbEnabledTimestamp,n===null||n===void 0?void 0:n.userConfig)}const v=o?"Wsb Fetch User Config Not found":"Wsb Fetch User Config Failed",{message:y,errorMessage:p,responseText:w,stackTrace:b,serverTraceId:k,requestSentTime:d,responseReceivedTime:g,isBrowserOnline:nt,hResultString:tt}=e,c=n.msbHost.isMsbInternalTenant()?`ResponseText: ${w}, ErrorMessages: ${p}`:"",it=s?`${c}, token=${JSON.stringify(n.getReducedTokenInfo(BingAtWork.wsb.wsbAccessToken))}`:c,rt=n.msbHost.isMsbInternalTenant()?b:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError(v,y,{stackTrace:rt,serverTraceId:k,statusCode:f,additionalMessage:it},{caller:r,Online:nt,HResult:tt,ReqTS:d,ResTS:g});this.fetchingUserConfig=!1;o?t():i({hasTokenIssue:s,hasNativeIssue:a})}};n.Msb.sendAjax(o)}}updateUserConfigStateCache(t,i,u,f,e){var o;const s=this.getLocalUserConfigState(),c=(o=s===null||s===void 0?void 0:s.failedTimes)!==null&&o!==void 0?o:0;let h=c+1;(i===200||i===404||i==-1)&&(h=0);const l=this.getNextIntervalWaitTime(i,h),a={lastMsbEnabledTimestamp:f,lastTimestamp:u,nextRequestIntervalInMinutes:l,failedTimes:h,routingHint:t,userConfig:e};n.LightweightStorage.setItem(r,JSON.stringify(a))}getNextIntervalWaitTime(r,s){let h=0;if(r===200)h=n.getRandomNumInRange(f,e);else if(r===404)h=n.getRandomNumInRange(t,i);else if(s<=u||r==-1)h=0;else{const f=(s-u)*o;h=r==503||r==429?h+f*3:h+f*4;h>=t+i&&(h=n.getRandomNumInRange(t,i))}return h}cleanLocalUserConfigState(){n.LightweightStorage.removeItem(r)}getLocalUserConfigState(){const t=n.LightweightStorage.getItem(r);if(t)try{return JSON.parse(t)}catch(i){this.cleanLocalUserConfigState()}return null}}n.MsbUserConfigManager=s}(WSB||(WSB={})),function(n){var t;(function(t){function h(t,i){var f,e,o,s,h,v;const u=(n,i)=>{if(t.onError!=null)t.onError(n,i)};if(t==null||!t.url){u(n.ClientErrorCode.UrlUnavailable,{message:"MsbAjax.sendAjax: no url available for request, won't send the request."});return}let r;if(t.useToken==="WSB3S"){if(r=(e=(f=_w.BingAtWork)===null||f===void 0?void 0:f.wsb)===null||e===void 0?void 0:e.wsb3sAccessToken,!r){u(n.ClientErrorCode.NoToken,{message:"MsbAjax.sendAjax: no WSB/3S access token, won't send the request."});return}}else if(t.useToken==="WSBLoki"){if(r=(s=(o=_w.BingAtWork)===null||o===void 0?void 0:o.wsb)===null||s===void 0?void 0:s.wsbLokiAccessToken,!r){u(n.ClientErrorCode.NoMsbLokiAccessToken,{message:"MsbAjax.sendAjax: no WSB/Loki access token, won't send the request."});return}}else{if(r=(v=(h=_w.BingAtWork)===null||h===void 0?void 0:h.wsb)===null||v===void 0?void 0:v.wsbAccessToken,!r){u(n.ClientErrorCode.NoToken,{message:"MsbAjax.sendAjax: no WSB access token, won't send the request."});return}const t=c();if(t){u(n.ClientErrorCode.MsbTokenExpiredBeforeRequest,t);return}}t.url[0]==="/"&&(t.url=(_w==null?"":_w.location.origin)+t.url);n.config.msbUseXmlHttpRequest?a(t,r,u,i):l(t,r,u,i)}function c(){var i,r;const t=(i=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||i===void 0?void 0:i.wsbAccessTokenJwtExp;if(t){const i=n.getCurrentTime(),u=t-i;if(u<0){const n=(r=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||r===void 0?void 0:r.wsbAccessTokenRefreshTime,f=i-(n||0);return{message:`${"Wsb token expired before request"} {[MsbAjax].sendAjax}, rt=${n}, jwtExp=${t}, now=${i}`}}}return undefined}function l(t,i,r,e){let h=0;switch(t.requestType){case"POST":h=1;break;case"PUT":h=4}const c=SearchAppWrapper.CortanaApp,a=c.createStringMap(),s=c.createStringMap();n.config.msbSkipUserAgent||(s["User-Agent"]=n.getUserAgent());s.Authorization=`Bearer ${i}`;s.Accept="*/*";a["Content-Type"]="application/json";for(const n in t.headers)s[n]=t.headers[n];const v=performance.now(),l=new Date,o=l.getTime();n.Async.safeChain("makeHttpRequestAsync_MsbAjax_Ajax",()=>c.makeHttpRequestAsync(h,t.url,s,t.body||"",a),i=>{const h=n.getCurrentTime(),{serverTraceId:s,serverTime:c,serverLatency:a}=f(i===null||i===void 0?void 0:i.headers);if(u(t,c,o,s,"MsbAjax::sendCortanaAppHttpRequest"),t.onRoundTripReport){const n=i.statusCode==200?undefined:`HTTP${i.statusCode}`,r=performance.now(),u=new Date,f=i.statusCode;t.onRoundTripReport({startTime:v,endTime:r,startDateTime:l,endDateTime:u,serverLatency:a,errorMessage:n,status:f,traceId:s})}i.statusCode===200?n.Async.safeChain(`msbajax_ReadResponse`,()=>i.readAsStringAsync(),i=>{if(t.onSuccess!=null){let u=null;if(i!=="")try{u=e?i:JSON.parse(i)}catch(f){r(n.ClientErrorCode.ResponseJsonParseError,{message:"Bad data",responseText:i,serverTraceId:s,requestSentTime:o,responseReceivedTime:h});return}t.onSuccess(u,s)}},t=>{r(n.ClientErrorCode.ReadResponseError,{message:"readAsStringAsync_makeHttpRequestAsync_MsbAjax Error",errorMessage:`Name: ${t.name}, message: ${t.message}`,stackTrace:`${t.stack}`,serverTraceId:s,requestSentTime:o,responseReceivedTime:h})},undefined,undefined,0):n.Async.safeChain("readNon200Response",()=>i.readAsStringAsync(),n=>{r(i.statusCode,{message:`Ajax call failed with status ${i.statusCode.toString()}. No retries attempted.`,responseText:n,serverTraceId:s,requestSentTime:o,responseReceivedTime:h})},t=>{r(n.ClientErrorCode.ReadResponseError,{message:"readAsStringAsync_Non200_makeHttpRequestAsync_MsbAjax Error",errorMessage:`Name: ${t.name}, Message: ${t.message}`,stackTrace:`${t.stack}`,serverTraceId:s,requestSentTime:o,responseReceivedTime:h})},undefined,undefined,0)},i=>{if(t.onRoundTripReport){const i=`Promise error makeHttpRequestAsync_MsbAjax Error`,r=performance.now(),u=new Date,f=n.ClientErrorCode.MsbAjaxMakeHttpRequestAsyncError;t.onRoundTripReport({startTime:v,endTime:r,startDateTime:l,endDateTime:u,errorMessage:i,status:f})}const{name:e,message:s,stack:c}=i,u={message:`Promise error makeHttpRequestAsync_MsbAjax Error`,errorMessage:`Name: ${e}, Message: ${s}, RequestType: ${h}, RequestUrl: ${t.url} `,stackTrace:`${c}`,requestSentTime:o,responseReceivedTime:n.getCurrentTime(),isBrowserOnline:navigator.onLine},f=i===null||i===void 0?void 0:i.number;typeof f=="number"&&(u.hResultString=n.formatHResultString(f));r(n.ClientErrorCode.MsbAjaxMakeHttpRequestAsyncError,u)},undefined,undefined,0)}function a(t,i,r,s){const h={};h.Authorization=`Bearer ${i}`;h["Content-Type"]="application/json";for(const n in t.headers)h[n]=t.headers[n];const a=t.body||"",y=performance.now(),l=new Date,c=l.getTime(),w=i=>{var o;const h=n.getCurrentTime(),{serverTraceId:e,serverTime:a,serverLatency:w}=f(i===null||i===void 0?void 0:i.responseHeaders);if(u(t,a,c,e,"MsbAjax::sendXmlHttpRequest"),t.onRoundTripReport){const n=(i===null||i===void 0?void 0:i.status)==200?undefined:`HTTP${i===null||i===void 0?void 0:i.status}-RequestState${i===null||i===void 0?void 0:i.result}`,r=performance.now(),u=new Date,f=i.status;t.onRoundTripReport({startTime:y,endTime:r,startDateTime:l,endDateTime:u,serverLatency:w,errorMessage:n,status:f,traceId:e})}if((i===null||i===void 0?void 0:i.result)==0&&i.status==200){try{const n=s?i.responseText:JSON.parse(i.responseText);v(t);(o=t.onSuccess)===null||o===void 0?void 0:o.call(t,n,e)}catch(k){r(n.ClientErrorCode.ResponseJsonParseError,{message:"[MsbAjax]sendXmlHttpRequest Bad data",responseText:i.responseText,serverTraceId:e,requestSentTime:c,responseReceivedTime:h})}return}const b=(i===null||i===void 0?void 0:i.status)?i.status:p(i.result);r(b,{message:`[MsbAjax]sendXmlHttpRequest Error. ResponseStatus=${i===null||i===void 0?void 0:i.status}, ResultCode=${i.result}`,responseText:i===null||i===void 0?void 0:i.responseText,serverTraceId:e,requestSentTime:c,responseReceivedTime:h})};n.fetchUrl(t.url,h,a,w,undefined,undefined,undefined,o,undefined,t.requestType,e)}function u(t,i,r,u,f){if(n.config.msbServerClientTimeSkewLimitMins&&t.checkServerTime&&i){const e=i-r,o=`[${f}] returned, ServerTime=${i}, ClientTime=${r}, diff=${e}, urlBase=${n.msbHost.urlUtils.getUrlBaseInfo(t.url)}`,h=`Target URL: ${t.url}`;if(Math.abs(e)>n.config.msbServerClientTimeSkewLimitMins*s){const t=n.msbHost.isMsbInternalTenant()?h:undefined;bfbWsbTel.logError("Wsb server and client time mismatch",o,{serverTraceId:u,additionalMessage:t})}}}function v(n){const t=y(n.url);t&&bfbWsbTel.logValue("SuccessRequest",t)}function y(n){return n.indexOf("v2/tenant/my/settings")>-1?"v2/tenant/my/settings":n.indexOf("v3/user/token/Substrate")>-1?"v3/user/token/Substrate":n.indexOf("search/api/v2/query")>-1?"search/api/v2/query":undefined}function p(t){switch(t){case 2:return n.ClientErrorCode.Aborted;case 3:return n.ClientErrorCode.XhrError;case 1:return n.ClientErrorCode.TimedOut;default:return n.ClientErrorCode.XhrCompleted}}function f(t){const u=t===null||t===void 0?void 0:t[i],f=t===null||t===void 0?void 0:t[r];if(u||f)return{serverTraceId:u,serverLatency:f};const e=n.getMsEdgeRef(t),{traceId:o,timestamp:s}=e||{};return{serverTraceId:o,serverTime:s}}const i="request-id",r="x-end2endlatencyms",e=["x-msedge-ref",i,r],o=1e4,s=6e4;t.sendAjax=h})(t=n.Msb||(n.Msb={}))}(WSB||(WSB={})),function(n){class t extends Error{constructor(t,i,r){super(i===null||i===void 0?void 0:i.publicMessage);this.responseContext=t;this.errorMessage=i;this.innerError=r;this.isBrowserOnline=navigator.onLine;const u=r===null||r===void 0?void 0:r.number;t.statusCode===n.ClientErrorCode.MsbAjaxMakeHttpRequestAsyncError&&typeof u=="number"&&(this.hResultString=n.formatHResultString(u))}}n.MsbHttpError=t;const i=6e4,r="request-id",u="x-end2endlatencyms";class f{async sendHttpAsync(t){return this.validateRequest(t),this.validateTokenExpiry(t),n.config.msbDsbUseFetch||t.url.startsWith("http://localhost")?await this.fetchWrapperAsync(t):await this.makeHttpRequestWrapperAsync(t)}validateRequest(i){if(!i.url){const i=`[MsbHttpWrapper].sendHttpAsync failed with no url`;throw new t({statusCode:n.ClientErrorCode.UrlUnavailable},{publicMessage:i});}try{new URL(i.url)}catch(r){const u=`[MsbHttpWrapper].sendHttpAsync failed with ill-formed url`;throw new t({statusCode:n.ClientErrorCode.UrlUnavailable},{publicMessage:u,privateMessage:i.url},r);}if(!(i===null||i===void 0?void 0:i.token)&&!i.skipToken){const i=`[MsbHttpWrapper].sendHttpAsync failed with no token.`;throw new t({statusCode:n.ClientErrorCode.NoToken},{publicMessage:i});}}async makeHttpRequestWrapperAsync(n){const r=this.buildMakeHttpRequestParameters(n),t=await this.callMakeHttpRequestApiAsync(r),{responseContext:i}=t;this.checkServerTime(n,i,"makeHttpRequestWrapperAsync");const u=n.skipParseResultJson?t.responseText:await this.parseApiCallResultAsync(t,"makeHttpRequestWrapperAsync");return{responseContext:i,result:u}}buildMakeHttpRequestParameters(i){try{const{method:e,url:o,token:s,skipToken:h,headers:r,body:c}=i,l=e==="POST"?1:0,t=SearchAppWrapper.CortanaApp.createStringMap();n.config.msbSkipUserAgent||(t["User-Agent"]=n.getUserAgent());h||(t.Authorization=`Bearer ${s}`);t.Accept="*/*";t["X-Search-TrafficType"]="WsbClient";const u=n.Host.getLanguage();t["X-MSEdge-UILang"]=u;t["X-FD-UILang"]=u;t["X-Client-Language"]=u;const f=SearchAppWrapper.CortanaApp.createStringMap();f["Content-Type"]="application/json";for(const n in r)n.toLowerCase().startsWith("content-")?f[n]=r[n]:t[n]=r[n];const a=c||"";return{requestMethod:l,url:o,requestHeaders:t,body:a,contentHeaders:f}}catch(r){throw new t({statusCode:n.ClientErrorCode.MsbHttpBuildApiParameterError},{publicMessage:`[MsbHttpWrapper].buildMakeHttpRequestParameters failed`},r);}}async callMakeHttpRequestApiAsync(i){const{requestMethod:v,url:y,requestHeaders:p,body:w,contentHeaders:b}=i;let o,s,c,r,u,l,f;try{if(o=performance.now(),s=n.getCurrentDate(),c=n.getCurrentTime(),(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbHttpFail)==="at-call")throw new Error("mocked failed error at call");f=await SearchAppWrapper.CortanaApp.makeHttpRequestAsync(v,y,p,w,b);r=performance.now();u=n.getCurrentDate();l=n.getCurrentTime()}catch(a){return r=performance.now(),u=n.getCurrentDate(),Promise.reject(new t({statusCode:n.ClientErrorCode.MsbAjaxMakeHttpRequestAsyncError,perfStart:o,perfEnd:r,startDateTime:s,endDateTime:u},{publicMessage:`[MsbHttpWrapper].callMakeHttpRequestApiAsync failed when calling API`},a))}const h=this.createResponseContext(f.contentHeaders,f.statusCode,c,l,o,r,s,u);let e;try{if((n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbHttpFail)==="at-read")throw new Error("mocked failed error at read");e=await f.readAsStringAsync();h.responseText=e}catch(a){return Promise.reject(new t(h,{publicMessage:`[MsbHttpWrapper].callMakeHttpRequestApiAsync failed when reading response`,privateMessage:e},a))}return{responseContext:h,responseText:e}}async fetchWrapperAsync(n){const r=this.buildFetchParameters(n),t=await this.callFetchApiAsync(r),{responseContext:i}=t;this.checkServerTime(n,i,"fetchWrapperAsync");const u=n.skipParseResultJson?t.responseText:await this.parseApiCallResultAsync(t,"fetchWrapperAsync");return{responseContext:i,result:u}}buildFetchParameters(i){try{const{method:r,url:f,token:e,skipToken:o,noCredentials:s,body:h,headers:u,ignoreDefaultHeaders:c}=i,t=new Headers;if(!c){o||t.append("Authorization",`Bearer ${e}`);t.append("Content-Type","application/json");const i=n.Host.getLanguage();t.append("X-Search-TrafficType","WsbClient");t.append("X-MSEdge-UILang",i);t.append("X-FD-UILang",i);t.append("X-Client-Language",i);t.append("User-Agent",n.getUserAgent())}for(const n in u)t.append(n,u[n]);const l=r=="GET"?undefined:h||"";return{url:f,method:r,body:l,headers:t,noCredentials:s}}catch(r){throw new t({statusCode:n.ClientErrorCode.MsbHttpBuildApiParameterError},{publicMessage:`[MsbHttpWrapper].buildFetchParameters failed`},r);}}async callFetchApiAsync(i){const{url:v,method:y,body:p,headers:w,noCredentials:b}=i;let o,s,c,r,u,l,f;try{if(o=performance.now(),s=n.getCurrentDate(),c=n.getCurrentTime(),(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbHttpFail)==="at-call")throw new Error("mocked failed error at call");const t=b?undefined:n.config.msbDsbEnableFetchCookie?"include":"same-origin";f=await fetch(v,{method:y,body:p,headers:w,credentials:t});r=performance.now();u=n.getCurrentDate();l=n.getCurrentTime()}catch(a){return r=performance.now(),u=n.getCurrentDate(),Promise.reject(new t({statusCode:n.ClientErrorCode.FetchError,perfStart:o,perfEnd:r,startDateTime:s,endDateTime:u},{publicMessage:`[MsbHttpWrapper].callFetchApiAsync failed when calling API`},a))}const h=this.createResponseContext(f.headers,f.status,c,l,o,r,s,u);let e;try{if((n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbHttpFail)==="at-read")throw new Error("mocked failed error at read");e=await f.text();h.responseText=e}catch(a){return Promise.reject(new t(h,{publicMessage:`[MsbHttpWrapper].callFetchApiAsync failed when reading response`,privateMessage:e},a))}return{responseContext:h,responseText:e}}createResponseContext(n,t,i,r,u,f,e,o){const{serverTraceId:s,serverLatency:h,serverTime:c}=this.getServerInfoFromHeader(n)||{};return{statusCode:t,serverTraceId:s,serverLatency:h,perfStart:u,perfEnd:f,startDateTime:e,endDateTime:o,requestSentTime:i,responseReceivedTime:r,serverTime:c}}async parseApiCallResultAsync(n,i){const{responseContext:u,responseText:r}=n;if(u.statusCode==200)try{return JSON.parse(r)}catch(f){const e=r==="";let n="";return f instanceof SyntaxError&&(n=`, syntaxError=${f.message}`),Promise.reject(new t(u,{publicMessage:`[MsbHttpWrapper].parseApiCallResultAsync(${i}) failed, emptyResponse=${e}`+n,privateMessage:r},f))}else return Promise.reject(new t(u,{publicMessage:`[MsbHttpWrapper].parseApiCallResultAsync(${i}) failed non-HTTP200`,privateMessage:r}))}validateTokenExpiry(i){const r=i.tokenJwtExp;if(r){const u=n.getCurrentTime(),f=r-u;if(f<0){const e=i.tokenRefreshTime,o=u-(e||0);throw new t({statusCode:n.ClientErrorCode.MsbTokenExpiredBeforeRequest},{publicMessage:`{[MsbHttpWrapper].sendHttpAsync}, rt=${e}, jwtExp=${r}, now=${u}`});}}}checkServerTime(t,r,u){if(n.config.msbServerClientTimeSkewLimitMins&&t.checkServerTime){const{serverTime:f,requestSentTime:e,serverTraceId:o}=r;if(f&&e){const r=f-e,s=`[MsbHttpWrapper].${u} returned, ServerTime=${f}, ClientTime=${e}, diff=${r}, urlBase=${n.msbHost.urlUtils.getUrlBaseInfo(t.url)}`,h=`Target URL: ${t.url}`;if(Math.abs(r)>n.config.msbServerClientTimeSkewLimitMins*i){const t=n.msbHost.isMsbInternalTenant()?h:undefined;bfbWsbTel.logError("Wsb server and client time mismatch",s,{serverTraceId:o,additionalMessage:t})}}}}getServerInfoFromHeader(t){const i=t===null||t===void 0?void 0:t[r],f=t===null||t===void 0?void 0:t[u];if(i||f)return{serverTraceId:i,serverLatency:f};const e=n.getMsEdgeRef(t),{traceId:o,timestamp:s}=e||{};return{serverTraceId:o,serverTime:s}}}n.MsbHttpWrapper=f}(WSB||(WSB={})),function(n){const i={["Person"]:"People",["Group"]:"Group",["Bookmark"]:"Bookmark",["Building"]:"Building",["Qna"]:"EditorialQnA",["File"]:"File",["Acronym"]:"Acronym"},t=/[0-9a-zA-Z]/,r=/\s+/g;class u{getTenantSetting(t,i){if(n.config.msbEnableAccountManager)throw new Error("Deprecated - MsbDataAccess.getTenantSetting");n.msbHost.tokenManager.refreshMsbTokenAndCall(()=>{this.fetchTenantSettings(t,i)},()=>{i(n.ClientErrorCode.RefreshTokenFailure,{message:"MsbDataAccess.getTenantSetting"})},undefined,"GetTenantSetting")}fetchTenantSettings(t,i){const r=n.msbHost.urlUtils.getMsbUrl("v2/tenant/my/settings"),u=n.config.msbTenantSettingThemeOff?n.msbHost.urlUtils.insertParameter(r,"variants=msbtntthemeoff"):r,f={url:u,checkServerTime:!0,onSuccess:t,onError:i};n.Msb.sendAjax(f)}async fetchSearchResponseAsync(n,t,i){const u=await this.fetchSearchResponseFetchTokenAsync(),r=await this.fetchSearchResponseCallServiceAsync(u,n,t,i);return this.fetchSearchResponseCheckResult(r,n,t),r.result}async fetchSearchResponseFetchTokenAsync(){try{const{token:t}=await n.msbHost.accountManager.refresh3STokenAsync();return t}catch(t){_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Preview Pane No Msb 3s Token","");throw t;}}async fetchSearchResponseCallServiceAsync(t,i,r,u){var e;try{const o={[0]:n.config.msb3sQueryUrl,[1]:n.config.msb3sQueryUrl,[2]:n.config.msbUsGov3sQueryUrl},s=((e=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||e===void 0?void 0:e.gccRegion)?o[BingAtWork.wsb.gccRegion]:n.config.msb3sQueryUrl,h={["X-Client-LocalTime"]:n.getDateWithTimezone()},c=this.buildMsb3sQueryRequest(i,r),l=JSON.stringify(c);this.fireResetSearchOptions(u);const a={method:"POST",url:s,token:t,headers:h,body:l},f=await n.msbHost.httpWrapper.sendHttpAsync(a);return this.fire3sRtt(f.responseContext),f}catch(f){const t="Wsb Fetch Search Response Failed";if(f instanceof n.MsbHttpError){const{responseContext:{statusCode:r,serverTraceId:u,requestSentTime:e,responseReceivedTime:o},errorMessage:i,innerError:s}=f;if(r!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){const f={ReqTS:e,ResTS:o};let h;n.msbHost.isMsbInternalTenant()&&(h=i===null||i===void 0?void 0:i.privateMessage,f.InnerError=n.stringifyError(s));_w.bfbWsbTel&&bfbWsbTel.logHttpError(t,i===null||i===void 0?void 0:i.publicMessage,{serverTraceId:u,statusCode:r,additionalMessage:h},f)}this.fire3sRtt(f.responseContext)}else _w.bfbWsbTel&&bfbWsbTel.logHttpError(t,"Unknown error",{additionalMessage:n.msbHost.isMsbInternalTenant()?n.stringifyError(f):undefined});throw f;}}fetchSearchResponseCheckResult(t,i,r){const{result:u,responseContext:{serverTraceId:f}}=t;if(this.is3sResponseEmpty(u,r)){const r=`[MSB.Error] fetchMsb3sQueryResponse received empty searchResponse or searchResponse.results for query ${i}`;const u=n.msbHost.isMsbInternalTenant()?r:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Search Response Empty Results","",{serverTraceId:f,additionalMessage:u});throw new Error("WsbSearchResponseEmptyResults");}}fetchSearchResponse(t,i,r,u,f){if(n.config.msbEnableAccountManager)throw new Error("Deprecated - MsbDataAccess.fetchSearchResponse");n.msbHost.tokenManager.refresh3sTokenAndCall(()=>{this.fetchMsb3sQueryResponse(t,i,r,u,f)},()=>{_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Preview Pane No Msb 3s Token",""),u()},(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbDataAccess::fetchSearchResponse"]:undefined)}fetchMsb3sQueryResponse(t,i,r,u,f){var e;const s={[0]:n.config.msb3sQueryUrl,[1]:n.config.msb3sQueryUrl,[2]:n.config.msbUsGov3sQueryUrl},h=((e=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||e===void 0?void 0:e.gccRegion)?s[BingAtWork.wsb.gccRegion]:n.config.msb3sQueryUrl,o=this.buildMsb3sQueryRequest(t,i),c=JSON.stringify(o);this.fireResetSearchOptions(f);const l={url:h,useToken:"WSB3S",requestType:"POST",body:c,onSuccess:(f,e)=>{if(f)if(this.is3sResponseEmpty(f,i)){const i=`[MSB.Error] fetchMsb3sQueryResponse received empty searchResponse or searchResponse.results for query ${t}`;const r=n.msbHost.isMsbInternalTenant()?i:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Search Response Empty Results","",{serverTraceId:e,additionalMessage:r});u()}else r(f,o);else{const n=`[MSB.Error] fetchMsb3sQueryResponse received empty response for query ${t} of intent ${i}`;_w.bfbWsbTel&&bfbWsbTel.logError("Wsb 3S Query Response is Empty","",{serverTraceId:e});u()}},onError:(r,f)=>{const{responseText:e,message:o,errorMessage:c,stackTrace:s,serverTraceId:h,requestSentTime:l,responseReceivedTime:a,isBrowserOnline:v,hResultString:y}=f,p=`[MSB.Error] fetchMsb3sQueryResponse failed, details=${JSON.stringify({queryText:t,intent:i,statusCode:r,responseText:e,message:o,stackTrace:s,serverTraceId:h})}`;if(r!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){const u=n.msbHost.isMsbInternalTenant()?`Query: ${t}, intent: ${i}, responseText: ${e}, errorMEssage: ${c}`:"",f=n.msbHost.isMsbInternalTenant()?s:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Search Response Failed",o,{stackTrace:f,serverTraceId:h,statusCode:r,additionalMessage:u},{Online:v,HResult:y,ReqTS:l,ResTS:a})}u()},onRoundTripReport:n=>{this.fireRoundTripTime("SubstrateSearch_RoundTripTime",n)},headers:{["X-Client-LocalTime"]:n.getDateWithTimezone()}};n.Msb.sendAjax(l)}fireResetSearchOptions(t){var i,r;const u={messageType:"MSB_RESET_SEARCH_OPTIONS",payload:{wsbIG:(i=window===null||window===void 0?void 0:window._G)===null||i===void 0?void 0:i.IG,wsbCvid:n.Host.getConversationId(),wsbLogicalId:(r=window===null||window===void 0?void 0:window._G)===null||r===void 0?void 0:r.IG,clientType:n.msbHost.getClientType(t)}};n.safeExecute(()=>{window.postMessage(u,window.location.origin)},"fireResetSearchOptions")}fireSearchResponse(t,i,r){const u=this.buildMsb3sQueryRequest(t),f=n.Host.createGuid(),e={messageType:"MSB_SET_3S_QUERY_RESPONSE",payload:{requestId:f,request:u,response:r,queryText:i}};n.safeExecute(()=>{window.postMessage(e,window.location.origin)},"fireSearchResponse")}fireClientQfResponse(t,i,r){this.fireResetSearchOptions(r);const u=i,f=this.buildMsb3sQueryRequest(t),e={messageType:"MSB_SET_CLIENT_QF_RESPONSE",payload:{request:f,response:u}};n.safeExecute(()=>{window.postMessage(e,window.location.origin)},"fireClientQfResponse")}fire3sRtt(n){const t=this.getRoundTripInfo(n);this.fireRoundTripTime("SubstrateSearch_RoundTripTime",t)}getRoundTripInfo(n){const{statusCode:t,serverTraceId:i,serverLatency:r,perfStart:u,perfEnd:f,startDateTime:e,endDateTime:o}=n,s=t===200?undefined:`HTTP${t}`;return{status:t,traceId:i,serverLatency:r,startTime:u,endTime:f,startDateTime:e,endDateTime:o,errorMessage:s}}fireRoundTripTime(t,i){const r=Object.assign({eventId:t},i);const u={messageType:"MSB_SEARCH_RTT",payload:r};n.safeExecute(()=>{window.postMessage(u,window.location.origin)},"fireRoundTripTime")}buildMsb3sQueryRequest(t,r){var f,e,o;const u=r&&i[r],s=u!=null?[u]:[];switch(r){case"File":return{Cvid:n.Host.getConversationId(),LogicalId:(f=window===null||window===void 0?void 0:window._G)===null||f===void 0?void 0:f.IG,EntityRequests:[{Query:{QueryString:t,DisplayQueryString:t},ContentSources:["SharePoint","OneDriveBusiness"],EntityType:u!==null&&u!==void 0?u:"",From:0,Size:1}],Scenario:{Name:"Wsb.PreviewPane"},TextDecorations:"Off"};case"Acronym":return{Cvid:n.Host.getConversationId(),LogicalId:(e=window===null||window===void 0?void 0:window._G)===null||e===void 0?void 0:e.IG,AnswerEntityRequests:[{Query:{QueryString:t.replace(/[\s-]/g,"")},EntityTypes:s,From:0,Size:n.config.msbClientQfEnableAcronymAllResult?10:1}],Scenario:{Name:"Wsb.PreviewPane"},TextDecorations:"Off"};default:return{Cvid:n.Host.getConversationId(),LogicalId:(o=window===null||window===void 0?void 0:window._G)===null||o===void 0?void 0:o.IG,AnswerEntityRequests:[{Query:{QueryString:t},EntityTypes:s,From:0,Size:1}],Scenario:{Name:"Wsb.PreviewPane"},TextDecorations:"Off"}}}is3sResponseEmpty(n,t){if(t==="File"){const t=n;return!t.EntitySets||t.EntitySets.length===0}else{const t=n;return!t.AnswerEntitySets||t.AnswerEntitySets.length===0}}createGetPersonIcon(t,i,r){return t?async(u,f)=>{const o=await n.msbHost.photoManager.getPhotoAsync(t,i?"PersonPhoto":"GroupPhoto","Qf");let e=r;if(o){const{imageInBase64:t}=o;t&&(e=n.toIcon(`data:image/jpeg;base64,${t}`,"createGetPersonIcon"))}e.className="peopleIcon";f(e)}:(n,t)=>t(r)}getBookmarkIcon(){return{content:"&#xEB8F",type:2}}getAcronymIcon(){return n.msbHost.iconUtils.getFluentIcon("acronymIcon")}getMsbQnaIcon(t,i){const r=n.msbHost.iconUtils.getFluentIcon("msbQnaIcon");r.className="msb-suggIcon";i(r)}getFluentBookmarkIcon(){return(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.mockMRUIcons)?this.getBookmarkIcon():n.msbHost.iconUtils.getFluentIcon("colorfulBookmarkIcon")}getWorkFluentIcon(){return(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.mockMRUIcons)?{type:0,className:n.config.mirrorMruLBSHItemIcon?"LBSHSpyglassSV2":"LBSHSpyglass"}:n.msbHost.iconUtils.getFluentIcon("workIcon")}getLocationIcon(){return{content:"&#xECAF",type:2}}getDefaultIcon(n){let i;const u=n.trim().replace(r," ").split(" ",2);if(u.length>0){const n=u[0][0];if(t.test(n)&&(i=n),u.length==2){const n=u[1][0];i&&t.test(n)?i+=n:i=""}}return{type:i?5:2,content:i?i.toUpperCase():"&#xE77B",className:"peopleIcon"}}}n.MsbDataAccess=u}(WSB||(WSB={})),function(n){const t="wsb.ux.workserp",i="msb.ux.workserp";class r{constructor(){var n;this.msbPrefetch=_w.BingAtWork;this.msbContext=(n=_w.BingAtWork)===null||n===void 0?void 0:n.context}Warmup3s(){var r;if(((r=this.msbPrefetch)===null||r===void 0?void 0:r.substrateWarmup)&&this.msbContext){const{conversationId:r}=this.msbContext,u=n.config.msbWorkScopeScenarioNameEnabled?t:i;this.msbPrefetch.substrateWarmup([u],r)}}FetchMsbUnifiedSearch(r){var u;if(((u=this.msbPrefetch)===null||u===void 0?void 0:u.substrateUnifiedSearch)&&this.msbContext){this.msbContext.query=r;const u=n.config.msbWorkScopeScenarioNameEnabled?t:i;this.msbPrefetch.substrateUnifiedSearch("All",undefined,!0,u,undefined,undefined,n.config.msbQwqsEnableWsbClickTarget&&n.msbHost.isEduTenant())}}FetchTenantSettings(){var t;if((t=this.msbPrefetch)===null||t===void 0?void 0:t.fetchTenantSettings){const t=n.msbHost.urlUtils.getMsbUrl("v2/tenant/my/settings");this.msbPrefetch.fetchTenantSettings(t);this.msbPrefetch.isTenantSettingsPrefetchStarted=!1}}FetchUserConfigs(){var t;if((t=this.msbPrefetch)===null||t===void 0?void 0:t.fetchUserConfigs){const t=n.msbHost.urlUtils.getMsbUrl("v3/user/data/configs");this.msbPrefetch.fetchUserConfigs(t)}}}n.MsbPrefetchManager=r}(WSB||(WSB={})),function(n){function t(n){return n===null?null:n===undefined?undefined:typeof n=="number"||typeof n=="string"||typeof n=="boolean"?n:Array.isArray(n)?n.map(t):Object.keys(n).reduce((i,r)=>{const u=`${r[0].toUpperCase()}${r.slice(1)}`;return i[u]=typeof n[r]=="object"?t(n[r]):n[r],i},{})}const i="MSBLS_bfbSubstrateToken";n.VerticalConfigLocalStorageKey="WsbMsbVerticalConfig";const r=6;class u{constructor(t,i){this.tokenManager=t;this.tenantManager=i;this.cachedVerticalItems=[];this.isVerticalConfigApiCallInProgress=!1;n.Host.bindAccountChanged(()=>this.clearWorkScopeTokenStorage());i.bindTenantEnabled((n,t)=>this.refreshVerticalItems(!0,t,n));i.bindTenantDisabled(()=>this.refreshVerticalItems(!1,"MsbVerticalManager:TenantDisabled"))}getSyntheticSuggestions(t,i){return(t===null||t===void 0?void 0:t.queryToFetch)&&t.scope===n.Scope.Work&&n.config.msbVerticalWorkScopeEnabled?this.createSuggestionList(t,i):[]}getWorkSuggestionAnnotation(){return n.Host.getLocString(n.msbHost.isEduTenant()?"SchoolResults":"WorkResults")}createSuggestionList(t,i){let r=[];if(t.scope===n.Scope.Work){const u=this.cachedVerticalItems.filter(n=>{var t;return((t=n.verticalId)===null||t===void 0?void 0:t.toLowerCase())==="all"}).map(n=>this.createSuggestion(n,t,i,!1))[0],f=this.cachedVerticalItems.filter(n=>{var t;return((t=n.verticalId)===null||t===void 0?void 0:t.toLowerCase())!=="all"}).map(n=>this.createSuggestion(n,t,i,!0));if(u){u.childSuggestions=u.childSuggestions||[];for(const t of f){const i=t;u.childSuggestions.push(i);i.parent=u;i.displayed=!0;i.groupType=n.GroupType.Related}const i=n.SequenceNumberManager.getSequenceNumber();r=[u];const t=[];t.push(u);f.map(n=>t.push(n));n.InstrumentationHelper.instrumentDataSource(i,"MSBV",t,{})}}return r}cleanupCachedVerticalItems(){this.cachedVerticalItems=[]}clearWorkScopeTokenStorage(){n.LightweightStorage.removeItem(i)}refreshVerticalItems(t,i,r){if(t&&n.msbHost.features.isWorkScopeApplicable()){r=`v1-${r||this.tokenManager.getMsbAccountRoutingHint()}`;const n=this.getCachedVerticalConfig(r);n?this.setupVerticalItems(n):this.getAndSetVerticalItems(r,i)}else this.cleanupCachedVerticalItems(),this.cleanCachedVerticalConfig()}getAndSetVerticalItems(t,i){n.msbHost.features.isThorProxyEnabled()?this.tokenManager.refreshMsbTokenAndCall(()=>this.verticalConfigSuccessHandler(t,i),this.verticalConfigFailureHandle,undefined,"MsbVerticalManager"):this.tokenManager.refreshLokiTokenAndCall(()=>this.verticalConfigSuccessHandler(t,i),this.verticalConfigFailureHandle,"MsbVerticalManager")}verticalConfigSuccessHandler(t,i){const r=n.Host.getConversationId();this.isVerticalConfigApiCallInProgress?n.config.msbVerticalConfigMultipleCallLogsEnabled&&(bfbWsbTel===null||bfbWsbTel===void 0?void 0:bfbWsbTel.logValue("Wsb Multiple Vertical Config Requested",i,{conversationId:r})):(this.isVerticalConfigApiCallInProgress=!0,this.fetchVerticalConfig(n=>{this.isVerticalConfigApiCallInProgress=!1,this.setupVerticalItems(n),this.cacheVerticalConfig(n,t)},(t,u)=>{this.isVerticalConfigApiCallInProgress=!1;this.cleanupCachedVerticalItems();const{message:f,stackTrace:e,serverTraceId:o,requestSentTime:s,responseReceivedTime:h,isBrowserOnline:c,hResultString:l}=u;(t!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest)&&(bfbWsbTel===null||bfbWsbTel===void 0?void 0:bfbWsbTel.logHttpError("Wsb Fetch Vertical Config Failed",f,{statusCode:t,stackTrace:e,serverTraceId:o,cvid:r},{Online:c,HResult:l,ReqTS:s,ResTS:h,caller:i}))}))}verticalConfigFailureHandle(n){bfbWsbTel===null||bfbWsbTel===void 0?void 0:bfbWsbTel.logError("VerticalConfigAccessTokenNotFound",n)}cacheVerticalConfig(t,i){if(t&&t.length>0){const u=new Date,f={data:t,expiry:u.setHours(u.getHours()+r),routingHint:i};n.LightweightStorage.setItem(n.VerticalConfigLocalStorageKey,JSON.stringify(f))}}cleanCachedVerticalConfig(){n.LightweightStorage.removeItem(n.VerticalConfigLocalStorageKey)}getCachedVerticalConfig(t){const i=n.LightweightStorage.getItem(n.VerticalConfigLocalStorageKey);let r;if(i)try{const u=JSON.parse(i);u.routingHint===t&&u.expiry>n.getCurrentTime()?r=u.data:this.cleanCachedVerticalConfig()}catch(u){this.cleanCachedVerticalConfig()}return r}getLocDisplayName(t,i,r,u){let f="";switch(i===null||i===void 0?void 0:i.toLowerCase()){case"all":f=u||n.msbHost.features.isWorkScopeListViewEnabled()?n.Host.getLocString("MsbVerticalChildAll"):n.Host.getLocString("MsbVerticalParentPattern");break;case"people":f=u||n.Host.getLocString("MsbVerticalChildPeople");break;case"sites":f=u||n.Host.getLocString("MsbVerticalChildSites");break;case"files":f=u||n.Host.getLocString("MsbVerticalChildFiles");break;case"messages":f=n.Host.getLocString("MsbVerticalChildMessages");break;case"assignments":f=u||n.Host.getLocString("MsbVerticalChildAssignments");break;default:r===1&&(f=n.Host.getLocString("MsbVerticalChildConnectorsPattern").replace("{display-name}",u||t))}return f}setupVerticalItems(t){if(this.cleanupCachedVerticalItems(),t){let i,r,u,f,e;const o=[];if(t.length)for(const n of t){const{Id:t,VerticalType:e,DisplayName:s,State:h}=n;switch(t===null||t===void 0?void 0:t.toLowerCase()){case"all":h===1&&(i={verticalId:t,displayName:this.getLocDisplayName("",t,e,s),verticalHash:"",navDomain:"",navDomainId:"",type:"MVALL"});break;case"people":h===1&&(r={verticalId:t,displayName:this.getLocDisplayName("Person",t,e,s),verticalHash:`${"Person"}-${t}`,navDomain:"Person",navDomainId:t,icon:{content:"&#xE716",type:2},type:"MVPPL"});break;case"sites":h===1&&(u={verticalId:t,displayName:this.getLocDisplayName("Site",t,e,s),verticalHash:`${"Site"}-${t}`,navDomain:"Site",navDomainId:t,icon:{content:"&#xE737",type:2},type:"MVSIT"});break;case"files":h===1&&(f={verticalId:t,displayName:this.getLocDisplayName("File",t,e,s),verticalHash:`${"File"}-${t}`,navDomain:"File",navDomainId:t,icon:{content:"&#xEF6C",type:2},type:"MVFIL"});break;default:h===1&&e===1&&o.push({verticalId:t,displayName:this.getLocDisplayName("Connectors",t,e,s),verticalHash:`${"Connectors"}-${t}`,navDomain:"Connectors",navDomainId:t,icon:{content:"&#xE737",type:2},type:"MVCON"})}}const s={verticalId:"Message",displayName:this.getLocDisplayName("Message","Messages"),verticalHash:`${"Message"}-conversations`,navDomain:"Message",navDomainId:"conversations",icon:{content:"&#xE901",type:2},type:"MVMES"},h=n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isEduScopeApplicable();h&&(e={verticalId:"Assignments",displayName:this.getLocDisplayName("EducationAssignment","Assignments"),verticalHash:"EducationAssignment",navDomain:"EducationAssignment",navDomainId:"",icon:{content:"&#xE9D3",type:2},type:"MVASG"});this.cachedVerticalItems=[i,r,u,f,s,e,...o].filter(n=>n!=null)}}createSuggestion(t,i,r,u){const o=n.msbHost.getTenantName(),e=n.msbHost.features.isWorkScopeListViewEnabled(),l=o?n.Host.getLocString("MsbWorkVerticalSuggestionGroupName",o):n.Host.getLocString("MsbVerticalSuggestionGroupName");let s=t.displayName;const a=t.verticalId.toLowerCase()==="all";let h=e?"":`${t.displayName} ${this.getWorkSuggestionAnnotation()}`;if(a){const r=t.displayName.replace("{query-text}",encodeURIComponent(i.queryToFetch));s=e?t.displayName:HitHighlightingParser.addMarkers(decodeURIComponent(r),i.queryToFetch);h=e?"":`${n.Host.getLocString("MsbVerticalAll")} ${this.getWorkSuggestionAnnotation()}`}const c=t.type,f=n.createSuggestion(i,s,undefined,t.icon||{content:"&#xE721",type:2},c,i.queryToFetch,n.InstrumentedItem.createInstrumentedItem(r,c),21,r,!0,t.verticalHash,undefined,u,t.verticalHash);return f.navDomain=t.navDomain,f.navDomainId=t.navDomainId,f.autoOpenPreviewPaneWhenOnTopHit=!1,f.msbVerticalHash=t.verticalHash,f.rankingScore=-9900,f.skipRerank=!0,f.sourceForGroup=0,f.previewPaneType=n.config.msbVerticalDebugDisableMiniSerp?undefined:1,f.primaryMetadata=h,f.id=`ws-${t.verticalId.toLowerCase()}`,f.template=0,f.groupDisplayName=l,n.msbHost.features.isWorkMruEnabled()&&(f.getMruData=()=>n.getMruUrlSuggestionData(f,"")),f}mergeArgsIntoUrl(n,t){const i=_w.BingAtWork;return typeof(i===null||i===void 0?void 0:i.mergeArgsIntoUrl)=="function"&&(n=i.mergeArgsIntoUrl(n,t)),n}getLokiVerticalConfigUrl(){let t=n.msbHost.urlUtils.getLokiUrl("v1/search/configuration/verticals");if(t){const{conversationId:n,sessionId:i}=BingAtWork.context,r={RootCorrelationId:n!==null&&n!==void 0?n:"",conversationId:n!==null&&n!==void 0?n:"",ClientCorrelationId:i,ConvertGetPost:"true"};t=this.mergeArgsIntoUrl(t,r)}return t}getThorVerticalConfigUrl(){let t=n.msbHost.urlUtils.getMsbUrl("thor/api/v1/search/configuration/verticals");if(t)t=this.mergeArgsIntoUrl(t,{ConvertGetPost:"true"});return t}fetchThorVerticalConfig(i,r){const u=this.getThorVerticalConfigUrl();if(u){const{sessionId:f}=BingAtWork.context,e={Accept:"text/plain, application/json, text/json","X-ClientFeature":"Search","X-ClientType":n.msbHost.getClientType(n.Scope.Work),"X-ClientCorrelationId":f||""},o={url:u,requestType:"POST",body:JSON.stringify(e),checkServerTime:!0,onSuccess:n=>i(t(n)),onError:(n,t)=>r(n,t)};n.Msb.sendAjax(o)}else r(n.ClientErrorCode.UrlUnavailable,{message:"Url is undefined because not able to resolve Thor domain"})}fetchLokiVerticalConfig(i,r){const u=this.getLokiVerticalConfigUrl();if(u){const f={"X-ClientType":n.msbHost.getClientType(n.Scope.Work)},e={url:u,useToken:"WSBLoki",requestType:"POST",body:JSON.stringify(f),checkServerTime:!0,onSuccess:n=>i(t(n)),onError:(n,t)=>r(n,t)};n.Msb.sendAjax(e)}else r(n.ClientErrorCode.UrlUnavailable,{message:"Url is undefined because not able to resolve Loki domain"})}fetchVerticalConfig(t,i){n.msbHost.features.isThorProxyEnabled()?this.fetchThorVerticalConfig(t,i):this.fetchLokiVerticalConfig(t,i)}}n.MsbVerticalManager=u}(WSB||(WSB={})),function(n){class t{async launchProactiveWorkSearchAsync(t){const f=await n.msbHost.urlUtils.buildWorkSearchUrlAsync(t);if(f){const{query:e}=t,{url:o,urlParams:s}=f,{cvid:h,msbd:c,ssat:l,lgid:a}=s;let i,r,u;if(n.config.msbEnableAccountManager){const t=await n.msbHost.accountManager.refreshMsbTokenAsync();i=t.token;r=t.jwtExp;u=t.lastRefreshTime}else{const t=await n.msbHost.tokenManager.refreshMsbTokenAsync();i=t.token;r=t.tokenJwtExp;u=t.tokenRefreshTime}n.msbHost.httpWrapper.sendHttpAsync({method:"POST",url:n.msbHost.urlUtils.getProactiveWorkSearchUrl(),body:JSON.stringify(this.getProactiveSearchRequest(e,h,c,l,a)),token:i,tokenJwtExp:r,tokenRefreshTime:u});n.Host.launchUrlWithEdgeProtocolAsync(o,{medium:"MSBLink"})}}getProactiveSearchRequest(t,i,r,u,f){const{isSubstrateTimeZoneEnabled:e,culture:o,uiCulture:s}=BingAtWork.context;return{query:t,requery:r,entityTypes:this.getEntityTypes(),requestContext:{timezone:e?Intl.DateTimeFormat().resolvedOptions().timeZone:"UTC",culture:o,uICulture:s,cvid:i||n.cleanGuid(n.Host.createGuid()),logicalId:f||n.cleanGuid(n.Host.createGuid())},asyncToken:u||n.cleanGuid(n.Host.createGuid())}}getEntityTypes(){let t=["Building","EditorialQnA","Bookmark","People","Acronym","Group","TuringQnA","Topic","External",];const i=n.msbHost.isEduTenant();return i&&(t=[...t,"EducationAssignment"]),t}}n.MsbProactiveSearchManager=t}(WSB||(WSB={})),function(n){const t="MsbPhoto-",i="MsbPhoto";class r{constructor(){this.photoCacheKeyBuilder=n=>`${t}${n}`;this.photoCache=new n.MsbKeyValueCache({name:i})}async getPhotoAsync(t,i,r,u){const o=await this.getCachedPhotoAsync(t),{isCacheValid:s}=o;let{cachedPhoto:f}=o;if(s&&f)return f.data;try{const n=await this.fetchPhotoAsync(t,i);return f={data:{noImage:n?undefined:!0,imageInBase64:n},expireTime:this.calculateExpireTime()},await this.photoCache.setItemAsync(this.photoCacheKeyBuilder(t),f),f.data}catch(e){const o=this.getTelemetryErrorEventId(t,i,r);if(e instanceof n.MsbHttpError){const{responseContext:f,errorMessage:t,innerError:s,isBrowserOnline:h,hResultString:c}=e,{statusCode:l,serverTraceId:a,requestSentTime:v,responseReceivedTime:y}=f;let i,r;n.msbHost.isMsbInternalTenant()&&(i=t===null||t===void 0?void 0:t.privateMessage,r=n.stringifyError(s));const{serverRefreshGuid:p,isBackgroundUpdate:w,page:b}=u||{};_w.bfbWsbTel&&bfbWsbTel.logHttpError(o,t===null||t===void 0?void 0:t.publicMessage,{statusCode:l,additionalMessage:i,serverTraceId:a},{Online:h,HResult:c,ReqTS:v,ResTS:y,InnerError:r,BG:w,page:b,serverRefreshGuid:p})}else{const t=n.msbHost.isMsbInternalTenant()?n.stringifyError(e):"";_w.bfbWsbTel&&bfbWsbTel.logHttpError(o,e.message,{additionalMessage:t})}return f?await this.photoCache.setItemAsync(this.photoCacheKeyBuilder(t),f):_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Msb Fetch and Cache Photo Failed"),f===null||f===void 0?void 0:f.data}}async fetchPhotoAsync(t,i){var e;let r,o,s;if(n.config.msbEnableAccountManager){const t=await n.msbHost.accountManager.refreshMsbTokenAsync();r=t.token;o=t.jwtExp;s=t.lastRefreshTime}else{const t=await n.msbHost.tokenManager.refreshMsbTokenAsync();r=t.token;o=t.tokenJwtExp;s=t.tokenRefreshTime}const p=t.indexOf("@")>-1,h=i==="PersonPhoto"?n.msbHost.urlUtils.getMsbUrl("v3/search/person/photo"):n.msbHost.urlUtils.getMsbUrl("v3/search/group/photo");let u="",l="GET",a="",f,v=!1;const c={};if(p||n.config.msbUseSimpleRequestForPersonPhoto){if(u=h,l="POST",f={clientContext:{clientType:"Wsb"},id:t},n.config.msbUseSimpleRequestForPersonPhoto){v=!0;const n=`traffictype=WsbClient`;u=`${h}?${n}`;c["Content-Type"]="text/plain";f=Object.assign(Object.assign({},f),{authentication:r})}a=JSON.stringify(f)}else{const n=`clientType=Wsb&id=${t}`;u=`${h}?${n}`;c.Accept="application/json"}const{result:y}=await n.msbHost.httpWrapper.sendHttpAsync({method:l,url:u,body:a,headers:c,ignoreDefaultHeaders:v,token:r,tokenJwtExp:o,tokenRefreshTime:s});return(e=y.imageInBase64)!==null&&e!==void 0?e:y.ImageInBase64}async getCachedPhotoAsync(t){let i=!1;const u=this.photoCacheKeyBuilder(t),r=await this.photoCache.getItemAsync(u);if(!r)return{isCacheValid:i};const f=n.getCurrentTime()>r.expireTime;return f&&await this.photoCache.deleteItemAsync(u),i=!f,{cachedPhoto:r,isCacheValid:i}}calculateExpireTime(t=n.getCurrentTime()){var i;return t+((i=n.config.msbPhotoCacheAge)!==null&&i!==void 0?i:0)*1e3}getTelemetryErrorEventId(n,t,i){const r=n.indexOf("@")>-1;return i==="Dsb"?t=="PersonPhoto"?r?"Wsb Dsb Fetch Person Photo By Email Failed":"Wsb Dsb Fetch Person Photo Failed":"Wsb Dsb Fetch Group Photo Failed":t=="PersonPhoto"?"Wsb Fetch Person Photo Failed":"Wsb Fetch Group Photo Failed"}}n.MsbPhotoManager=r}(WSB||(WSB={})),function(n){const t="KeyValues",u=1;class r extends Error{constructor(n){super(`MsbKeyValueDbParameter '${n}' is falsy`);this.parameterName=n}}class i extends Error{constructor(n,t){super(`MsbKeyValueDbLowLevelError: '${n}'`);this.operation=n;this.innerError=t}}class f{constructor(n){this.cacheInfo=n;this.pendingWritingPromises={}}async getItemAsync(t){try{const n=await this.openDbAsync();return await this.readDbStoreAsync(n,t)}catch(i){return this.logKeyValueDbError(i),undefined}}async setItemAsync(t,i){try{const n=await this.openDbAsync();await this.writeDbStoreAsync(n,t,i)}catch(r){this.logKeyValueDbError(r)}}async deleteItemAsync(t){try{const n=await this.openDbAsync();await this.deleteDbStoreAsync(n,t)}catch(i){this.logKeyValueDbError(i)}}async deleteItemsWithPrefixAsync(t){if(t)try{const n=await this.openDbAsync(),i=await this.getDbKvStoreKeysAsync(n),r=i.filter(n=>n===null||n===void 0?void 0:n.startsWith(t)),u=r.map(n=>this.deleteItemAsync(n));await Promise.all(u)}catch(i){this.logKeyValueDbError(i)}}async openDbAsync(){return this.openedDb?this.openedDb:this.pendingOpeningPromise?this.pendingOpeningPromise:(this.pendingOpeningPromise=new Promise((n,t)=>{const{name:f}=this.cacheInfo,r=indexedDB.open(f,u);r.onupgradeneeded=n=>{this.upgradeDb(r.result,n.newVersion,n.oldVersion)};r.onerror=()=>{delete this.pendingOpeningPromise,t(new i("OpenDb",r.error))};r.onsuccess=()=>{const t=r.result;this.openedDb=t;delete this.pendingOpeningPromise;n(t)}}),this.pendingOpeningPromise)}async readDbStoreAsync(n,r){return this.assertKeyIsTruthy(r),await this.pendingWritingPromises[r],new Promise((u,f)=>{const o=n.transaction(t,"readonly"),s=o.objectStore(t),e=s.get(r);e.onerror=()=>f(new i("ReadKv",e.error));e.onsuccess=()=>u(e.result)})}async writeDbStoreAsync(n,r,u){this.assertKeyIsTruthy(r);await this.pendingWritingPromises[r];try{this.pendingWritingPromises[r]=new Promise((f,e)=>{const s=n.transaction(t,"readwrite"),h=s.objectStore(t),o=h.put(u,r);o.onerror=()=>e(new i("WriteKv",o.error));o.onsuccess=()=>f()});await this.pendingWritingPromises[r]}finally{delete this.pendingWritingPromises[r]}}async deleteDbStoreAsync(n,r){this.assertKeyIsTruthy(r);await this.pendingWritingPromises[r];try{this.pendingWritingPromises[r]=new Promise((u,f)=>{const o=n.transaction(t,"readwrite"),s=o.objectStore(t),e=s.delete(r);e.onerror=()=>f(new i("DeleteKv",e.error));e.onsuccess=()=>u()});await this.pendingWritingPromises[r]}finally{delete this.pendingWritingPromises[r]}}async getDbKvStoreKeysAsync(n){return new Promise((r,u)=>{const e=n.transaction(t,"readwrite"),f=e.objectStore(t);if(typeof f.getAllKeys=="function"){const n=f.getAllKeys();n.onerror=()=>u(new i("GetKvKeys",n.error));n.onsuccess=()=>r(n.result)}else{const n=f.openCursor(),t=[];n.onerror=()=>u(new i("EnumKvKeys",n.error));n.onsuccess=()=>{const i=n.result;i?(t.push(i.key),i.continue()):r(t)}}})}assertKeyIsTruthy(n){if(!n)throw new r("key");}logKeyValueDbError(t){let f,u;if((t instanceof r||t instanceof i)&&(f=t.message),t instanceof i){const{innerError:n}=t;n&&(u=`MsbKeyValueDbLowLevelError: errorName=${n.name};`)}n.msbHost.isMsbInternalTenant()&&(u=`${u!==null&&u!==void 0?u:`MsbKeyValueDbLowLevelError:`} error=${n.stringifyError(t)}`);_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Msb Key Value Cache Error",f,{additionalMessage:u})}upgradeDb(i,r,u){if(u===0&&r===1)try{i.createObjectStore(t)}catch(f){let t;f instanceof DOMException&&(t=`MsbKeyValueDbLowLevelError: errorName=${f.name};`);n.msbHost.isMsbInternalTenant()&&(t=`${t!==null&&t!==void 0?t:`MsbKeyValueDbLowLevelError:`} error=${n.stringifyError(f)}`);_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Msb Key Value Cache Error",`MsbKeyValueDbLowLevelError: 'UpgradeDb'`,{additionalMessage:t})}}}n.MsbKeyValueCache=f}(WSB||(WSB={})),function(n){const r=36e5;let i;(function(n){n[n.None=0]="None";n[n.EdgeWorth=1]="EdgeWorth";n[n.People=2]="People";n[n.Groups=3]="Groups";n[n.Bookmarks=4]="Bookmarks";n[n.Qna=5]="Qna";n[n.Buildings=6]="Buildings";n[n.EducationAssignments=7]="EducationAssignments";n[n.UserHistory=8]="UserHistory";n[n.Connector=9]="Connector";n[n.TopBookmarks=10]="TopBookmarks";n[n.ServerTrie=11]="ServerTrie";n[n.Acronym=13]="Acronym"})(i||(i={}));let t;(function(n){n[n.NoBingAtWork=-2]="NoBingAtWork";n[n.None=-1]="None";n[n.Empty=0]="Empty";n[n.Partial=1]="Partial";n[n.Complete=2]="Complete"})(t||(t={}));let u;(function(n){n.ValidResults="Valid Results";n.Empty="Empty";n.EmptyFromParseError="EmptyFromParseError";n.EmptyFromExpired="EmptyFromExpired";n.NoResults="No Results";n.Invalid="Invalid";n.Error="Error";n.Expired="Expired";n.NotApplicable="NotApplicable";n.Initialized="Initialized"})(u=n.MsbQfCacheState||(n.MsbQfCacheState={}));n.QuickWorkSearchCacheStorageKey="QwsCache";n.MSB_WORK_SCOPE_SUGGESTION_FORM_CODE=n.mapOSFormCode("WSBWS0");class f{constructor(){this.msbQfUtilsLoadTime=n.getCurrentTime();this.initCvId=n.Host.getConversationId();this.wsbAadReadyNotified=!1;this.isClientQfSyncDocEventSucceed=!1;this.clientQfStatusResult="";this.MsbClientQfTokenReadyStorageKey="MsbQfReady";this.earlyLoadWindow=5e3;this.startTime=n.getCurrentTime()}getMsbClientQfTrieState(){if(typeof BingAtWork=="undefined")return{inputState:t.NoBingAtWork};const n=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.CQFDebugInfo,i=n===null||n===void 0?void 0:n.trieState;return this.convertCqfTrieState(i)}convertCqfTrieState(n){if(!n)return{inputState:t.None};const r=this.convertInputSources(n);let i;return n.lastRefreshTime&&(i=this.covertTimeToInHours(n.lastRefreshTime)),{inputState:n.inputState,inputSources:r,lastRefreshInHours:i,version:n.version}}covertTimeToInHours(t){const i=n.getCurrentTime()-t;return Math.ceil(i/r)}convertInputSources(n){var t;const r=n===null||n===void 0?void 0:n.inputSources;if(!r)return undefined;const u={};if(Array.isArray(r))r.forEach(n=>{const t=this.convertInputSourceState(n);t&&(u[n.sourceType]=t)});else for(const r in i){const i=this.convertInputSourceState((t=n===null||n===void 0?void 0:n.inputSources)===null||t===void 0?void 0:t[r]);i&&(u[r]=i)}return u}convertInputSourceState(n){if(!n)return undefined;let t,i,r;return n.lastFullSyncTime&&(t=this.covertTimeToInHours(n.lastFullSyncTime)),n.lastDeltaSyncTime&&(i=this.covertTimeToInHours(n.lastDeltaSyncTime)),n.entityType&&(r=n.entityType),{sourceType:n.sourceType,isComplete:n.isComplete,entityType:r,lastFullSyncInHours:t,lastDeltaSyncInHours:i}}isClientQfReady(){if(typeof BingAtWork=="undefined")return!1;if(n.MockUrlParameters)return!0;const t=BingAtWork.msbDataContext;return(t===null||t===void 0?void 0:t.initializeFired)&&(t===null||t===void 0?void 0:t.exposedAccessTokenApiFired)&&(t===null||t===void 0?void 0:t.readyFired)}setWsbAadReadyNotified(){this.wsbAadReadyNotified||(this.wsbAadReadyNotifiedTime=n.getCurrentTime());this.wsbAadReadyNotified=!0}getMsbClientQfState(){const n=BingAtWork.msbDataContext;return typeof BingAtWork=="undefined"?"BingAtWorkNotReady":this.wsbAadReadyNotified?n&&n.exposedAccessTokenApiFired?n.dataLoadFired?"DataLoaded":n.readyFired?"Ready":"NotReady":"QfLoading":"QfLoadNotTriggered"}isWaitForBackfillEnabled(t){return t===n.Scope.People&&n.msbHost.isMsbInternalTenant()?!0:!n.config.msbClientQfNoWaitBackfill}isClientQfBackgroundRefreshEnabled(){return n.msbHost.isMsbInternalTenant()&&n.config.msbClientQfBackgroundRefreshMs||!n.msbHost.isMsbInternalTenant()&&n.config.msbClientQfBackgroundRefreshNonMs}setClientQfSyncDocEventFired(t,i){this.isClientQfSyncDocEventSucceed=t;const r={Success:t?"1":"0",EventSource:i};n.InstrumentationHelper===null||n.InstrumentationHelper===void 0?void 0:n.InstrumentationHelper.logClientInstEvent("ClientInst","MsbClientQfSyncDoc",n.SequenceNumberManager.getSequenceNumber(),r)}getClientQfSyncDocEventFired(){return this.isClientQfSyncDocEventSucceed}is3sFileDisabled(){return n.config.msb3sFileOff&&n.msbHost.isTenantMsbEnabled()&&this.isMsbFileReady()}isMsbFileReady(){const t=this.isClientQfSyncDocEventSucceed||typeof n.MockUrlParameters!="undefined";return this.isClientQfReady()&&t}isMsbAcronymEnabled(){return n.config.msbClientQfEnableAcronym}isMsbAcronymReady(){return this.isMsbAcronymEnabled()&&this.isClientQfReady()}isDocumentZeroQueryEnabled(){return n.config.msbEnableDocumentZQ}sendClientQFTrieRefreshStartedEventFired(t,i){this.clientQFTrieRefreshStartedTime=parseInt(t);const r={Started:"1",StartTime:t?t:"",RefreshType:i};n.InstrumentationHelper===null||n.InstrumentationHelper===void 0?void 0:n.InstrumentationHelper.logClientInstEvent("ClientInst","MsbClientQfTrieRefreshStart",n.SequenceNumberManager.getSequenceNumber(),r)}sendClientQFTrieRefreshFinishedEventFired(t,i,r){const u=this.clientQFTrieRefreshStartedTime,f=parseInt(i),e=u&&f&&!isNaN(u)&&!isNaN(f)&&f-u?(f-u).toString():"",o={ReturnStatus:t!==undefined?t:"",TrieRefreshDurationInMS:e,StartTime:u?u.toString():"",FinishTime:i?i:"",RefreshType:r};n.InstrumentationHelper===null||n.InstrumentationHelper===void 0?void 0:n.InstrumentationHelper.logClientInstEvent("ClientInst","MsbClientQfTrieRefreshFinished",n.SequenceNumberManager.getSequenceNumber(),o)}sendClientQfProviderMetrics(t){var i,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b,k,d,g,nt,tt,it,rt,ut,ft,et,ot,st,ht,ct,lt,at,vt,yt,pt,wt,bt,kt,dt,gt,ni,ti,ii,ri,ui,fi,ei,oi,si,hi,ci,li,ai,vi,yi,pi,wi,bi,ki,di,gi,nr,tr,ir,rr,ur,fr,er,or,sr,hr,cr,lr,ar,vr,yr,pr,wr,br,kr,dr,gr,nu,tu;const iu={TBMLatency:(u=(r=(i=t===null||t===void 0?void 0:t.tbm)===null||i===void 0?void 0:i.latency)===null||r===void 0?void 0:r.toString())!==null&&u!==void 0?u:"",TBMStatus:(o=(e=(f=t===null||t===void 0?void 0:t.tbm)===null||f===void 0?void 0:f.status)===null||e===void 0?void 0:e.toString())!==null&&o!==void 0?o:"",TBMEntityCount:(c=(h=(s=t===null||t===void 0?void 0:t.tbm)===null||s===void 0?void 0:s.entityCount)===null||h===void 0?void 0:h.toString())!==null&&c!==void 0?c:"",TBMProviderSource:(v=(a=(l=t===null||t===void 0?void 0:t.tbm)===null||l===void 0?void 0:l.providerSource)===null||a===void 0?void 0:a.toString())!==null&&v!==void 0?v:"",QNALatency:(w=(p=(y=t===null||t===void 0?void 0:t.qna)===null||y===void 0?void 0:y.latency)===null||p===void 0?void 0:p.toString())!==null&&w!==void 0?w:"",QNAStatus:(d=(k=(b=t===null||t===void 0?void 0:t.qna)===null||b===void 0?void 0:b.status)===null||k===void 0?void 0:k.toString())!==null&&d!==void 0?d:"",QNAEntityCount:(tt=(nt=(g=t===null||t===void 0?void 0:t.qna)===null||g===void 0?void 0:g.entityCount)===null||nt===void 0?void 0:nt.toString())!==null&&tt!==void 0?tt:"",QNAProviderSource:(ut=(rt=(it=t===null||t===void 0?void 0:t.qna)===null||it===void 0?void 0:it.providerSource)===null||rt===void 0?void 0:rt.toString())!==null&&ut!==void 0?ut:"",BMLatency:(ot=(et=(ft=t===null||t===void 0?void 0:t.bm)===null||ft===void 0?void 0:ft.latency)===null||et===void 0?void 0:et.toString())!==null&&ot!==void 0?ot:"",BMStatus:(ct=(ht=(st=t===null||t===void 0?void 0:t.bm)===null||st===void 0?void 0:st.status)===null||ht===void 0?void 0:ht.toString())!==null&&ct!==void 0?ct:"",BMEntityCount:(vt=(at=(lt=t===null||t===void 0?void 0:t.bm)===null||lt===void 0?void 0:lt.entityCount)===null||at===void 0?void 0:at.toString())!==null&&vt!==void 0?vt:"",BMProviderSource:(wt=(pt=(yt=t===null||t===void 0?void 0:t.bm)===null||yt===void 0?void 0:yt.providerSource)===null||pt===void 0?void 0:pt.toString())!==null&&wt!==void 0?wt:"",GRPLatency:(dt=(kt=(bt=t===null||t===void 0?void 0:t.grp)===null||bt===void 0?void 0:bt.latency)===null||kt===void 0?void 0:kt.toString())!==null&&dt!==void 0?dt:"",GRPStatus:(ti=(ni=(gt=t===null||t===void 0?void 0:t.grp)===null||gt===void 0?void 0:gt.status)===null||ni===void 0?void 0:ni.toString())!==null&&ti!==void 0?ti:"",GRPEntityCount:(ui=(ri=(ii=t===null||t===void 0?void 0:t.grp)===null||ii===void 0?void 0:ii.entityCount)===null||ri===void 0?void 0:ri.toString())!==null&&ui!==void 0?ui:"",GRPProviderSource:(oi=(ei=(fi=t===null||t===void 0?void 0:t.grp)===null||fi===void 0?void 0:fi.providerSource)===null||ei===void 0?void 0:ei.toString())!==null&&oi!==void 0?oi:"",PPLLatency:(ci=(hi=(si=t===null||t===void 0?void 0:t.ppl)===null||si===void 0?void 0:si.latency)===null||hi===void 0?void 0:hi.toString())!==null&&ci!==void 0?ci:"",PPLStatus:(vi=(ai=(li=t===null||t===void 0?void 0:t.ppl)===null||li===void 0?void 0:li.status)===null||ai===void 0?void 0:ai.toString())!==null&&vi!==void 0?vi:"",PPLEntityCount:(wi=(pi=(yi=t===null||t===void 0?void 0:t.ppl)===null||yi===void 0?void 0:yi.entityCount)===null||pi===void 0?void 0:pi.toString())!==null&&wi!==void 0?wi:"",PPLProviderSource:(di=(ki=(bi=t===null||t===void 0?void 0:t.ppl)===null||bi===void 0?void 0:bi.providerSource)===null||ki===void 0?void 0:ki.toString())!==null&&di!==void 0?di:"",MRULatency:(tr=(nr=(gi=t===null||t===void 0?void 0:t.mru)===null||gi===void 0?void 0:gi.latency)===null||nr===void 0?void 0:nr.toString())!==null&&tr!==void 0?tr:"",MRUStatus:(ur=(rr=(ir=t===null||t===void 0?void 0:t.mru)===null||ir===void 0?void 0:ir.status)===null||rr===void 0?void 0:rr.toString())!==null&&ur!==void 0?ur:"",MRUEntityCount:(or=(er=(fr=t===null||t===void 0?void 0:t.mru)===null||fr===void 0?void 0:fr.entityCount)===null||er===void 0?void 0:er.toString())!==null&&or!==void 0?or:"",MRUProviderSource:(cr=(hr=(sr=t===null||t===void 0?void 0:t.mru)===null||sr===void 0?void 0:sr.providerSource)===null||hr===void 0?void 0:hr.toString())!==null&&cr!==void 0?cr:"",ACRLatency:(vr=(ar=(lr=t===null||t===void 0?void 0:t.acr)===null||lr===void 0?void 0:lr.latency)===null||ar===void 0?void 0:ar.toString())!==null&&vr!==void 0?vr:"",ACRStatus:(wr=(pr=(yr=t===null||t===void 0?void 0:t.acr)===null||yr===void 0?void 0:yr.status)===null||pr===void 0?void 0:pr.toString())!==null&&wr!==void 0?wr:"",ACREntityCount:(dr=(kr=(br=t===null||t===void 0?void 0:t.acr)===null||br===void 0?void 0:br.entityCount)===null||kr===void 0?void 0:kr.toString())!==null&&dr!==void 0?dr:"",ACRProviderSource:(tu=(nu=(gr=t===null||t===void 0?void 0:t.acr)===null||gr===void 0?void 0:gr.providerSource)===null||nu===void 0?void 0:nu.toString())!==null&&tu!==void 0?tu:""};n.InstrumentationHelper===null||n.InstrumentationHelper===void 0?void 0:n.InstrumentationHelper.logClientInstEvent("ClientInst","MsbClientQfProviderMetrics",n.SequenceNumberManager.getSequenceNumber(),iu)}setClientQfStatusMessage(n){this.clientQfStatusResult=n!==undefined?n:""}getClientQfStatusMessage(){return this.clientQfStatusResult}setQuickWorkSearchCache(t){t?n.LightweightStorage.setItem(n.QuickWorkSearchCacheStorageKey,t):n.LightweightStorage.removeItem(n.QuickWorkSearchCacheStorageKey)}getQuickWorkSearchCache(){return n.LightweightStorage.getItem(n.QuickWorkSearchCacheStorageKey)}setIsMsbClientQfTokenReady(t){n.LightweightStorage.setItem(this.MsbClientQfTokenReadyStorageKey,t?"1":"0")}clearIsMsbClientQfTokenReady(){n.LightweightStorage.removeItemsWithKeyPrefix(this.MsbClientQfTokenReadyStorageKey)}getIsMsbClientQfTokenReady(){return(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.bfbMock)!=null||n.LightweightStorage.getItem(this.MsbClientQfTokenReadyStorageKey)==="1"}isMsbQfInScriptsEarlyLoadState(){return n.config.msbLoadQfScriptEarly&&n.msbHost.shouldForceEnterprise()&&n.getCurrentTime()-this.startTime<this.earlyLoadWindow}getOnRampButtonSuggestion(t,i){const r=n.getSyntheticSuggestion(t,i,"ORB",undefined,23,undefined,!1,()=>{var t,i;const r=n.Host.getQuery(),u=(i=(t=n.ScopeConfig===null||n.ScopeConfig===void 0?void 0:n.ScopeConfig[n.Scope.Documents])===null||t===void 0?void 0:t.prefixes)===null||i===void 0?void 0:i[0],f=`${u}: ${r.queryToFetch}`;n.Host.reformulateNonForcedMiniSerp(f,r.isSearchHomeZI,undefined);n.InstrumentationHelper.logClientInstEvent("Select","OnRampButtonToDocumentScope",undefined)});return r.staticGroupType=n.GroupType.MsbOnRampButton,r.query=t.queryToFetch,r.text=n.Host.getLocString("FindMoreDocuments"),r.narratorText=n.getNarratorText(r),r.classNames=["onRampButton"],r.suppressed=!0,r}shouldLogMsbQfDebugTimestamps(){return n.msbHost.isMsbInternalTenant()&&n.config.logMsbQfDebugTimestampsMs||!n.msbHost.isMsbInternalTenant()&&n.config.logMsbQfDebugTimestampsNonMs}logMsbQfTokenReadyTimeStamps(){const t=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.CQFDebugInfo;if((t===null||t===void 0?void 0:t.debugTimeStamps)&&this.initCvId===n.Host.getConversationId()){const n=Object.assign({WorkerScriptLoad:0,WorkerLoad:0,HostScriptLoad:0,WorkerLoadReceiveQf:0,wsbScriptLoad:this.msbQfUtilsLoadTime,qfLoadTrigger:this.wsbAadReadyNotifiedTime},t.debugTimeStamps);bfbWsbTel.logValue("ClientQFTokenReadyTimeStamps",JSON.stringify(n))}}logMsbQfReadyTimeStamps(t){const i=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.CQFDebugInfo;if((i===null||i===void 0?void 0:i.debugTimeStamps)&&this.initCvId===n.Host.getConversationId()){const n=Object.assign({tokenSetWsb:t,WorkerScriptLoad:0,WorkerLoad:0,HostScriptLoad:0,WorkerLoadReceiveQf:0,onInitialize:0,onInitializeReceiveQf:0,wsbScriptLoad:this.msbQfUtilsLoadTime,qfLoadTrigger:this.wsbAadReadyNotifiedTime},i.debugTimeStamps);bfbWsbTel.logValue("ClientQFReadyTimeStamps",JSON.stringify(n))}}setMsbMruSuggestionProperties(t,i){var r;this.setIconForMsbMruSuggestion(t,i);t.click=()=>{var r,u,f,e;t.type==="MFIL"?n.launchDocument((r=i.url)!==null&&r!==void 0?r:"",(u=i.webUrl)!==null&&u!==void 0?u:"",(f=i.fileExtension)!==null&&f!==void 0?f:""):n.config.msbMruRedirectToBingWorkVerticalEnabled?n.config.msbEnableProactiveSearchTransfers?(e=n.msbHost.proactiveSearchManager)===null||e===void 0?void 0:e.launchProactiveWorkSearchAsync({query:t.query,intent:"None",entityId:"",formCode:n.MSB_WORK_SCOPE_SUGGESTION_FORM_CODE}):n.msbHost.urlUtils.buildBfbSearchUrlAsync({query:t.query,intent:"None",entityId:"",formCode:n.MSB_WORK_SCOPE_SUGGESTION_FORM_CODE}).then(t=>n.Host.launchUrlWithEdgeProtocolAsync(t,{medium:"MSBLink"})):n.Host.switchToScope(n.Scope.Work,t.query)};t.narratorText=n.getNarratorText(t);t.tooltip=(r=t.tooltip)!==null&&r!==void 0?r:t.text}setIconForMsbMruSuggestion(t,i){switch(t.type){case"MGRP":case"MPPL":{const r=n.msbHost.dataAccess.getDefaultIcon(t.query);t.getIcon=n.msbHost.dataAccess.createGetPersonIcon(i.id,!0,r);t.icon=r;break}case"MBKS":t.icon=n.msbHost.dataAccess.getFluentBookmarkIcon();break;case"MQNA":t.getIcon=n.msbHost.dataAccess.getMsbQnaIcon;t.icon=n.msbHost.dataAccess.getDefaultIcon(t.query);break;case"MBLD":t.icon=n.msbHost.dataAccess.getLocationIcon();break;case"MFIL":{const r=n.ScopeConfig[n.Scope.Documents].icon;t.getIcon=n.getIconForTypeAsync(r,"."+i.fileExtension);t.icon=r;break}default:t.icon=n.msbHost.dataAccess.getWorkFluentIcon()}}}n.MsbQfUtils=f}(WSB||(WSB={})),function(n){function kt(t){switch(t.cacheState){case n.MsbQfCacheState.Empty:return w;case n.MsbQfCacheState.Error:return g;case n.MsbQfCacheState.Expired:return d;case n.MsbQfCacheState.Invalid:return k;case n.MsbQfCacheState.NoResults:return b;default:return rt}}function dt(t,i){return{suggestionConfidenceOptions:r(),serverSuggestionOptions:gt(),domains:ti(t,i),count:t?n.config.msbQfResultsCountL1ForFile:n.config.msbQfResultsCountL1,scope:"All"}}function r(){return{domainOptions:{["Person"]:{spaceInTheMiddleRequired:!1,minimumMatchCount:n.config.msbMinMatchPerson||t},["Bookmark"]:{minimumMatchCount:n.config.msbMinMatchBookmark||t},["Acronym"]:{minimumMatchCount:n.config.msbMinMatchAcronym||t},["Building"]:{minimumMatchCount:n.config.msbMinMatchBuilding||t},["Group"]:{minimumMatchCount:n.config.msbMinMatchGroup||t},["Qna"]:{minimumMatchCount:n.config.msbMinMatchQna||t},["File"]:{minimumMatchCount:n.config.msbMinMatchFile||t}},ignoreChars:"parenDash",domainTriggerOptions:{["Person"]:{minimumMatchCount:n.config.msbTGOMinMatchPerson||i},["Bookmark"]:{minimumMatchCount:n.config.msbTGOMinMatchBookmark||i},["Acronym"]:{minimumMatchCount:n.config.msbTGOMinMatchAcronym||i},["Building"]:{minimumMatchCount:n.config.msbTGOMinMatchBuilding||i},["Group"]:{minimumMatchCount:n.config.msbTGOMinMatchGroup||i},["Qna"]:{minimumMatchCount:n.config.msbTGOMinMatchQna||i},["File"]:{minimumMatchCount:n.config.msbTGOMinMatchFile||i}}}}function gt(){const t=r().domainOptions;let n=Number.MAX_VALUE;for(const i in t)n=t[i].minimumMatchCount<n?t[i].minimumMatchCount:n;return{minimumQueryLength:n}}function ni(t){return t.isSearchHomeZI?n.msbHost.isEduTenant()?bt:wt:!n.isL2(t)||n.msbHost.isWorkScope(undefined,t===null||t===void 0?void 0:t.scope)?dt(n.msbHost.qfUtils.isMsbFileReady(),n.msbHost.qfUtils.isMsbAcronymReady()):t.scope===n.Scope.People?vt:t.scope===n.Scope.Web?yt:t.scope===n.Scope.Documents?pt:undefined}function ti(t,i){let r=["Person","Bookmark","Group","Qna"];return n.config.msbDisableBuilding||r.push("Building"),t&&r.push("File"),i&&r.push("Acronym"),r}function ii(){switch(n.config.msbQwsDomains){case 0:return["Person","Bookmark"];case 2:return["Bookmark"];case 1:return["Person"];default:return["Person","Bookmark"]}}function ri(){return["Bookmark"]}function ui(){let t=["Bookmark","Qna"];return n.config.msbDisableBuilding||t.push("Building"),t}function fi(){return["File"]}function ei(n){return n.length>0&&(n.toLowerCase()==="cancelled"||n.toLowerCase()==="time out")?n:"unknown"}function l(n){return n.length>1&&n[1].eventSource?n[1].eventSource:""}function oi(n){let t=n.length>1?n[1].returnStatus:"";return t!==undefined?t:""}function si(n){var t,i;const r=(t=n===null||n===void 0?void 0:n[1].qfStatusResult)!==null&&t!==void 0?t:"",u=(i=n===null||n===void 0?void 0:n[1].qfProviderMetrics)!==null&&i!==void 0?i:{};return[r,u]}function a(n){return n.length>1&&n[1].timestamp?n[1].timestamp:""}function v(n){return n.length>1&&n[1].dataRefreshType?n[1].dataRefreshType:""}const y="NE",u="MAAD",p="NQO",w="EREC",b="ERNC",k="ERIC",d="ERCX",g="ERCE",nt="GSF",tt="EXSF",it="ZQSF",rt="ZQUE",ut="TKNR",ft="BNR",et="CQNT",ot="CQL",st="CQNR",ht="ACCS",f="ERUK",t=6,i=6,e="msb:qf:atrdy",o="msb:qf:rdy",ct="msb:qf:sydoc",lt="msb:qf:sydoc:fail",s="msb:qf:dld",h="msb:qf:trs",c="msb:qf:trf",at="msb:qf:sts",vt={suggestionConfidenceOptions:r(),domains:["Person","Group"],count:n.config.msbQfResultsCountL2,scope:"People"},yt={suggestionConfidenceOptions:r(),domains:ui(),count:n.config.msbQfResultsCountL2,scope:"Web"},pt={suggestionConfidenceOptions:r(),domains:fi(),count:n.config.msbQfResultsCountL2,scope:"Documents"},wt={suggestionConfidenceOptions:r(),domains:ii(),count:n.config.msbQfResultsCountQws,dynamicRanking:n.config.msbEnableQwsDynamicRanking},bt={suggestionConfidenceOptions:r(),domains:ri(),count:n.config.msbQfResultsCountQws,dynamicRanking:n.config.msbEnableQwsDynamicRanking};const hi=6048e5;class ci{constructor(t,i){this.dataSource=t;this.msbTokenManager=i;this.tokenChangedFired=!1;this.clientQfReadyForAccessToken=!1;this.clientQfTokenReady=!1;this.clientQfInitTime=0;this.clientQfTokenSetTime=0;this.accountChanging=!1;this.accountSwitching=!1;this.logId=`${this.getName()}[${this.dataSource}]`;this.msbDataModule=_w.BingAtWork;n.msbHost.qfUtils.clearIsMsbClientQfTokenReady();n.config.msbEnableAccountManager?n.msbHost.accountManager.bindAccountStatusChanged(async n=>{n.changeType==="AccountSwitchStarted"?this.accountSwitching=!0:n.changeType==="AuthInfoDone"&&(this.accountSwitching=!1,this.checkAllowedAadUser()&&(this.tokenChangedFired=!0,this.updateClientQfAccessToken()))}):(n.Host.bindAccountChanged(()=>{this.accountChanging=n.config.msbEnableMultiAad?!0:!1,n.msbHost.qfUtils.setQuickWorkSearchCache(undefined)}),this.msbTokenManager.bindTokenChanged(()=>{this.tokenChangedFired=!0,this.updateClientQfAccessToken()}));const r=()=>{this.clientQfReadyForAccessToken=!0,this.updateClientQfAccessToken(),n.msbHost.qfUtils.shouldLogMsbQfDebugTimestamps()&&n.msbHost.qfUtils.logMsbQfTokenReadyTimeStamps(),sj_evt.unbind(e,r)};if(sj_evt.bind(e,r,!0,undefined,!0),n.msbHost.qfUtils.shouldLogMsbQfDebugTimestamps()){const t=()=>{n.msbHost.qfUtils.logMsbQfReadyTimeStamps(this.clientQfTokenSetTime),sj_evt.unbind(o,t)};sj_evt.bind(o,t,!0,undefined,!0)}const p=t=>{const i=l(t);n.msbHost.qfUtils.setClientQfSyncDocEventFired(!0,i)};sj_evt.bind(ct,p,!0,undefined,!0);const w=t=>{const i=l(t);n.msbHost.qfUtils.setClientQfSyncDocEventFired(!1,i)};sj_evt.bind(lt,w,!0,undefined,!0);const u=t=>{const r=a(t),i=v(t);n.msbHost.qfUtils.sendClientQFTrieRefreshStartedEventFired(r,i);sj_evt.unbind(h,u)};sj_evt.bind(h,u,!0,undefined,!0);const f=t=>{const i=oi(t),u=a(t),r=v(t);n.msbHost.qfUtils.sendClientQFTrieRefreshFinishedEventFired(i,u,r);sj_evt.unbind(c,f)};sj_evt.bind(c,f,!0,undefined,!0);const b=t=>{const[i,r]=si(t);n.msbHost.qfUtils.setClientQfStatusMessage(i);n.msbHost.qfUtils.sendClientQfProviderMetrics(r)};sj_evt.bind(at,b,!0,undefined,!0);const y=()=>{this.setLogClintQFDelay(),sj_evt.unbind(s,y)};sj_evt.bind(s,y,!0,undefined,!0);n.config.msbQwsCleanCache&&n.LightweightStorage.removeItemsWithKeyPrefix(n.QuickWorkSearchCacheStorageKey)}getName(){return"MsbClientQfDataProvider"}fetch(t,i,r,e,o){var l;let v=this.checkAllowedAadUser();if(n.config.msbEnableDeltaSync&&n.msbHost.qfUtils.isClientQfReady()&&t.isSearchHomeZI&&this.clientQfTokenReady&&!this.accountChanging&&(!n.config.msbEnableAccountManager||!this.accountSwitching)&&this.initDeltaSyncCall(),!n.isDataSourceEnabled(this.dataSource,t)){if(t.isSearchHomeZI&&n.msbHost.features.isQwsEnabled()&&n.isMiniSerpEnabled()&&n.msbHost.features.isAuthLogEnabled()){let t=n.msbHost.shouldForceEnterprise(),i=t&&!n.msbHost.qfUtils.getIsMsbClientQfTokenReady();const r=t?i?"Token not ready":"No cached result":"Not force enterprise account";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search data source disabled",r)}return}if(n.config.msbEnableAccountManager&&this.accountSwitching){i(this.dataSource,undefined,ht);return}if(n.config.msbEnableMultiAad&&this.accountChanging){this.accountChanging=!1;i(this.dataSource,undefined,u);return}if(!n.config.msbEnableMultiAad&&!v){_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search disabled from multiAad","Not allowedAadUser");i(this.dataSource,undefined,u);return}let s={isCachedResultsReturned:!1},c;const h=(r,u,f,e,o,s)=>{t.isSearchHomeZI&&(n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.SearchHomeQueryReturned,c)),i(r,u,f,e,o,s)};if(t.isSearchHomeZI&&n.msbHost.features.isQwsCacheEnabled()&&!(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbSHNoClientQf)){n.msbPerfLogger&&(typeof this.lastShZiPerfMarkCallId=="undefined"&&(this.lastShZiPerfMarkCallId=0),c=this.lastShZiPerfMarkCallId++,n.msbPerfLogger.mark(n.MsbPerfProbe.SearchHomeQueryStarted,c));const t=n.msbHost.qfUtils.getQuickWorkSearchCache();if(t){let i;try{i=JSON.parse(t)}catch(r){const i=`[MSB.Error]  ${this.logId}.fetch: QWS cache is broken.
                            cacheString=${t},
                            error.message=${r===null||r===void 0?void 0:r.message}`;const u=n.msbHost.isMsbInternalTenant()?i:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search cache broken","",{additionalMessage:u});s.cacheState=n.MsbQfCacheState.Error;n.msbHost.qfUtils.setQuickWorkSearchCache(undefined)}if(i)if(n.getCurrentTime()-i.lastUpdatedTime<hi){const t=((l=i.results)===null||l===void 0?void 0:l.length)>0;t?(h(this.dataSource,i.results,undefined),s.isCachedResultsReturned=!0,s.cacheState=n.MsbQfCacheState.ValidResults):(s.cacheState=n.MsbQfCacheState.NoResults,n.msbHost.features.isAuthLogEnabled()&&_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work return empty suggestions from cache"))}else s.cacheState=n.MsbQfCacheState.Expired,n.msbHost.qfUtils.setQuickWorkSearchCache(undefined);else s.cacheState!=n.MsbQfCacheState.Error&&(s.cacheState=n.MsbQfCacheState.Invalid)}else s.cacheState=n.MsbQfCacheState.Empty}if(!n.msbHost.isTenantMsbEnabled()){s.isCachedResultsReturned||(t.isSearchHomeZI&&n.msbHost.features.isAuthLogEnabled()&&_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search tenant not enabled",s.cacheState),h(this.dataSource,undefined,y));return}if(!(n.msbHost.qfUtils.isClientQfReady()&&(this.clientQfTokenReady||n.msbHost.qfUtils.isMsbQfInScriptsEarlyLoadState())||n.MockUrlParameters)){if(!s.isCachedResultsReturned){let i=this.getErrorStateFromMsbQfState();if(i===f&&(i=ut),h(this.dataSource,undefined,i),n.msbHost.features.isAuthLogEnabled()){const n=t.isSearchHomeZI?"SearchHome":"NotSearchHome";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb no suggestions in cold start",s.cacheState,{additionalMessage:n})}}return}const a=ni(t);if(!a){s.isCachedResultsReturned||h(this.dataSource,undefined,p);return}this.clientQfTokenReady&&!n.config.msbEnableAccountManager&&this.msbTokenManager.refreshMsbTokenAndCall(()=>{},undefined,(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbClientQfDataProvider::fetch"]:undefined,"MsbClientQfDataProvider:fetch");this.fetchSuggestionsWithServerBackfill(t,h,o,a,s,c)}fetchSuggestionsWithServerBackfill(t,i,r,u,f,e){const o={isFirstStageProcessed:!1,enoughSuggestionsReceived:!1};t.isSearchHomeZI?n.MockUrlParameters&&typeof n.MockQwsResponse=="object"?this.processClientQwsResponse(n.MockQwsResponse,i,r,f):(n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.SearchHomeQueryRequested,e),this.msbDataModule.getZeroQfSuggestions(t=>{if(n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.SearchHomeQueryResponded,e),(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbSHNoClientQf)&&(t=[]),n.msbHost.features.isQwsCacheEnabled()){if(f.isCachedResultsReturned||this.processClientQwsResponse(t,i,r,f),t.length>0){const i={results:t,lastUpdatedTime:n.getCurrentTime()};n.msbHost.qfUtils.setQuickWorkSearchCache(JSON.stringify(i))}}else this.processClientQwsResponse(t,i,r,f)},t=>{const u=JSON.stringify(t);const e=n.msbHost.isMsbInternalTenant()?u:ei(u);_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search fetch threw error",f.cacheState,{additionalMessage:e});f.isCachedResultsReturned||this.processClientQwsResponse([],i,r,f,!0)},u)):((t.scope===n.Scope.People||n.config.msbExtraSuggestionsOrCallbackLogEnabled)&&this.msbDataModule.getExtraSuggestions(t.queryToFetch,n=>{this.processClientQfResponseTwoStage(t,n,i,o,r,u)},n=>{this.processClientQfResponseTwoStage(t,[],i,o,r,u,tt)}),this.msbDataModule.getSuggestions(t.queryToFetch,n=>{this.processClientQfResponseTwoStage(t,n,i,o,r,u)},n=>{this.processClientQfResponseTwoStage(t,[],i,o,r,u,nt)},Object.assign(Object.assign({},u),{impressionGuid:_G.IG,isWsb:!0})))}processClientQfResponseTwoStage(t,i,r,u,f,e,o){const s=n.msbHost.qfUtils.isWaitForBackfillEnabled(t===null||t===void 0?void 0:t.scope);if(f()&&!u.enoughSuggestionsReceived&&(!u.isFirstStageProcessed||s)){i||(i=[]);u.enoughSuggestionsReceived=!!(e.count&&i.length>=e.count);const c=!(u.enoughSuggestionsReceived||u.isFirstStageProcessed||!s);try{r(this.dataSource,i,o,0,!1,c)}catch(h){n.config.msbExtraSuggestionsOrCallbackLogEnabled&&_w.bfbWsbTel&&bfbWsbTel.logError("WSB MSBC QF Response Callback Failed",n.stringifyError(h))}finally{u.isFirstStageProcessed=!0}}}processClientQwsResponse(t,i,r,u,f){if(r()){t||(t=[]);let e;t.length===0&&(e=f?it:kt(u),n.msbHost.features.isAuthLogEnabled()&&_w.bfbWsbTel&&!f&&bfbWsbTel.logError("Wsb quick work search return empty suggestions",u.cacheState));i(this.dataSource,t,e,0,!1,!1)}}setLogClintQFDelay(){const t=n.getCurrentTime()-this.clientQfInitTime;n.config.msbEnableClientQFDelayLog&&bfbWsbTel.logValue("ClientQFDelay",t)}updateClientQfAccessToken(){var t,i;if(this.clientQfInitTime==0&&(this.clientQfInitTime=n.getCurrentTime()),this.tokenChangedFired&&this.clientQfReadyForAccessToken&&n.msbHost.isTenantMsbEnabled()){const r=n.config.msbEnableAccountManager?(i=(t=n.msbHost.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.authInfo.data)===null||i===void 0?void 0:i.msbToken:this.msbTokenManager.getMsbToken();r&&(this.clientQfTokenSetTime===0&&(this.clientQfTokenSetTime=n.getCurrentTime()),this.msbDataModule.setAccessToken(r,()=>{this.clientQfTokenReady=!0,n.msbHost.qfUtils.setIsMsbClientQfTokenReady(!0)},n=>{}))}}initDeltaSyncCall(){n.config.msbEnableAccountManager?n.msbHost.accountManager.refreshMsbTokenAsync().then(()=>{this.msbDataModule.initDeltaSyncCall(!1,()=>{},n=>{})}).catch(t=>{}):this.msbTokenManager.refreshMsbTokenAndCall(()=>{this.msbDataModule.initDeltaSyncCall(!1,()=>{},n=>{})},()=>{},(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbClientQfDataProvider::initDeltaSyncCall"]:undefined,"InitDeltaSyncCall")}checkAllowedAadUser(){var t;const i=n.config.msbEnableAccountManager?(t=n.msbHost.accountManager.getCurrentAccount())===null||t===void 0?void 0:t.accountId:this.msbTokenManager.getSelectedAccountId();return!this.allowedAadId&&n.msbHost.isTenantMsbEnabled()?(this.allowedAadId=i,!0):this.allowedAadId==i}getErrorStateFromMsbQfState(){let t=f,i=n.msbHost.qfUtils.getMsbClientQfState();return i==="BingAtWorkNotReady"?t=ft:i==="NotReady"?t=st:i==="QfLoadNotTriggered"?t=et:i==="QfLoading"&&(t=ot),t}}n.MsbClientQfDataProvider=ci}(WSB||(WSB={})),function(n){const r=n.mapOSFormCode("BFBWSL"),t=1,u=.6,f=2,e=4,o=4,i={["Person"]:"MPPL",["Group"]:"MGRP",["Bookmark"]:"MBKS",["Building"]:"MBLD",["Qna"]:"MQNA",["File"]:"MFIL",["Acronym"]:"MACR"},s=25;class h{constructor(n){this.msbDataAccess=n}parse(t,i,r,u,f,e){if(n.isDataSourceEnabled(r,t)){if(!u||u.length<1){e(r,[],{});return}const s=this.pickUpClientQfResults(t,u),o=this.createClientQfSuggestionsFor(t,i,s);if(t.isSearchHomeZI&&t.scope===n.Scope.All&&(o===null||o===void 0?void 0:o.length)>0){const n=this.getSHComponents(o);_w.bfbWsbTel&&bfbWsbTel.logSearchHomeImpression(n)}e(r,o,{})}}getSHComponents(n){let t=[];return n.findIndex(n=>n.msbDomain==="Person")>-1&&t.push("People"),n.findIndex(n=>n.msbDomain==="Bookmark")>-1&&t.push("Bookmarks"),t.join("_")}setRankingValues(n,t,i){n.suggestionLogMeta=`40000:"${t}";40001:"${i}"`}createMsbSuggestion(t,r,u,f,e,o,s,h,c,l,a,v,y,p,w){const k=i[s],d=t.isSearchHomeZI?r:HitHighlightingParser.addMarkers(r,t.originalQuery);let b=n.createSuggestion(t,d,f,e,k,r,n.InstrumentedItem.createInstrumentedItem(o,k),17,o,!0);return u&&(b.autoOpenPreviewPaneWhenOnTopHit=!0,b.allowedInGroups=!0),c&&(b.primaryMetadata=c),b.previewCallback=a,b.click=this.isQwsRequerysEnabled(t)?()=>{this.reformulateOnQwsSuggestionClick(t,r,s)}:v,b.msbDomain=s,b.msbId=h,b.reactKey=k+s+h,b.classNames.push(...l),b.additionalInfoText=y,b.groupDisplayName=p,b.sourceForGroup=w,b.narratorText=r,t.isSearchHomeZI&&n.msbHost.features.isQwsTopListEnabled()&&k=="MPPL"&&this.adjustPersonName(b),n.msbHost.features.isWorkMruEnabled()&&(b.getMruData=()=>this.getMsbMruSuggestionData(b)),b}getMsbMruSuggestionData(t){return Object.assign(Object.assign({},n.getMruWebSuggestionData(t)),{id:t.msbId,fileExtension:t.fileExtension,title:t.primaryMetadata,url:t.url,webUrl:t.webUrl})}setWorkQFGroupHeaderLabel(t,i){return(!t||t&&t.length>s)&&(t=n.msbHost.isEduTenant()?n.Host.getLocString("School"):n.Host.getLocString("Work")),t+" - "+i}pickUpClientQfResults(i,r){let s=!1,h=0;const y=n.isL2(i),p=!!n.msbHost.isWorkScope(undefined,i===null||i===void 0?void 0:i.scope),l=[],c=[],a=[];let v={};for(const f of r)if((!i.isSearchHomeZI||f.domain!=="Person"||!(h>=e||n.msbHost.isEduTenant()))&&(i.scope!=n.Scope.All||f.domain!=="Person"||!(h>=o))&&(f.domain!=="Group"||f.identifiers!=null&&f.identifiers.uniqueName!=null)&&(f.domain!=="File"||f.identifiers.url!=null||f.identifiers.webUrl!=null)){if(f.confidence==="High"){s=!0;const n=!v[f.domain],i={msbSuggestion:f,isHero:(!y||p)&&n,score:t};v[f.domain]=!0;n?l.push(i):a.push(i)}else{s||f.confidence==null||(s=!0);const n={msbSuggestion:f,isHero:!1,score:u};c.push(n)}f.domain==="Person"&&h++}if(!s)for(let n=0;n<f;n++){const i=c[n];i&&(i.isHero=!0,i.score=t)}return[...l,...a,...c]}createClientQfSuggestionsFor(n,t,i){const r=[];for(let u=0;u<i.length;u++){const f=i[u],e=this.buildClientQfSuggestion(n,t,f);this.setRankingValues(e,u,f.score);r.push(e)}return r}buildClientQfSuggestion(t,i,u){const{msbSuggestion:f,isHero:k}=u,a=f.query,d=t.scope===n.Scope.Work;let v=f.query,h,o,w=["fbig"],s=()=>{},y=f.title,b=undefined,e=undefined,p;const c=async({intent:i,entityId:t})=>{var u,e;const s=n.msbHost.urlUtils.getTransferIg();_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(f.domain,{transferIg:s});_w.bfbWsbTel&&bfbWsbTel.log3SClickedEvent("QueryFormulation_Click",(u=window===null||window===void 0?void 0:window._G)===null||u===void 0?void 0:u.IG);const o=d?n.MSB_WORK_SCOPE_SUGGESTION_FORM_CODE:r;n.config.msbEnableProactiveSearchTransfers?(e=n.msbHost.proactiveSearchManager)===null||e===void 0?void 0:e.launchProactiveWorkSearchAsync({query:v,intent:i,entityId:t,formCode:o}):n.msbHost.urlUtils.buildBfbSearchUrlAsync({query:v,intent:i,entityId:t,formCode:o}).then(t=>n.Host.launchUrlWithEdgeProtocolAsync(t,{medium:"MSBLink"}))};switch(f.domain){case"Bookmark":{o=n.msbHost.dataAccess.getBookmarkIcon();const i=f.identifiers;s=()=>{var t;_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(f.domain);_w.bfbWsbTel&&bfbWsbTel.log3SClickedEvent("QueryFormulation_Click",(t=window===null||window===void 0?void 0:window._G)===null||t===void 0?void 0:t.IG);n.Host.launchUrlWithEdgeProtocolAsync(i.url,{medium:"MSBLink"})};t.isSearchHomeZI||(e=this.setDefaultGroupDisplayName());break}case"Person":{const i=n.msbHost.dataAccess.getDefaultIcon(a);h=n.msbHost.dataAccess.createGetPersonIcon(f.id,!0,i);o=i;w.push("msb-people");const r=f.identifiers;s=()=>c({intent:"Person",entityId:r.uniqueName});n.isL2(t)&&(p=6);t.isSearchHomeZI||(e=this.setWorkQFGroupHeaderLabel(n.SubstrateTenantName,n.getScopeDisplayName(n.ScopeConfig[n.Scope.People])));break}case"Group":{const i=n.msbHost.dataAccess.getDefaultIcon(a);h=n.msbHost.dataAccess.createGetPersonIcon(f.id,!1,i);o=i;w.push("msb-people");const r=f.identifiers;s=()=>c({intent:"Group",entityId:r.uniqueName});e=this.setWorkQFGroupHeaderLabel(n.SubstrateTenantName,n.getScopeDisplayName(n.ScopeConfig[n.Scope.People]));n.isL2(t)&&(p=5);break}case"Building":o=n.msbHost.dataAccess.getLocationIcon();s=()=>c({intent:"Building"});t.isSearchHomeZI||(e=this.setDefaultGroupDisplayName());break;case"Qna":{const i=n.msbHost.dataAccess.getDefaultIcon(a);h=n.msbHost.dataAccess.getMsbQnaIcon;o=i;s=()=>c({intent:"Qna"});t.isSearchHomeZI||(e=this.setDefaultGroupDisplayName());break}case"File":{const i=n.ScopeConfig[n.Scope.Documents].icon,r=f.identifiers,t=f,u=n.SubstrateTenantName||"";o=i;h=n.getIconForTypeAsync(i,"."+t.fileExtension);(t.fileExtension=="loop"||t.fileExtension=="fluid")&&(h=undefined,o=n.toIcon("https://www.bing.com/office/loop32x32.svg","getDefaultIcon"));s=()=>{var i,u,e;_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(f.domain);_w.bfbWsbTel&&bfbWsbTel.log3SClickedEvent("QueryFormulation_Click",(i=window===null||window===void 0?void 0:window._G)===null||i===void 0?void 0:i.IG);n.launchDocument(r.url,(u=r.webUrl)!==null&&u!==void 0?u:"",(e=t.fileExtension)!==null&&e!==void 0?e:"")};p=7;e=this.setWorkQFGroupHeaderLabel(u,n.getScopeDisplayName(n.ScopeConfig[n.Scope.Documents]));break}case"Acronym":{const i=n.msbHost.dataAccess.getAcronymIcon();v=`define ${v.replace(/\s/g,"")}`;o=i;s=()=>c({intent:"Acronym"});t.isSearchHomeZI||(e=this.setDefaultGroupDisplayName());y&&(y=n.Host.getLocString("AcronymTopHitSecondaryText",y));b=" - "+n.Host.getLocString("AcronymNonTopHitAdditionalInfoText");break}}let g=(i,r,u)=>{const e=this.getQueryText(f);if(f.domain==="File"){if(!(u===null||u===void 0?void 0:u(f.id,f.domain)))return;const n=f;n.locationPath=l.parentFolder;this.msbDataAccess.fireClientQfResponse(e,n,t===null||t===void 0?void 0:t.scope);i===null||i===void 0?void 0:i();return}n.config.msbEnableAccountManager?this.msbDataAccess.fetchSearchResponseAsync(e,f.domain,t===null||t===void 0?void 0:t.scope).then(n=>{(u===null||u===void 0?void 0:u(f.id,f.domain))&&(this.msbDataAccess.fireSearchResponse(e,f.query,n),i===null||i===void 0?void 0:i())}).catch(()=>{const t=n.msbHost.isMsbInternalTenant()?`fetchSearchResponseAsync: previewpane suggestion of ${e}, domain: ${f.domain} failed`:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Preview Pane 3s Fetch Failed",t);r===null||r===void 0?void 0:r(f.query)}):this.msbDataAccess.fetchSearchResponse(e,f.domain,n=>{(u===null||u===void 0?void 0:u(f.id,f.domain))&&(this.msbDataAccess.fireSearchResponse(e,f.query,n),i===null||i===void 0?void 0:i())},()=>{const t=n.msbHost.isMsbInternalTenant()?`fetchSearchResponse: previewpane suggestion of ${e}, domain: ${f.domain} is not returned currently`:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Preview Pane 3s Fetch Failed",t);r===null||r===void 0?void 0:r(f.query)},t===null||t===void 0?void 0:t.scope);n.msbHost.checkMidgardLanguage()},l=this.createMsbSuggestion(t,a,k,h,o,i,f.domain,f.id,y,w,g,s,b,e!==null&&e!==void 0?e:"",p);return f.domain==="File"&&this.updateFileSuggestion(t,f,l),n.isL2(t)&&t.scope===n.Scope.People&&(l.template=1,l.classNames.push("people","topResultTemplateInGroups")),l}getProvenance(n){if(!n.source)return undefined;switch(n.source.toLocaleLowerCase()){case"onedriveforbusiness":return"OneDriveBusiness";case"sharepoint":default:return"SharePoint"}}updateFileSuggestion(t,i,r){var e,o,s;if(r.classNames.push("fbig"),r.author=i.author,i.timestamp&&(r.lastAccessDate=n.toDate(i.timestamp)),r.lastModifiedBy=i.lastModifiedBy,i.lastModifiedTime&&(r.lastModifiedDate=n.toDate(i.lastModifiedTime)),r.url=(e=i.identifiers&&i.identifiers.url)!==null&&e!==void 0?e:"",r.webUrl=((o=i.identifiers)===null||o===void 0?void 0:o.webUrl)||"",r.siteTitle=(s=i.title)!==null&&s!==void 0?s:"",i.fileExtension){r.fileExtension=i.fileExtension;const n=`.${i.fileExtension}`;r.extensionLC=n.toLocaleLowerCase();r.query.endsWith(n)||(r.query=r.query+n);r.text!==r.query&&(r.text=r.query)}const c=this.getProvenance(i);n.setDocumentLocationProperties(r,i.query,c,!1);const u=r.author,f=r.lastModifiedBy,h=n.getEffectiveQuery(t);n.matchesOnPropertyHH(u,h)?r.match=n.createMatch(n.MatchType.Author,u!==null&&u!==void 0?u:""):n.matchesOnPropertyHH(f,h)&&(r.match=n.createMatch(n.MatchType.LastModifiedBy,f!==null&&f!==void 0?f:""));n.setFileTemplate(t,h,n.isL2(t),r)}reformulateOnQwsSuggestionClick(t,r,u){var f,e;const c=n.msbHost.features.isWorkScopeSHRedirectEnabled(),o=c?((e=(f=n.ScopeConfig===null||n.ScopeConfig===void 0?void 0:n.ScopeConfig[n.Scope.Work])===null||f===void 0?void 0:f.prefixes)===null||e===void 0?void 0:e[0])||"Work":"";let l=o?`${o}: ${r}`:r,s=i[u];const h=u==="Person"?"People":"Bookmarks";_w.bfbWsbTel&&bfbWsbTel.logSearchHomeClick(h,{redirectTo:n.msbHost.mapRedirectTarget(h)});n.msbHost.substrateLogger.logSearchEntityActions("Wsb.SearchHome");n.Host.reformulateNonForcedMiniSerp(l,t.isSearchHomeZI,s);n.Host.setFocusInSearchBox(null,`${s}.click`)}isQwsRequerysEnabled(t){return t.isSearchHomeZI&&n.msbHost.features.isQwsEnabled()&&n.config.msbEnableQwsRequery}getQueryText(n){let t=n.query;switch(n.domain){case"Person":case"Group":t=n.identifiers&&n.identifiers.uniqueName||t;break;case"File":const i=n;t=t+"."+i.fileExtension}return t}adjustPersonName(t){const i=n.getFirstAndLastName(t.text);if(i){const{firstName:n,lastName:r}=i;t.text=n;t.additionalInfoText=r}}setDefaultGroupDisplayName(){const t=n.SubstrateTenantName||"";return this.setWorkQFGroupHeaderLabel(t,n.Host.getLocString("ResultsList"))}}n.MsbQfSuggestionsParser=h}(WSB||(WSB={})),function(n){const t="QWQS",i="QMAD";class r{getName(){return"MsbQuickWorkQueriesDataProvider"}constructor(){this.accountChanging=!1;this.hasEduAssignments=!1;n.Host.bindAccountChanged(()=>{this.accountChanging=n.config.msbEnableMultiAad?!0:!1,this.hasEduAssignments=!1})}fetch(r,u){var f;if(r===null||r===void 0?void 0:r.enabledDataSources[t]){if(this.accountChanging){this.accountChanging=!1;u(t,undefined,i,undefined,undefined,!0);this.fetch(r,u);return}let e;this.hasEduAssignments=n.config.msbQwqsForceNonLMS?!1:(f=n.msbHost.hasEduAssignments())!==null&&f!==void 0?f:!1;let o=this.getQuickWorkQueryKeys();e=this.createQuickWorkSearchResponse(o);u(t,e)}}getQuickWorkQueryKeys(){return this.hasEduAssignments?(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isEduMessagesCardEnabled())?n.config.msbQwqsLmsQuickWorkQueryMessagesCardEnabledKeys:n.config.msbQwqsLmsQuickWorkQueryKeys:(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isEduMessagesCardEnabled())?n.config.msbQwqsDefaultQuickWorkQueryMessagesCardEnabledKeys:n.config.msbQwqsDefaultQuickWorkQueryKeys}createQuickWorkSearchResponse(n){let i=[],t=Object.keys(n);t&&t.length>0&&t.forEach(t=>{let r=this.getQuickWorkSearchSuggestion(t,n[t]);r&&i.push(r)});return{suggestions:i,isLms:this.hasEduAssignments}}getQuickWorkSearchSuggestion(t,i){if(!t)return undefined;let r=n.Host.getLocString(t),u=n.Host.getLocString(i);if(!t)return undefined;return{displayText:u,displayTextKey:i,query:r,queryKey:t}}}n.MsbQuickWorkQueriesDataProvider=r}(WSB||(WSB={})),function(n){const i="qwqs-lms",r="qwqs-wrkq",u="qwqs-wrkqm",t=n.mapOSFormCode("BFBQWQ");class f{constructor(n,t){this.accessTokenManager=n;this.substrateProfilePictureProvider=t}parse(t,f,e,o,s,h){if(!o||!o.suggestions||o.suggestions.length<1){h(e,[],{});return}let c=[],l={};o.suggestions.forEach((e,s)=>{let a=this.getSuggestionType(e===null||e===void 0?void 0:e.queryKey),h=n.createSuggestion(t,e===null||e===void 0?void 0:e.displayText,this.retrieveGetIcon(e===null||e===void 0?void 0:e.queryKey),this.getIcon(e===null||e===void 0?void 0:e.queryKey),a,e===null||e===void 0?void 0:e.query,n.InstrumentedItem.createInstrumentedItem(f,a),17,f,!1);h.tooltip=e===null||e===void 0?void 0:e.displayText;o.isLms&&h.classNames.push(i);n.config.msbEduMessagesCardEnabled?h.classNames.push(u):h.classNames.push(r);h.reactKey="qwqs"+(e===null||e===void 0?void 0:e.query)+s;h.click=()=>this.onSuggestionClick(e,a);c.push(h);l[this.getEduSearchHomeComponent(e)]=!0});const a=Object.keys(l);t.isSearchHomeZI&&a.length>0&&_w.bfbWsbTel&&bfbWsbTel.logSearchHomeImpression(a.sort().join("_"));h(e,c,{})}onSuggestionClick(i){var r;const u=n.msbHost.urlUtils.getTransferIg();_w.bfbWsbTel&&bfbWsbTel.logSearchHomeClick(n.Host.getEnUsLocString(i===null||i===void 0?void 0:i.displayTextKey),{transferIg:u});n.msbHost.substrateLogger.logSearchEntityActions("Wsb.SearchHome");n.config.msbQwqsEnableWsbClickTarget?n.Host.switchToScope(n.Scope.Work,i===null||i===void 0?void 0:i.query):n.config.msbEnableProactiveSearchTransfers?(r=n.msbHost.proactiveSearchManager)===null||r===void 0?void 0:r.launchProactiveWorkSearchAsync({query:i===null||i===void 0?void 0:i.query,intent:"AllResults",formCode:t,verticalHash:(i===null||i===void 0?void 0:i.queryKey)==="MsbQwqsMessagesKey"?"Message-conversations":undefined}):n.msbHost.urlUtils.buildBfbSearchUrlAsync({query:i===null||i===void 0?void 0:i.query,intent:"AllResults",formCode:t}).then(t=>n.Host.launchUrlWithEdgeProtocolAsync((i===null||i===void 0?void 0:i.queryKey)==="MsbQwqsMessagesKey"?n.msbHost.urlUtils.appendHash(t,"Message-conversations"):t,{medium:"MSBLink"}))}getIcon(t){if(!t)return undefined;switch(t){case"MsbQwqsAssignmentsKey":return{type:0,content:n.ASSIGNMENTS_SVG_URL};case"MsbQwqsClassesKey":return{type:0,content:n.CLASSES_SVG_URL};case"MsbQwqsFilesKey":return{type:0,content:n.FILES_SVG_URL};case"MsbQwqsMessagesKey":return{type:0,content:n.MESSAGES_SVG_URL};case"MsbQwqsCalendarKey":return{type:0,content:n.CALENDAR_SVG_URL};case"MsbQwqsMyProfileKey":let t=this.getSelectedAccount();return t&&t.accountUserName?this.substrateProfilePictureProvider.getPersonDefaultIcon(t.accountUserName):undefined;default:return n.getSearchSuggestionIcon()}}retrieveGetIcon(t){if(!t||n.config.msbEduShNoProfileIcons==!0)return undefined;switch(t){case"MsbQwqsMyProfileKey":let n=this.getSelectedAccount();if(n&&n.accountUserName){let t=this.substrateProfilePictureProvider.getPersonDefaultIcon(n.accountUserName),i=n.accountProviderAuthority=="consumers"?0:1;return this.substrateProfilePictureProvider.getProfilePictureIcon(i,n.accountUserName,t)}return undefined;default:return undefined}}getSelectedAccount(){return this.accessTokenManager.getSelectedAccountInfo((n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["HeaderFooterViewModel::getUserProfileButtonData"]:undefined)}getSuggestionType(n){switch(n){case"MsbQwqsAssignmentsKey":return"QWQA";case"MsbQwqsClassesKey":return"QWQC";default:return"QWQS"}}getEduSearchHomeComponent(n){switch(n.queryKey){case"MsbQwqsAssignmentsKey":return"Assignments";case"MsbQwqsClassesKey":return"Classes";case"MsbQwqsFilesKey":return"Files";case"MsbQwqsMessagesKey":return"Messages";case"MsbQwqsCalendarKey":return"Calendar";case"MsbQwqsMyProfileKey":return"MyProfile";default:return"Unknown"}}}n.MsbQuickWorkQueriesSuggestionsParser=f}(WSB||(WSB={})),function(n){class t{constructor(t){this.page=t;this.hasFocusValue=!1;this.readyToBlurValue=!0;this.uxCheckingTimer=null;this.uxCheckingInRetry=!1;this.keyNav=new n.XyFocusKeyNavManager(this);n.Host.bindSearchBoxGotFocus(()=>{this.blur()});n.Host.bindDismissed(()=>{window.postMessage({messageType:"MSB_FLUSH_LOGGER"},window.location.origin),_w.bfbWsbTel&&bfbWsbTel.flushLogger()});window.addEventListener("message",n=>{var t;const i=(t=n===null||n===void 0?void 0:n.data)===null||t===void 0?void 0:t.messageType;if((i==="MSB_SET_SEARCH_RESPONSE"||i==="MSB_SET_3S_QUERY_RESPONSE")&&!this.uxCheckingInRetry){const t=Object.assign({},n.data);this.checkUxRendering(t)}})}init(n){this.previewPaneViewModelParent=n}finalizeKeystroke(){}update(n,t,i,r,u,f){const e=this.previewedSuggestion,o=n;this.onPreviewPaneRendered=u;this.onPreviewPaneErrored=f;e!=null&&o!=null&&e.msbDomain===o.msbDomain&&e.msbId===o.msbId||(this.previewedSuggestion=n,this.partialQuery=t,this.keyNav.ensureInit(),this.render())}hasFocus(){return this.hasFocusValue}focus(){n.Host.setFocusInWebView("msbPP focus");this.hasFocusValue=!0;this.readyToBlurValue=!1;this.keyNav.moveFocus("down",40);this.keyNav.moveFocus("down",40)}readyToBlur(){return this.readyToBlurValue}blur(){n.Host.setFocusInSearchBox(null,"msbPP blur");this.hasFocusValue=!1}clear(){this.previewedSuggestion=null;this.partialQuery=null;this.clearUx()}getSelectableItems(){return[]}getSelectableItemsByGroup(){return[]}getSelectedItem(){return null}select(){}onAfterKeyDown(){return!1}onAfterMoveFocus(n){this.readyToBlurValue=n;n&&this.blur()}getDataModel(){return{suggestion:this.previewedSuggestion}}render(){const t=this.onPreviewPaneRendered;this.clearUx();const n=this.previewedSuggestion,i=this.getSuggestionMsbId(n),r=this.getSuggestionMsbDomain(n);if(n){const u=_ge("b_bfb");u&&u.addEventListener("click",n=>this.handleClickEvent(n));this.previewedSuggestion.previewCallback&&this.previewedSuggestion.previewCallback(()=>t(!0,!1,null),t=>this.showErrorPage(t,i,r,n.type,"CallbackError"),(n,t)=>this.isCurrentPreviewSuggestion(n,t))}}isCurrentPreviewSuggestion(n,t){const i=this.getSuggestionMsbId(this.previewedSuggestion),r=this.getSuggestionMsbDomain(this.previewedSuggestion);return n===i&&t===r}getSuggestionMsbId(n){if(n){const t=n;return t&&t.msbId}return null}getSuggestionMsbDomain(n){if(n){const t=n;return t&&t.msbDomain}return null}isMsbRendered(){const n=_d.querySelector("#b_bfb .ms-search-ribbon div[class|='contentRow']");return n!=null&&n.hasChildNodes()}clearUx(){this.clearUxCheckingTimer(!0);this.page.updateMsbPreviewContainerView(this.getDataModel())}clearUxCheckingTimer(n){this.uxCheckingTimer!=null&&(sb_ct(this.uxCheckingTimer),this.uxCheckingTimer=null);n&&(this.uxCheckingInRetry=!1)}checkUxRendering(t){const e=()=>this.isMsbRendered(),i=this.previewedSuggestion,r=n.msbHost.isMsbInternalTenant()?`${i===null||i===void 0?void 0:i.query}`:"",u=this.getSuggestionMsbId(i),f=this.getSuggestionMsbDomain(i),o=()=>{const n=`MsbPreviewPaneViewModel.checkUxRendering: UX wasn't rendered correctly for preview pane.`;_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Preview Pane UX not Rendered","",{additionalMessage:r});window.postMessage(t,window.location.origin)},s=()=>{const n=`MsbPreviewPaneViewModel.checkUxRendering: UX wasn't rendered correctly for preview pane after retry.`;_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Preview Pane UX not Rendered after Retry","",{additionalMessage:r});const t=(i===null||i===void 0?void 0:i.query)||"";this.showErrorPage(t,u,f,i===null||i===void 0?void 0:i.type,"UxError")},h=()=>this.isCurrentPreviewSuggestion(u,f);this.pollUxRenderingChecking(e,1,o,s,h)}pollUxRenderingChecking(t,i,r,u,f){this.clearUxCheckingTimer(!1);this.uxCheckingTimer=n.safeSetTimeout(()=>{f()?t()?this.uxCheckingInRetry=!1:i>0?(this.uxCheckingInRetry=!0,r(),this.pollUxRenderingChecking(t,i-1,r,u,f)):(this.uxCheckingInRetry=!1,u()):this.uxCheckingInRetry=!1},500,"MsbPreviewPaneViewModel.pollUxRenderingChecking",`retries=${i}`)}showErrorPage(t,i,r,u,f){var e;this.instrumentMsbPreviewPaneError(f,u);((e=this.partialQuery)===null||e===void 0?void 0:e.scope)===n.Scope.Work?this.isCurrentPreviewSuggestion(i,r)&&this.buildErrorPageDataModel(t):this.buildErrorPageDataModel(t)}instrumentMsbPreviewPaneError(t,i){_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Preview Pane Error Page",t);const r={Reason:t,SuggestionType:i};n.InstrumentationHelper.logClientInstEvent("ClientInst","MsbPreviewPaneRenderError",n.SequenceNumberManager.getSequenceNumber(),r)}buildErrorPageDataModel(t){let i=n.Host.getLocString("PreviewPaneErrorMessage").split("{0}"),r=[],u=n.Host.getLocString("PreviewPaneErrorMessage",t);for(let n=0;n<i.length;n++)r.push({text:i[n]});let f=()=>{n.Host.launchSearchAsync(t,t,!1)};const e={isOnline:n.isBrowserOnline(),previewPaneTitle:"",previewPaneItems:r,fullPartialQuery:t,narratorMessage:u,footerClick:f};this.onPreviewPaneErrored(e)}handleClickEvent(t){let u=n.getCurrentTime(),f=n.getInputType(t),r=10;this.previewPaneViewModelParent.onBeforeItemLaunch(u,f,r);const i=this.findBfbAnchor(t.target);i&&i.href&&(t.preventDefault(),n.Host.launchUrlWithEdgeProtocolAsync(i.href,{medium:"MSBLink"}));this.previewPaneViewModelParent.onAfterItemLaunch(r)}findBfbAnchor(n){return n?n.tagName==="a"||n.tagName==="A"?n:this.findBfbAnchor(n.parentElement):undefined}}n.MsbPreviewPaneViewModel=t}(WSB||(WSB={})),function(n){var t;(function(t){t.MsbBrandingBar=n=>{const{dataModel:r}=n;if(!r||!r.msbBranding)return null;const{backColor:u}=r.msbBranding,f={background:u},e=t.classNames("rightHeaderButtons brandingBarContainer",{"brandingBarContainer-minimal":r.isWin11DSB&&!r.areScopesVisibile});return React.createElement("div",{className:e,style:f},React.createElement(i,Object.assign({},n)))};const i=t=>{const{dataModel:u}=t,{logoDataUri:i,iconLargeIsDefault:f,companyName:e,fontColor:o,iconUrl:r}=u.msbBranding,s={color:o};return n.msbHost.isIconUrlEnabled(r)?React.createElement("img",{className:"brandingBarImage",src:r}):i&&!f?React.createElement("img",{className:"brandingBarImage",src:i}):React.createElement("span",{className:"brandingBarText",style:s},e)}})(t=n.View||(n.View={}))}(WSB||(WSB={})),function(n){var t;(function(t){t.MsbFreContainer=({dataModel:t})=>{if(!t)return null;const{userProfileButtonDataModel:u,userFirstName:f,tenantName:e}=t,o=n.Host.getLocString("MsbFreMessageText",e);return React.createElement("div",{className:"msbFreContainer"},React.createElement("div",{className:"freProfileSection"},React.createElement("div",{className:"freProfileDisplayPhotoSection"},React.createElement(r,Object.assign({},u))),React.createElement("div",{className:"freWelcomeSection"},n.Host.getLocString("MsbFreHeaderText",f)),React.createElement("div",{className:"freMessageSection"},o)),React.createElement(i,null))};const i=()=>{return React.createElement(React.Fragment,null,React.createElement("div",{className:"freExampleContainer"},React.createElement("label",{className:"freExampleHeader freContent"},n.Host.getLocString("MsbFreExampleHeaderText")),React.createElement("div",{className:"freSectionSeparation"}),React.createElement("div",{className:"freExampleSection"},React.createElement("div",{className:"entityExample"},React.createElement("div",{className:"exampleIconSection"},React.createElement(t.Icon,{icon:{content:"&#xE716",type:2,color:"#005A9E"}})),React.createElement("div",{className:"exampleInfoSection"},React.createElement("div",{className:"exampleTitle freContent"},n.Host.getLocString("MsbFrePeopleTitle")),React.createElement("div",{className:"exampleInfo freContent"},`${n.Host.getLocString("MsbFrePeopleText")} `,React.createElement("span",null,n.Host.getLocString("MsbFrePeopleSpan"))))),React.createElement("div",{className:"entityExample"},React.createElement("div",{className:"exampleIconSection"},React.createElement(t.Icon,{icon:{content:"&#xEF6C",type:2,className:"",color:"#005A9E"}})),React.createElement("div",{className:"exampleInfoSection"},React.createElement("div",{className:"exampleTitle freContent"},n.Host.getLocString("MsbFreFilesTitle")),React.createElement("div",{className:"exampleInfo freContent"},`${n.Host.getLocString("MsbFreFilesText")} `,React.createElement("span",null,n.Host.getLocString("MsbFreFilesSpan"))))),React.createElement("div",{className:"entityExample"},React.createElement("div",{className:"exampleIconSection"},React.createElement(t.Icon,{icon:{content:"&#xEB8F",type:2,color:"#005A9E"}})),React.createElement("div",{className:"exampleInfoSection"},React.createElement("div",{className:"exampleTitle freContent"},n.Host.getLocString("MsbFreLinksTitle")),React.createElement("div",{className:"exampleInfo freContent"},`${n.Host.getLocString("MsbFreLinksText")} `,React.createElement("span",null,n.Host.getLocString("MsbFreLinksSpan"))))))),React.createElement("div",{className:"arrowDown"}))},r=n=>{const{userName:i,opened:r,icon:u}=n;return React.createElement("a",{className:t.classNames("fre-people-display"),onClick:()=>{},role:"button","aria-label":i,"aria-expanded":r,"aria-haspopup":"menu","aria-controls":"frePeopleDisplay",title:i,tabIndex:-1,id:"frePeopleDisplayPhoto","data-partnertag":t.whenTestHooks("AutoSuggest.UserProfileButton")},React.createElement("span",{className:"userProfileMenuIcon"},React.createElement(t.Icon,{icon:u})))}})(t=n.View||(n.View={}))}(WSB||(WSB={}))