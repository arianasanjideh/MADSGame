var WSB;(function(n){function bu(i,r){var f,e;let u=[];if(r)if(i)u=r.slice();else if(n.config.optimizeVerbDedupeLogic){for(let n=0;n<r.length;n++){let i=(e=(f=r[n])===null||f===void 0?void 0:f.verb)===null||e===void 0?void 0:e.toLowerCase();i&&t[i]&&u.push(r[n])}u=u.sort((n,i)=>t[n.verb.toLowerCase()].order-t[i.verb.toLowerCase()].order)}else for(let n in t){let t=r.find(t=>t.verb&&t.verb.toLocaleLowerCase()==n.toLocaleLowerCase());t&&u.push(t)}return u}function ku(n){return n?n.filter(n=>!n.verb||n.verb.toLowerCase()!="open"):[]}function c(t,i,r,u,f,e){e()&&(t=t.slice(),i.getExtraVerbsAsync?n.Async.safeChain("getExtraVerbsAsync",()=>i.getExtraVerbsAsync(u),n=>g(wt(t,n,!0),i,u,f,e),()=>g(t,i,u,f,e),null,r):g(t,i,u,f,e))}function g(n,t,i,r,u){if(u()){let f=t.getExtraVerbs?wt(n,t.getExtraVerbs(i),!1):n;f[0]==ft&&f.shift();r(f)}}function du(i,r,u,f){return i.map(i=>{let e,o;if(i.verb){switch(i.verb.toLocaleLowerCase()){case hi:e="PinnedToStart";break;case st:e="PinnedToTaskbar";break;case ci:e="UnpinnedFromStart";break;case ht:e="UnpinnedFromTaskbar";break;case si:o=n.config.useCobaltCSS?"UninstallMessage":"UninstallConfirmation";e="UninstallationInProgress";break;case hu:e="PathCopied"}let s=t=>{t(),n.RuntimeConfig.AlwaysWide&&e=="UninstallationInProgress"?(r.uninstallationInProgress=!0,f&&f()):e?u.showTemporaryMessage(n.Host.getLocString(e,HitHighlightingParser.removeMarkers(r.text))):u.hideTemporaryMessage(),i.verb.toLocaleLowerCase()==st&&n.Host.addItemToPinnedToTaskbar(r.deviceItem.id),i.verb.toLocaleLowerCase()==ht&&n.Host.removeItemFromPinnedToTaskbar(r.deviceItem.id)},h=i.icon||t[i.verb.toLocaleLowerCase()];return new n.DeviceItemVerbWrapper(i,h,t=>{o&&n.DialogBox?n.DialogBox.show(n.Host.getLocString(o),[{id:null,text:i.displayName,action:()=>s(t),selected:!1,useAccentColor:n.config.useCobaltCSS?!0:!1},{id:null,text:n.Host.getLocString("Cancel"),selected:!0}],n.config.useCobaltCSS?n.Host.getLocString("UninstallConfirmationTitle",HitHighlightingParser.removeMarkers(r.text)):""):s(t)})}return i})}function di(t,i,r,u,f,e){let o=t+" "+i.type;if(n.isJumpListSuggestion(i))return n.Async.safeChain("jumpListItem.getVerbsAsync",()=>i.jumpListItem.getVerbsAsync(),n=>c(ku(n),i,o,u,f,e),()=>c([],i,o,u,f,e),null,t+" "+i.type),!0;let s=n.getItemWithFileMetadata(i);return s&&s.canHaveContextMenu?(n.Async.safeChain("item.getVerbsAsync",()=>s.getVerbsAsync(),n=>c(bu(r,n),i,o,u,f,e),()=>c([],i,o,u,f,e),null,o),!0):i.getExtraVerbsAsync?(c([],i,o,u,f,e),!0):i.getExtraVerbs?(g([],i,u,f,e),!0):(u&&f([]),!1)}function l(n,t,i){let r=HitHighlightingParser.removeMarkers(n.text),u=r?r.length:0;return n.additionalInfoText&&!i&&(u+=n.additionalInfoText.length),u>(i?ou:su)}function gi(n){let t={topResults:n.topResults.slice(0),groups:[]};for(let i of n.groups)t.groups.push({typeWithSource:i.typeWithSource,suggestions:i.suggestions.slice(0)});return t}function nr(t,i){if(t.isHtmlAnswer)return vr;if(t.grid)return(i?n.IconSize_GridLayout:n.IconSize_GridLayout_Medium)+2*r;let u=t.numberOfLines==3?ar:t.numberOfLines==2?lr:cr;return t.mainTextWrapsToTwoLines&&(u+=ti),u<ni&&(u=ni),u}function gu(t,i){if(!t)return 0;if(i&&n.uses3lineTemplate(n.getScope(i.type)))return nr({mainTextWrapsToTwoLines:!1,numberOfLines:3,isHtmlAnswer:!1,isSuppressed:t.isSuppressed,grid:!1},!1);if(t.isSuppressed)return 0;let r=sr;return t.hasTwoLines?r+=tt+2:t.mainTextWrapsToTwoLines&&(r+=ti),r}function nf(t,i){let r=gt;if(i.typeWithSource&&n.displayedInGridLayout(i.typeWithSource.type)){let u=n.isL2(t),f=Math.ceil(i.suggestions.length/(u?ei:oi)),e=u?ri:ui;r+=e*f;r+=2*it}else i.suggestions.forEach(n=>r+=gu(n,i.typeWithSource));return r}function tf(n){switch(n){case 0:return"CP";case 7:return"DI";case 1:return"PP";case 2:return"PD";case 4:return"SP";case 5:return"TP";case 6:return"SD"}return undefined}function wt(n,t,i){if(n.length>0&&t.length>0){let r=i?n.concat(ft):n;return r.concat(t)}return n.length>0?n:t.length>0?i?[ft].concat(t):t:[]}function i(t,i){return t.find(t=>n.sameGroup(t.typeWithSource,i))}function tr(t,i){return t.find(t=>n.sameGroup(t.group.typeWithSource,i))}function ir(n,t){return n.queryToFetch.substring(0,t.queryToFetch.lastIndexOf("\\"))}function rr(t){switch(t){case n.GroupType.AnaheimDataTile:case n.GroupType.TopApps:case n.GroupType.People:return!0}return!1}function rf(t,i){if(!t.isSearchHomeZI||t.isWorkScopeZI||t.scope==n.Scope.All||i==n.GroupType.RecommendedDocs)return null;if(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isPeopleZeroQueryEnabled(t))return n.Host.getLocString("PeopleZeroQuerySection");if(t.scope==n.Scope.Web){if(i==n.GroupType.Websites)return n.Host.getLocString("RecentWebsiteSection");if(i==n.GroupType.SearchSuggestions)return n.Host.getLocString("RecentWebSearchSection")}return rr(i)?n.Host.getLocString("FrequentSection"):n.Host.getLocString("RecentSection")}function uf(t){return n.Host.getLocString(t?(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.isEduTenant())?"SearchSchoolAndWeb":"SearchWorkAndWeb":n.shouldEnableBingChatString()?"ChatWithBing":n.config.useGroupTitleWeb?"SearchWebData":"SearchTheWeb")}function ff(){return n.Host.getLocString("Websites")}function ef(){return n.SubstrateTenantName?(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.isEduTenant())?n.Host.getLocString("MsbRecommendedForYouText"):n.Host.getLocString("MsbTenantRecommended").replace("{0}",n.SubstrateTenantName):n.Host.getLocString("QuickWorkSearchSuggestionsSection")}function ur(t,i,r,u){if(i==n.GroupType.PathCompletion){let n=ir(t,t)+"\\"+String.fromCharCode(8206);return{title:n,narratorText:n}}if(r){let t=r.groupDisplayName;if(t)return{title:t,narratorText:u?n.Host.getLocString("AddingScopeNarratorText",t):t}}let f=rf(t,i);if(!f)switch(i){case n.GroupType.Command:f=n.Host.getLocString("CommandGroup");break;case n.GroupType.Cortana:f=n.Host.getLocString("CortanaGroup");break;case n.GroupType.Store:f=n.Host.getLocString("StoreGroup");break;case n.GroupType.LocalPlaces:f=n.Host.getLocString("LocalPlacesGroup");break;case n.GroupType.Related:f=n.Host.getLocString("RelatedSuggestionsGroup");break;case n.GroupType.SearchSuggestions:f=uf(n.msbEnabledForQuery(t));break;case n.GroupType.AnaheimDataQF:f=n.Host.getLocString("SearchAnaheimData");break;case n.GroupType.Websites:f=ff();break;case n.GroupType.Contact:f=n.Host.getLocString("ContactGroup");break;case n.GroupType.LocalSearchHistory:f="Search history";break;case n.GroupType.CuratedSuggestions:f=n.Host.getLocString("SuggestedSection");break;case n.GroupType.CuratedSettings:f=n.Host.getLocString("QuickSearchSuggestionsSection");break;case n.GroupType.TopApps:f=n.Host.getLocString("TopAppsSection");break;case n.GroupType.QuickSearch:f=n.Host.getLocString("QuickSearchSuggestionsSection");break;case n.GroupType.QuickWorkSearch:case n.GroupType.QuickWorkSearchTopList:case n.GroupType.MsbQuickWorkQueriesTopList:f=ef();break;case n.GroupType.VisualSearch:f="Visual search";break;case n.GroupType.Upsell:f=n.Host.getLocString("RecommendedGroup");break;case n.GroupType.MRUHistory:case n.GroupType.WorkSuggestions:f=n.shouldShowDSBFullWidth(t)&&n.config.enableMRUDSBV2?n.Host.getLocString("DSBRecentTitle"):(t===null||t===void 0?void 0:t.isWorkScopeZI)&&n.canShowWorkSearchMru(t)&&((r===null||r===void 0?void 0:r.handoffType)===21||(r===null||r===void 0?void 0:r.handoffType)===17)?n.Host.getLocString("MsbRecentWorkSearches"):n.Host.getLocString("MRUHistoryGroup");break;case n.GroupType.AnaheimDataTile:f=n.Host.getLocString("AnaheimDataTopSites");break;case n.GroupType.AnaheimDataList:r.type=="QSSG"?f=n.Host.getLocString("QuickSearchSuggestionsSection"):r.type=="ANAH"?f=n.Host.getLocString("AnaheimDataHistory"):r.type=="ANAT"?f=n.Host.getLocString("AnaheimDataTopSites"):r.type=="ANAR"&&(f=n.Host.getLocString("AnaheimDataRecentlyClosed"));break;case n.GroupType.AnaheimDataTopHit:n.config.topHitMuse&&r.type=="ANATH"&&(f="Best match for Edge history");break;case n.GroupType.RecommendedDocs:f=n.Host.getLocString("RecommendedDocsGroup");n.config.msbEnableDocumentZQ&&t.scope==n.Scope.Documents&&(f=n.Host.getLocString("RecommendedZQGroup"));break;case n.GroupType.PromoBanner:f=n.Host.getLocString("VaccineUpdate");break;case n.GroupType.MsbOnRampButton:f="MSB On ramp button";break;case n.GroupType.TrendingSearchData:f=n.Host.getLocString("DSBTrendingTitle");break;case n.GroupType.ChatWithBing:f=n.Host.getLocString("ChatWithBing")}if(!f){let t=n.getScope(i);if(t==n.Scope.All)throw new Error("Unknown group type: "+i);let r=n.ScopeConfig[t];f=n.getScopeDisplayName(r)}return{title:f,narratorText:u?n.Host.getLocString("AddingScopeNarratorText",f.toLocaleLowerCase()):f}}function sf(t){let i,r;if(n.config.enableAnaheimDataProfile)if(n.AnaheimDataProviderV2&&n.AnaheimDataProviderV2.checkAnaheimV2Enable())n.AnaheimDataProviderV2&&n.AnaheimDataProviderV2.checkAnaheimV2Enable()&&(n.AnaheimDataProviderV2.ANAAccountType==1?i=n.AnaheimDataProviderV2.ANAProviderItemID:n.AnaheimDataProviderV2.ANAAccountType==2&&(r=n.AnaheimDataProviderV2.ANAProviderItemID));else if(n.AnaheimDataProvider){let t=n.AnaheimDataProvider.getSelectedProfile();t&&(t.accountType=="MSA"?i=t.id:t.accountType=="AAD"&&(r=t.id))}return[{text:n.Host.getLocString("AnaheimDataEdgeSettings"),id:"anaheimDataEdgeSettings",selected:!1,useAccentColor:!0,action:()=>n.Host.launchUrlWithEdgeProtocolAsync(null,{edgeSettingsUrl:n.config.anaheimDataEdgeSettings,cid:i,oid:r}),instItem:n.InstrumentedItem.getNonSuggestionInstrumentedItem("ANA",n.SyntheticQSCodesMaps.KValues,19),sequenceNumber:t}]}function fr(t,i,r,u){let f,e=[],o,s;const h=n.canShowAnaheimDataSHTileE2E(),l=n.canShowAnaheimDataSHListE2E(),a=n.canShowAnaheimDataQFE2E(),c=t==n.GroupType.AnaheimDataTile&&h;if((t==n.GroupType.AnaheimDataTile&&h||t==n.GroupType.AnaheimDataList&&l||t==n.GroupType.AnaheimDataQF&&a)&&(f="AnaheimDataGroupPopup",s="anaheimDataPopover",e=sf(u)),f){let r=t+"informationBubble",u=s||t+"groupTitlePopover",h=()=>i.showPopover(n.Host.getLocString(f),e,_ge(r),!0,!0,u,c),l=(t,o)=>{if(o==1){h();return}i.showPopover(n.Host.getLocString(f),e,_ge(r),!0,!1,u,c)};o={subItem:{id:r,selected:!1,selectedStyleSuspended:!1,narratorText:"",tooltip:"",text:"",onSelected:h},onMouseEnter:l}}return o}const bt=4,kt=6,nt=8,r=12,dt=1,u=20,tt=n.config.useCobaltCSS?20:16,or=n.config.useCobaltCSS?20:16,sr=n.config.useCobaltCSS?42:u+2*nt,gt=n.config.useCobaltCSS?40:or+2*nt,hr=n.config.useCobaltCSS?40:gt,ni=n.config.useCobaltCSS?70:60,cr=n.config.useCobaltCSS?50:u+2*r,lr=n.config.useCobaltCSS?70:u+tt+bt+2*r,ar=n.config.useCobaltCSS?88:u+2*(tt+bt)+2*r,vr=80+2*r,yr=n.config.useCobaltCSS?18:nt,ti=u,pr=n.config.useCobaltCSS?58:48,ii=48,it=1,ri=n.IconSize_GridLayout+2*(kt+dt),ui=n.IconSize_GridLayout_Medium+2*(kt+dt),wr=n.config.useCobaltCSS?44:32,br=8,kr=n.config.useCobaltCSS?139:140,dr=156,rt=8,gr=n.config.useCobaltCSS?572:600,nu=510,tu=400,iu=350,a=184,ut=692,ru=628,uu=565,fu=501,eu=6,fi=200;let ei=3,oi=4;const ou=n.config.useCobaltCSS?33:39,su=n.config.useCobaltCSS?33:42,ft={},et="runas",ot="tabletmode_opennewwindow",si="tile.uninstall",hi="startpin",st="taskbarpin",ci="startunpin",ht="taskbarunpin",li="MRUNoItemsAvailable",v="launchIndexingOptions",hu="s_copyfullpath",ct="workUpsellDismiss",lt="workUpsellButton",ai="dynamic-pane-iframe",at="ws-pills-see-more-less",cu="data-show-more",vt="reclaimKeepButton",f="reclaimUndoButton",yt="reclaimDismiss",y=4,vi="notificationDismissIcon",yi="notificationButton",p="notificationDismiss",w=[{id:"FlyoutNextButton",selected:!1,text:null},{id:"FlyoutButton",selected:!1,text:null},{id:"FlyoutHyperLinkButton",selected:!1,text:null},{id:"FlyoutDismissFooterButton",selected:!1,text:null},{id:"flyoutDismissIcon",selected:!1,text:null}],b={id:vt,selected:!1},k={id:f,selected:!1},pt={id:yt,selected:!1},pi=[b,k,pt],wi={id:vi,selected:!1},e={id:yi,selected:!1},o={id:p,selected:!1},bi=n.config.useCobaltCSS?[e,o]:[wi,e,o],d={id:"SearchBox",selected:!1,text:"SearchBox"},lu={id:ct,selected:!1,text:null},au={id:lt,selected:!1,text:null},vu=[lu,au],yu={id:at,selected:!1,text:null},s=1,h="WorkUpsellInfo",ki=5,t={};t[et]={content:"&#xE7EF",type:1,order:1};t.runasuser={content:"&#xE7EE",type:1,order:2};t.openinbrowser={content:"&#xE774",type:1,order:3};t.openfilelocation={content:"&#xE838",type:2,order:4};t.opencontaining={content:"&#xE838",type:2,order:5};t[ot]={content:"&#xE8A7",type:2,order:6};t[ci]={content:"&#xE77A",type:1,order:7};t[ht]={content:"&#xE77A",type:1,order:8};t[hi]={content:"&#xE718",type:2,order:9};t[st]={content:"&#xE718",type:2,order:10};t.settings={content:"&#xE713",type:2,order:11};t.manage={content:"&#xE912",type:1,order:12};t.review={content:"&#xE728",type:2,order:13};t.share={content:"&#xE72D",type:1,order:14};t.connectnetworkdrive={content:"&#xE8CE",type:1,order:15};t.disconnectnetworkdrive={content:"&#xE8CD",type:1,order:16};t.uninstall={content:"&#xE74D",type:2,order:17};t[si]={content:"&#xE74D",type:2,order:18};t.itemproperties={content:"&#xF106",type:2,order:19};const pu=(()=>{let t={};return t[n.GroupType.PathCompletion]="GPT",t[n.GroupType.Store]="GT",t[n.GroupType.SearchSuggestions]="GW",t[n.GroupType.ChatWithBing]="GW",t[n.GroupType.AnaheimDataQF]="GW",t[n.GroupType.MRUHistory]="MRUH",t[n.GroupType.QuickSearch]="QSCH",t[n.GroupType.CuratedSuggestions]="DFLS",t[n.GroupType.CuratedSettings]="CUSE",t[n.GroupType.VisualSearch]="SNSC",t})(),wu=["Bookmark","Building","Person","Qna","File","Group"];n.extendVerbs=du;n.getVerbsAsync=di;n.wrapsToTwoLines=l;n.joinVerbs=wt;n.getGroupTitleAndNarratorText=ur;n.getGroupPopover=fr;class er{constructor(t,i,r,u,f,e,o,s,h){this._autoComplete=t;this._navigationHelper=i;this._page=r;this._previewPane=u;this._menuFactory=f;this._upsellViewModel=e;this._popoverFactory=o;this._headerFooterViewModel=s;this._bingChatViewModel=h;this._pendingSubmitSequenceNumber=-1;this._pendingSubmitModifierKeys=null;this._pendingSubmitTimeStamp=null;this._itemLaunchEventHandlers=[];this._conversationEndsHandlers=[];this.groups=[];this.topResults=[];this._lastUpdatedSequenceNumber=-1;this._topResultsRenderingDisabled=!1;this._groupRenderingDisabled=!1;this._resultsCounter={topResults:[],groups:[]};this._shouldHideWorkUpsell=!1;this._isWorkUpsellShown=!1;this._pendingSuggestionsInExistingGroups=[];this._pendingSuggestionsInMissingGroups=[];this._lastMiniSerpAutoSuggestion=null;this._addedManualLbshToMru=!1;this.updateExpandedState=()=>{var i;const t=(i=this.groups)===null||i===void 0?void 0:i.findIndex(t=>t.type===n.GroupType.Related);t>-1&&(this.groups[t].isGroupContainerFullyExpanded=!this.groups[t].isGroupContainerFullyExpanded,this._selectedItem.isGroupContainerFullyExpanded=this.groups[t].isGroupContainerFullyExpanded)};n.Host.bindShown(()=>{this._selectedItem=null,this._lastMiniSerpAutoSuggestion=null,this._addedManualLbshToMru=!1,this._page.updateNotificationBannerAreaView(this.buildDmaBannerModel())});r.setSuggestionClickHandler(this.doubleClickGuardedHandler((t,i)=>{let r={shiftKey:i===null||i===void 0?void 0:i.shiftKey,ctrlKey:i===null||i===void 0?void 0:i.ctrlKey,altKey:i===null||i===void 0?void 0:i.altKey};n.safeExecute(()=>this.click(n.getCurrentTime(),t,n.getInputType(i),r),"suggestionClickHandler")}));r.setContextMenuHandler((t,i)=>{n.safeExecute(()=>this._menuFactory.showContextMenuOnXY(t,i.pageX,i.pageY,()=>n.Host.setFocusInSearchBox(null,"contextMenuDismiss"),n.getInputType(i)),"contextMenuHandler")});r.setOpenPreviewPaneClickHandler((t,i)=>{var r;const u=t;wu.indexOf(u.msbDomain)>-1&&(_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionArrowClick(u.msbDomain),_w.bfbWsbTel&&bfbWsbTel.log3SClickedEvent("QueryFormulationRightArrow_Click",(r=window===null||window===void 0?void 0:window._G)===null||r===void 0?void 0:r.IG));n.safeExecute(()=>this.openPreviewPane(t,i),"openPreviewPaneClickHandler")});r.setExpanderClickInstrumentation((t,i,r)=>{let u="Expander"+(r?"Opened":"Closed"),f={st:i,K:t.instItem.getLayoutKValue()};n.InstrumentationHelper.logClientInstEvent("Select",u,null,f)});this._previewPane&&(this._previewPane.init(this),this._previewPane.bindBeforeItemLaunch((t,i,r,u,f,e)=>n.InstrumentationHelper.instrumentItemClickForPreviewPane(t,i.instItem,i.sequenceNumber,i.instrumentPingBack,r,null,u,f,e)),this._previewPane.bindAfterItemLaunch((n,t,i)=>{this.onSuggestionLaunch(n,t,i)}));n.Host.bindShown(()=>{n.config.setIndexerDefaultValue&&(n.config.searchServiceDisabled=!0),SearchAppWrapper.CortanaApp.queryFormulationView.deviceSearch.getSearchServiceStatusAsync&&n.Async.safeChain("getSearchServiceStatusAsync",()=>SearchAppWrapper.CortanaApp.queryFormulationView.deviceSearch.getSearchServiceStatusAsync(),t=>{n.InstrumentationHelper.setSearchServiceStatus(tf(t));switch(t){case 1:case 2:case 5:case 6:case 7:n.config.searchServiceDisabled=!0;this.showIndexingMessage(!1);break;case 0:case 4:if(n.config.queryIndexerOnRunningOnly){n.config.searchServiceDisabled=!0;this.showIndexingMessage(!0);break}n.config.searchServiceDisabled=!1;break;case 3:n.config.searchServiceDisabled=!1}})});r.bindOnNarratorLaunch(t=>{let i=n.getCurrentTime(),r=this.getSelectableItems();for(let n of r)if(n.id==t){this.isSuggestionOrGroup(n)?(this.select(n,!1),this.submit(i,!1,n.sequenceNumber,null,!0)):this.isScopeElement(n)&&_ge(n.id).click();break}});n.Host.bindSearchBoxGotFocus(()=>{this._menuFactory.dismiss();let t=n.getCurrentActiveElement();t&&t.blur();this._selectedItem&&!this.isScopeElement(this._selectedItem)&&this.renderSelectedSuggestionState(!1)});n.Host.bindSearchBoxLostFocus(()=>{let t=this.isScopeTile(n.getCurrentActiveElement());t?n.safeSetTimeout(()=>{n.Host.searchBoxHasFocus()||this.isScopeElement(this._selectedItem)||this.renderSelectedSuggestionState(!0)},75,"RootViewModel.bindSearchBoxLostFocus"):this.renderSelectedSuggestionState(!0)});sj_evt.bind("CortanaPaneWidthSet",n=>this.onPaneWidthSet(n[1]));sj_be(n.StaticHtmlElements.qfContainer,"scroll",()=>{this._menuFactory.dismiss(),this._popoverFactory&&this._popoverFactory.dismiss()});this._iconRenderInfos=[]}isScopeTile(n){return n&&n.classList.contains("scope-tile")}isMessageBannerButton(n){return n&&n.classList.contains("reclaimButton")}isNotificationBannerButton(n){return n&&n.classList.contains("upsellButton")}shouldAddLastAutoSuggToMRU(){var t,i;let r=!1;if(!n.config.disableMRULBSHIncludeAutoMiniSerp&&!this._addedManualLbshToMru&&this._lastMiniSerpAutoSuggestion){const u=n.getGroupType(this._lastMiniSerpAutoSuggestion);if(u===n.GroupType.SearchSuggestions||u===n.GroupType.WorkSuggestions){const u=(i=(t=this._partialQuery)===null||t===void 0?void 0:t.queryToFetch)===null||i===void 0?void 0:i.trim();((u===null||u===void 0?void 0:u.length)>=n.config.minQueryLengthForMiniSerpAutoSuggestion||(u===null||u===void 0?void 0:u.split(" ").length)>1)&&(r=!0)}}return r}onDismiss(){var t;this.shouldAddLastAutoSuggToMRU()&&this.addLastMiniSerpAutoSuggestionToMru();this.topResults=[];this.renderTopResults(!0);this.groups=[];this.renderGroups(!0);this._partialQuery=null;this._lastUpdatedSequenceNumber=-1;this._pendingSuggestionsInExistingGroups=[];this._pendingSuggestionsInMissingGroups=[];this.toggleProgressBar(!1);this._menuFactory.dismiss();this._previewPane&&n.RuntimeConfig.PreviewPaneAvailable&&this._previewPane.dismiss();this._page.hideTemporaryMessage();this.hideIndexingMessage();n.DialogBox&&n.DialogBox.hide();this._headerFooterViewModel&&(this._headerFooterViewModel.render(null,!1,!1,!1,!0),n.config.scopeWithBackground&&((t=this._headerFooterViewModel)===null||t===void 0?void 0:t.scopesSliderReset(!0)));n.Host.setSearchBoxGlyphIcon()}bindItemLaunch(n){this._itemLaunchEventHandlers.push(n)}bindConversationEnds(n){this._conversationEndsHandlers.push(n)}onPaneWidthSet(n){oi=Math.floor((n-2*it)/ui);ei=Math.floor((n-2*it)/ri)}setSelectedStyleSuspended(t,i){t.selectedStyleSuspended=i&&n.Host.isRequestFocusAvailable()}renderSelectedSuggestionState(n){this._selectedItem&&(this.setSelectedStyleSuspended(this._selectedItem,n),this.renderSelection(this._selectedItem))}toggleProgressBar(t){n.config.dataSourcesWithProgressBar.length>0&&(this._progressTimer&&(sb_ct(this._progressTimer),this._progressTimer=null),t?(this._partialQuery.showProgressBar||this._partialQuery.queryToFetch=="")&&(this._progressTimer=n.safeSetTimeout(()=>{this._progressTimer&&(this._page.setProgressIndicatorVisibility(!0),this._progressTimer=null)},250,"showProgress")):n.config.dataSourcesWithProgressBar.length>0&&(this._progressTimer&&(sb_ct(this._progressTimer),this._progressTimer=null),this._page.setProgressIndicatorVisibility(!1)))}resetPendingSubmitSequenceNumber(){this._pendingSubmitSequenceNumber=null;this._pendingSubmitModifierKeys=null;this._pendingSubmitTimeStamp=null}onAfterKeyDown(t,i,r,u){var l,a,y,d,g;if((l=this._previewPane)===null||l===void 0?void 0:l.hasFocus()){const i=this._previewPane.getSelectableItems(),n=i[0],t=this._previewPane.getSelectedItem();(n===null||n===void 0?void 0:n.id)===(t===null||t===void 0?void 0:t.id)&&this._page.scrollRightPaneToTop()}if(!this._partialQuery||!this._menuFactory.isMenuVisible()&&(!this._popoverFactory||!this._popoverFactory.isPopoverVisible())&&t==13&&this._partialQuery.scope!==n.Scope.Work&&!n.isRemoveIconSelected())return!1;const c=i&&i.shiftKey;if(n.DialogBox&&n.DialogBox.isVisible())return t!=9||u||this.handleCrossViewModelsTabKeyNavigation(null,c),!0;let h=this._previewPane&&this._previewPane.hasFocus();const nt="rvm onAfterKeyDown";if(this._page.hideTemporaryMessage(),this.resetPendingSubmitSequenceNumber(),!r&&n.isContextMenuKey(t,c)&&!h)return this.tryShowContextMenuOnSelectedSuggestion(),!0;if(this._menuFactory.isMenuVisible()){if(t==37||t==39||t==13||n.isUpOrDownKey(t)){let f=this._menuFactory.onAfterKeyDown(t,i,r,u);if(f)return!0;if(n.isUpOrDownKey(t))return!1}else if(t==9)return this._menuFactory.dismiss(!0),!0;this._menuFactory.dismiss(!0)}if(this._popoverFactory&&this._popoverFactory.isPopoverVisible()){if(t==37||t==39||t==13||n.isUpOrDownKey(t)){let n=this._popoverFactory.onAfterKeyDown(t,i,r,u);if(n)return!0;if(t==37||t==39)return!1}this._popoverFactory.dismiss(!1)}if(n.RuntimeConfig.QfMode==0||n.RuntimeConfig.QfMode==1){let i=this._selectedItem;if(i&&i.removeIcon&&i.selected){if(t==39)return i.removeIcon.selected=!0,this.renderSelectedSuggestionState(!0),!0;if((t===46||t===32)&&i.removeIcon.selected)return i.removeIcon.click(n.getCurrentTime(),1),!0;i.removeIcon.selected=!1;this.renderSelection(i)}}if(n.RuntimeConfig.QfMode==5&&t==46){let t=this._selectedItem;return t&&t.removeIcon?(t.removeIcon.click(n.getCurrentTime(),1),!0):!1}let s=n.getCurrentActiveElement();if(!this.isScopeTile(s)||h||this._menuFactory.isMenuVisible()||this._popoverFactory&&this._popoverFactory.isPopoverVisible()||t!=39&&t!=37)if(!(n.config.enableMessageBanner||n.config.supportDMA)||h||t!=39&&t!=37||!(this.isMessageBannerButton(s)||this.isNotificationBannerButton(s))||this._menuFactory.isMenuVisible()||this._popoverFactory&&this._popoverFactory.isPopoverVisible()){if(t==9)if(n.config.allowTabToSelectSuggestions||c||!this._selectedItem||h||this.isScopeElement(this._selectedItem))if(u){if(n.RuntimeConfig.PreviewPaneAvailable&&this._previewPane&&this._selectedItem&&!this.isScopeElement(this._selectedItem)){this._previewPane.onAfterKeyDownWhenNewSelection(t,this._partialQuery,this._selectedItem);if(h)return!0}}else this.handleCrossViewModelsTabKeyNavigation(s,c);else this.select(this._headerFooterViewModel.getSelectableItems()[0],!1);else if(n.RuntimeConfig.PreviewPaneAvailable&&this._previewPane&&this._selectedItem&&!this.isScopeElement(this._selectedItem)){this._previewPane.onAfterKeyDownWhenNewSelection(t,this._partialQuery,this._selectedItem);if(h)return!0}}else{let u=n.getRtlAdjustedKey(t),i;if(this.isMessageBannerButton(s)?i=[b,k]:this.isNotificationBannerButton(s)&&(i=[e,o]),!i)return!1;const r=s?i.findIndex(n=>n.id===s.id):-1,f=u==37?r==0:r==i.length-1;if(f)return!1;const h=u==37?r-1:r+1;this.select(i[h],!1);(a=_ge(this._selectedItem.id))===null||a===void 0?void 0:a.focus()}else{let i=n.getRtlAdjustedKey(t);this._headerFooterViewModel.focusNextScopeTile(s,i==39);let r=this._headerFooterViewModel.getSelectableItems();this.select(r[0],!1)}if(h=this._previewPane&&this._previewPane.hasFocus(),this._selectedItem&&(n.isUpOrDownKey(t)||t==9||n.isMsbEnterprise()&&this.isDSBItem(this._selectedItem)&&this.isLeftRightArrowKey(t))&&!h){const i=this.isScopeElement(this._selectedItem);i||this._selectedItem==this.topResults[0]?this._page.scrollToTop():this._page.scrollTo(this._selectedItem,n.isWin11DSB(this._partialQuery),this.isWorkScope());const r=nt+"-AdjustFocus";i||this.isAdvancedOption(this._selectedItem)||this.isFlyout(this._selectedItem)?(this.isAdvancedOption(this._selectedItem)&&this._selectedItem.id!==v?(y=_ge(this._selectedItem.id))===null||y===void 0?void 0:y.querySelector("input").focus():(d=_ge(this._selectedItem.id))===null||d===void 0?void 0:d.focus(),n.Host.searchBoxHasFocus()&&n.Host.setFocusInWebView(r)):this._selectedItem.id==ai?(this._DSBIframeSelected=!0,n.dsbManager.focus()):this.isDSBItem(this._selectedItem)||this._selectedItem.id==ct||this._selectedItem.id==lt||this._selectedItem.id==vt||this._selectedItem.id==f||this._selectedItem.id==yt||this._selectedItem.id==vi||this._selectedItem.id==yi||this._selectedItem.id==p||this.isWorkScope()&&this._selectedItem.type===n.GroupType.Related||this._selectedItem.id==at?(g=_ge(this._selectedItem.id))===null||g===void 0?void 0:g.focus({preventScroll:this._selectedItem.preventScroll}):t!=9&&n.Host.searchBoxHasFocus()||n.Host.setFocusInSearchBox(t,r)}return this.isFlyoutVisible()&&w.indexOf(this._selectedItem)>=0&&(t==39?this.selectNextFlyoutItem(1):t==37&&this.selectNextFlyoutItem(-1)),!1}isFlyoutVisible(){return n.config.enableEducationalFlyout&&!n.StaticHtmlElements.flyoutContainer.classList.contains("b_hide")}selectNextFlyoutItem(n){if(this.isFlyoutVisible()){const t=w.filter(n=>_ge(n.id)),r=t.indexOf(this._selectedItem),i=(r+n)%t.length;this._selectedItem=t[i>=0?i:t.length-1];_ge(this._selectedItem.id).focus()}}handleCrossViewModelsTabKeyNavigation(t,i){const u=n.RuntimeConfig.PreviewPaneAvailable&&!!this._previewPane,r=u&&this._previewPane.isOpened(),f=r&&this._previewPane.hasFocus();if(n.DialogBox&&n.DialogBox.isVisible()){let t=n.DialogBox.getSelectableItemsByGroup();i?this.select(t[t.length-1][0],!1):this.select(t[0][0],!1)}else if(f)if(i){this._previewPane.blur();let n=null;if(this._headerFooterViewModel){let t=this._headerFooterViewModel.getSelectableItemsByGroup();n=t[t.length-1][0]}this.select(n,!1)}else{this._previewPane.blur();let n=this.getSelectableItems();this.select(n[0],!0);this._previewPane.onAfterKeyDownWhenNewSelection(9,this._partialQuery,n[0])}else if(this.isScopeTile(t)){let t=!1;if(n.dsbManager&&i){let i=n.dsbManager.getSelectableItemsByGroup();if(i.length>0){let n=i[i.length-1][0];this.select(n,!1);t=!0}}if(!t)if(!r||i){let t=this.getSelectableSuggestionsByGroup();if(t.length>0){let n=i?t[t.length-1][0]:t[0][0];this.select(n,!0)}else{let n=this.getSelectableItems();n.length>0?this.select(n[0],!0):this.select(null,!0)}const r="handleCrossBordersNavigationWithTab";n.safeSetTimeout(()=>n.Host.setFocusInSearchBox(9,r),0,r)}else this.select(this._previewPane.getPreviewedSuggestion(),!0),this._previewPane.focus(!0)}else if(this._selectedItem)if(this._selectedItem.id==ai)if(this._DSBIframeSelected){this._DSBIframeSelected=!1;let n=this.getSelectableItemsByGroup(),t=n[0][0];this.select(t,!1)}else this._DSBIframeSelected=!0,n.dsbManager.focus();else if(i)if(r)this._previewPane.focus();else{let n=this.getSelectableItemsByGroup(),t=n[n.length-1][0];this.select(t,!1)}else this.select(this.getSelectableItemsByGroup()[0][0],!1);else this.select(this.getSelectableItemsByGroup()[0][0],!1)}tryShowContextMenuOnSelectedSuggestion(t){let i=this._selectedItem&&this.isSuggestion(this._selectedItem)?this._selectedItem:null;i&&n.safeExecute(()=>this._menuFactory.showContextMenuOnElement(i,_ge(i.id),()=>n.Host.setFocusInSearchBox(null,"contextMenuDismiss"),t),"contextMenuHandler")}onQueryChanged(t,i){var u,f;if(n.DialogBox&&n.DialogBox.hide(),this._menuFactory.dismiss(),!this._partialQuery||!this._partialQuery.equals(t)){this._page.hideTemporaryMessage();n.config.dataSourcesWithProgressBar.length>0&&(this._progressTimer&&(sb_ct(this._progressTimer),this._progressTimer=null),t.showProgressBar?this._progressTimer=n.safeSetTimeout(()=>{this._progressTimer&&(this._page.setProgressIndicatorVisibility(!0),this._progressTimer=null)},250,"showProgress"):this._page.setProgressIndicatorVisibility(!1));this._partialQuery&&this._partialQuery.scope!=t.scope&&(this._turnOnIndexingInstItem||this.hideIndexingMessage());let e=this._partialQuery?this._partialQuery.queryToFetch:"",r=t.queryToFetch;if(this._previewPane&&n.RuntimeConfig.PreviewPaneAvailable)this._previewPane.onQueryChanged(t);this._partialQuery=t;let o=!1;for(let n of this.topResults)if(n.updateFromQuery&&!n.hasPreviewPaneOpened)n.updateFromQuery(t)&&(o=!0);else if(r.length>e.length&&r.startsWith(e)&&n.query.toLowerCase().includes(t.queryToFetch.toLowerCase())){let t=n.text.indexOf(HitHighlightingParser.endMarker);t>=0&&t<n.text.length-1&&(n.text=HitHighlightingParser.addMarkers(HitHighlightingParser.removeMarkers(n.text),r),o=!0)}if(o){for(let n of this.topResults)n.sequenceNumber=i,this.updateNarratorWithPreviewMessage(n);this.renderTopResults()}const s=n.RuntimeConfig.EntryPointApp==1;n.config.scopeWithBackground&&r===""&&e.length>=1&&!s&&((u=this._headerFooterViewModel)===null||u===void 0?void 0:u.scopesSliderReset());this.resetIconTimers();this._iconRenderInfos=[];n.isChatScopeEnabled()&&((f=this._bingChatViewModel)===null||f===void 0?void 0:f.update(t))}}onSuggestionsParsed(t,i,r,u,f){var o,s;if(t.enabledDataSources&&t.enabledDataSources[r]){let e=t.enabledDataSources[r].groupType;if(e===n.GroupType.QuickWorkSearch&&(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isQwsTopListEnabled())&&t.isSearchHomeZI)for(let t of f)t.staticGroupType=t.msbDomain==="Person"?n.GroupType.QuickWorkSearchTopList:e;else if(e===n.GroupType.AnaheimDataList)for(let t of f)t.staticGroupType=n.config.enableAnaheimDataTSTile&&t.type=="ANAT"?n.GroupType.AnaheimDataTile:e;else if(e==n.GroupType.AnaheimDataQF)for(o=0;o<f.length;o++)s=f[o],s.staticGroupType=n.config.topHitMuse&&s.type=="ANATH"?n.GroupType.AnaheimDataTopHit:n.config.useGroupTitleEdgeBS?e:n.GroupType.SearchSuggestions;else if(e===n.GroupType.SearchSuggestions)for(let t of f)t.staticGroupType=n.config.topHitMuse&&t.type=="ANATH"?n.GroupType.AnaheimDataTopHit:e;else if(typeof e=="number")for(let n of f)n.staticGroupType=e;(u==="NI"||u==="PI")&&(r=="PP"||r=="ST"||t.scope!=n.Scope.All)&&n.RuntimeConfig.ScopesAvailable&&t.scope!=n.Scope.Web&&this.showIndexingMessage(!0)}}areSuggestionsPresent(){return this.topResults.length>0||this.groups.length>0&&this.groups.some(n=>n.suggestions.length>0)}isWorkScope(){var t;return((t=this._partialQuery)===null||t===void 0?void 0:t.scope)===n.Scope.Work}getSuggestions(n){let t=this.getCurrentTopResults();return this.groups.forEach(n=>t=t.concat(n.suggestions)),n&&(this._pendingSuggestionsInExistingGroups.forEach(n=>t=t.concat(n.suggestions)),this._pendingSuggestionsInMissingGroups.forEach(n=>t=t.concat(n.suggestions))),t}getSelectableItems(){var i,r,u,s,h,c,l,a,v,y,w,g,nt;if(n.DialogBox&&n.DialogBox.isVisible())return n.DialogBox.getSelectableItems();if(this._menuFactory.isMenuVisible())return this._menuFactory.getSelectableItems();if(this._previewPane&&this._previewPane.hasFocus())return this._previewPane.getSelectableItems();let t=[];((i=this._launchIndexingDataModel)===null||i===void 0?void 0:i.action)&&t.push(this._launchIndexingDataModel.action);!this.shouldShowMessageBanner()||((u=(r=n.StaticHtmlElements.messageBannerBottom)===null||r===void 0?void 0:r.className)===null||u===void 0?void 0:u.includes("b_hide"))&&((h=(s=n.StaticHtmlElements.messageBannerTop)===null||s===void 0?void 0:s.className)===null||h===void 0?void 0:h.includes("reclaim"))||t.push(...[pt,((c=this._selectedItem)===null||c===void 0?void 0:c.id)==f?k:b]);t.push(...this.topResults);for(let i of this.groups)if(i.click&&t.push(i),i.popover&&t.push(i.popover.subItem),!(this.isWorkScope()&&i.type===n.GroupType.Related&&i.isGroupContainerCollapsed)){let n=i.suggestions.filter(n=>!n.suppressed);const u=`showMoreButton${i.type}`,r=_ge(u);i.maxSuggestionsToShow!=undefined&&(n===null||n===void 0?void 0:n.length)>i.maxSuggestionsToShow&&!i.isGroupContainerFullyExpanded&&(n=n.slice(0,i.maxSuggestionsToShow));r&&r.getAttribute(cu)=="true"&&(n=n.slice(0,5));n.forEach(n=>{n.unselectable||t.push(n),n.subItems&&t.push(...n.subItems.filter(n=>!n.disabled))});r&&r.className&&(nt={id:u,selected:!1,click:()=>{r.click()},onSelected:()=>{var n;(n=_ge(this._selectedItem.id))===null||n===void 0?void 0:n.setAttribute("class","showMoreButton sa_hv selected selectable")},onUnselected:()=>{var n;(n=_ge(this._selectedItem.id))===null||n===void 0?void 0:n.setAttribute("class","showMoreButton")},type:"FL",getMruData:()=>{}},t.push(nt))}if(!this.isWorkScope()||((l=this._selectedItem)===null||l===void 0?void 0:l.isGroupContainerCollapsed)||(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isWorkScopeListViewEnabled())||t.push(yu),this.shouldShowDmaBanner()&&!((v=(a=n.StaticHtmlElements.notificationBanner)===null||a===void 0?void 0:a.className)===null||v===void 0?void 0:v.includes("b_hide"))){let i=[];n.config.useCobaltCSS&&i.push(wi);i.push(((y=this._selectedItem)===null||y===void 0?void 0:y.id)==p?o:e);t.push(...i)}return n.dsbManager&&t.push(...n.dsbManager.getSelectableItems()),this.areSuggestionsPresent()||t.push(d),this._headerFooterViewModel&&t.push(...this._headerFooterViewModel.getSelectableItems()),!this.shouldShowWorkUpsellMessage()||((g=(w=n.StaticHtmlElements.workUpsellBanner)===null||w===void 0?void 0:w.className)===null||g===void 0?void 0:g.includes("b_hide"))||t.push(...vu),t}getSelectableSuggestionsByGroup(){if(n.config.allowTabToSelectSuggestions){let t=[];return n.config.enableMessageBanner&&t.push(pi),t.push(this.topResults),this.groups.forEach(i=>{if(i.click&&t.push([i]),i.popover&&t.push([i.popover.subItem]),!(this.isWorkScope()&&i.type===n.GroupType.Related&&i.isGroupContainerCollapsed)){let r=[],n=i.suggestions.filter(n=>!n.suppressed);i.maxSuggestionsToShow!=undefined&&(n===null||n===void 0?void 0:n.length)>i.maxSuggestionsToShow&&!i.isGroupContainerFullyExpanded&&(n=n.slice(0,i.maxSuggestionsToShow));n.forEach(n=>{n.unselectable||r.push(n),n.subItems&&r.push(...n.subItems.filter(n=>!n.disabled))});t.push(r)}}),n.config.supportDMA&&t.push(bi),t.filter(n=>n.length>0)}return[]}getSelectableItemsByGroup(){var i,r,u,s,h,c,l;if(n.DialogBox&&n.DialogBox.isVisible())return n.DialogBox.getSelectableItemsByGroup();if(this._menuFactory.isMenuVisible())return this._menuFactory.getSelectableItemsByGroup();if(this._previewPane&&this._previewPane.hasFocus())return this._previewPane.getSelectableItemsByGroup();let t=[];return this.isFlyoutVisible()&&t.push([w.find(n=>!!_ge(n.id))]),this._headerFooterViewModel&&t.push(...this._headerFooterViewModel.getSelectableItemsByGroup()),((i=this._launchIndexingDataModel)===null||i===void 0?void 0:i.action)&&t.push([this._launchIndexingDataModel.action]),this.areSuggestionsPresent()?(t.push(...this.getSelectableSuggestionsByGroup()),n.dsbManager&&t.push(...n.dsbManager.getSelectableItemsByGroup())):(!this.shouldShowMessageBanner()||((u=(r=n.StaticHtmlElements.messageBannerBottom)===null||r===void 0?void 0:r.className)===null||u===void 0?void 0:u.includes("b_hide"))&&((h=(s=n.StaticHtmlElements.messageBannerTop)===null||s===void 0?void 0:s.className)===null||h===void 0?void 0:h.includes("reclaim"))||t.push([pt,((c=this._selectedItem)===null||c===void 0?void 0:c.id)==f?k:b]),this.shouldShowDmaBanner()&&t.push([((l=this._selectedItem)===null||l===void 0?void 0:l.id)==p?o:e]),n.dsbManager&&t.push(...n.dsbManager.getSelectableItemsByGroup()),t.push([d])),t}getSelectedItem(){return n.DialogBox&&n.DialogBox.isVisible()?n.DialogBox.getSelectedItem():this._menuFactory.isMenuVisible()?this._menuFactory.getSelectedItem():this._previewPane&&this._previewPane.hasFocus()?this._previewPane.getSelectedItem():this._selectedItem?this._selectedItem:d}updateSelectionState(t){n.contains(this.topResults,t)?this.renderTopResults():this.groups.some(i=>n.contains(i.suggestions,t))&&this.renderGroups()}updateLastMiniSerpAutoSuggestion(n){this._lastMiniSerpAutoSuggestion=n}addLastMiniSerpAutoSuggestionToMru(){this._conversationEndsHandlers.forEach(n=>n(this._lastMiniSerpAutoSuggestion,this._partialQuery))}isSubItem(n){return n&&typeof n.itemView!="undefined"}getSuggestionById(n){for(let t=0;t<this.groups.length;t++)for(let i=0;i<this.groups[t].suggestions.length;i++)if(this.groups[t].suggestions[i].id==n)return this.groups[t].suggestions[i];return null}selectGroupItem(t){var r,i;for(r of this.groups)for(i of r.suggestions)i.reactKey==t.reactKey?n.config.enableQFChatWithBingSuggestions?i.staticGroupType===t.staticGroupType&&(i.selected=!0,this._selectedItem=i):(i.selected=!0,this._selectedItem=i):i.selected=!1;for(i of this.topResults)i.reactKey==t.reactKey?(i.selected=!0,this._selectedItem=i):i.selected=!1}doesGroupsContain(n){var t,i;for(t of this.groups)for(i of t.suggestions)if(i.reactKey==n.reactKey)return!0;return!1}renderSelection(t,i){var r,u,f,e;this.updateGroupSuggestion(i);this.isSubItem(t)&&(t=this.getSuggestionById(t.suggestionId));i&&this.isSubItem(i)&&(i=this.getSuggestionById(i.suggestionId));(t&&this.isSuggestion(t)&&n.contains(this.topResults,t)||i&&this.isSuggestion(i)&&n.contains(this.topResults,i))&&(this.renderTopResults(),this.groups&&(i&&i.handoffType===21||((r=this.groups[0])===null||r===void 0?void 0:r.suggestions)&&((u=this.groups[0].suggestions[0])===null||u===void 0?void 0:u.handoffType)===21)&&this.renderGroups());this._headerFooterViewModel&&(t&&this.isAdvancedOption(t)||i&&this.isAdvancedOption(i))&&this._headerFooterViewModel.updateTopHitHeader();t&&((e=(f=this._launchIndexingDataModel)===null||f===void 0?void 0:f.action)===null||e===void 0?void 0:e.id)===v&&this._page.updateTemporaryMessageView(this._launchIndexingDataModel);(t&&n.isGroup(t)&&n.contains(this.groups,t)||t&&this.isSuggestion(t)&&this.doesGroupsContain(t)||i&&n.isGroup(i)&&n.contains(this.groups,i)||i&&this.isSuggestion(i)&&this.groups.some(t=>n.contains(t.suggestions,i)))&&this.renderGroups()}updateGroupSuggestion(n){if(n&&n.handoffType===21&&this.groups){const t=this.groups.findIndex(t=>t.type===n.groupType);if(t>-1){const i=this.groups[t].suggestions.findIndex(t=>t.id===n.id);i>-1&&(this.groups[t].suggestions[i].selected=!1)}}}renderGroups(t){var i,r,u;if(this._partialQuery){let t=this._partialQuery.queryToFetch?n.config.maxSuggestionsPerGroup:0;t&&t>0&&this.groups.forEach((n,i,r)=>{r[i].suggestions=n.suggestions.slice(0,t)})}this._groupRenderingDisabled||((((i=this._contentQuery)===null||i===void 0?void 0:i.scope)==n.Scope.All||((r=this._contentQuery)===null||r===void 0?void 0:r.isWorkScopeZI))&&(this.adjustMsbGroups(),this.limitWebSuggestions()),this._page.updateGroupsView({query:this._contentQuery,topResults:this.topResults,groups:this.groups},t,this.isWorkScope()&&this.updateExpandedState,((u=this._partialQuery)===null||u===void 0?void 0:u.queryToFetch)?null:this.buildMessageBannerModel()),n.InstrumentationHelper.updateSuggestionsList(this.topResults,this.groups))}limitWebSuggestions(){if(n.config.msbEnableSearchTheWebMaxSuggestionsPresent){const t=this.topResults.filter(t=>n.isMsbQFSuggestion(t)||n.isWebSuggestion(t)||t.isAnswer).length>0,i=this.groups.filter(t=>t.suggestions.filter(t=>n.isMsbQFSuggestion(t)&&!t.suppressed).length>0).length>0;if(!t&&i){let t=[n.GroupType.SearchSuggestions,n.GroupType.Websites];const r=this.groups.filter(i=>n.contains(t,i.type));let i=[];r.forEach(n=>i.push(...n.suggestions));n.limitWebSuggestions(this._partialQuery,[],i,t,[])}}}adjustMsbGroups(){this.msbGroupsSuppressDefault();this.msbGroupsMergeDocsIntoQws();this.msbGroupsSetupTopList();this.msbGroupsSetLayout()}msbGroupsSuppressDefault(){var t;if((n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isQwsEnabled())&&((t=this._contentQuery)===null||t===void 0?void 0:t.isSearchHomeZI)){const t=this.groups.filter(t=>t.type===n.GroupType.QuickWorkSearchTopList)[0],i=this.groups.filter(t=>t.type===n.GroupType.QuickWorkSearch)[0],r=this.groups.filter(t=>t.type===n.GroupType.RecommendedDocs)[0],u=this.groups.filter(t=>t.type===n.GroupType.MsbQuickWorkQueriesTopList)[0];(t||i||r||u)&&(this.groups=this.groups.filter(t=>t.type!==n.GroupType.TopApps&&t.type!==n.GroupType.QuickSearch&&t.type!==n.GroupType.CuratedSettings))}}getMaxMsbItems(){var t;let i=this.getMaxNumberOfRecentItems(n.GroupType.CuratedSuggestions);if(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isQwsTopListEnabled()){const r=this.groups.filter(t=>t.type===n.GroupType.QuickWorkSearchTopList||t.type===n.GroupType.MsbQuickWorkQueriesTopList)[0];if(((t=r===null||r===void 0?void 0:r.suggestions)===null||t===void 0?void 0:t.length)>0)return i-2}return i}msbGroupsMergeDocsIntoQws(){var t,i,r,u;if((n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isQwsRecDocsEnabled())&&(((t=this._contentQuery)===null||t===void 0?void 0:t.isSearchHomeZI)||((i=this._contentQuery)===null||i===void 0?void 0:i.isWorkScopeZI))){const f=this.groups.filter(t=>t.type===n.GroupType.QuickWorkSearch)[0],t=this.groups.filter(t=>t.type===n.GroupType.RecommendedDocs)[0],i=this.groups.filter(t=>t.type===n.GroupType.MsbOnRampButton)[0];if(f&&((r=t===null||t===void 0?void 0:t.suggestions)===null||r===void 0?void 0:r.length)>0){let r=f.suggestions;n.isMsbQwsDocsCacheEnabled(this._partialQuery)&&(r=r.filter(n=>n.type!=="FL"));const u=t.suggestions.slice(0,n.config.ziRecommendedDocsResultsCount),e=this.getMaxMsbItems(),o=e-u.length;r=r.slice(0,o);r.push(...u);i&&(i.suggestions[0].suppressed=!1,r.push(...i.suggestions),this.groups=this.groups.filter(t=>t.type!==n.GroupType.MsbOnRampButton));f.suggestions=r;this.groups=this.groups.filter(t=>t.type!==n.GroupType.RecommendedDocs);this.groups.filter(t=>t.type===n.GroupType.QuickWorkSearch).map(n=>n.instRegionName="QuickWorkSearchWithRecDocs")}!f&&((u=t===null||t===void 0?void 0:t.suggestions)===null||u===void 0?void 0:u.length)>0&&i&&(i.suggestions[0].suppressed=!1,t.suggestions.push(...i.suggestions),this.groups=this.groups.filter(t=>t.type!==n.GroupType.MsbOnRampButton))}}msbGroupsSetupTopList(){var t,i;if((n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isQwsTopListEnabled())&&((t=this._contentQuery)===null||t===void 0?void 0:t.isSearchHomeZI)){const t=this.groups.filter(t=>t.type===n.GroupType.QuickWorkSearchTopList||t.type===n.GroupType.MsbQuickWorkQueriesTopList)[0];if(t){const u=this.groups.filter(t=>t.type===n.GroupType.QuickWorkSearch)[0];u&&(u.hideGroupHeader=!0);const f=this.groups.filter(t=>t.type===n.GroupType.RecommendedDocs)[0];f&&(f.hideGroupHeader=!0);t.cssClasses=`${t.cssClasses||""} msbQwsTop`;const r=this.groups.filter(t=>t.type===n.GroupType.MsbQuickWorkQueriesTopList)[0];r&&((i=r===null||r===void 0?void 0:r.suggestions)===null||i===void 0?void 0:i.length)>0&&(t.cssClasses=`${t.cssClasses||""} msbQwqTop`)}}}msbGroupsSetLayout(){var t;if((n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isQwsTopListEnabled())&&((t=this._contentQuery)===null||t===void 0?void 0:t.isSearchHomeZI)&&n.RuntimeConfig.AlwaysWide){const t=this.groups.filter(t=>t.type===n.GroupType.QuickWorkSearch)[0];if(t)t.cssClasses=`${t.cssClasses||""} colRight fbig`;else if(n.msbHost.features.isQwsTopListEnabled()){const t=this.groups.filter(t=>t.type===n.GroupType.RecommendedDocs)[0];t&&(t.cssClasses=`${t.cssClasses||""} colRight fbig`)}const i=this.groups.filter(t=>t.type===n.GroupType.QuickWorkSearchTopList||t.type===n.GroupType.MsbQuickWorkQueriesTopList)[0];i&&(i.cssClasses=`${i.cssClasses||""} colRight fbig`)}}select(t,i){var r,u,f,e,o,s;if(n.DialogBox&&n.DialogBox.isVisible())n.DialogBox.select(t);else if(this._menuFactory.isMenuVisible()&&n.contains(this._menuFactory.getSelectableItems(),t))this._menuFactory.select(t,!1);else if(this._previewPane&&n.contains(this._previewPane.getSelectableItems(),t))this._previewPane.select(t,!1);else{let h=this._selectedItem;if(h&&(h.selected=!1,((r=this._partialQuery)===null||r===void 0?void 0:r.scope)===n.Scope.Work&&(h.hasPreviewPaneOpened=!1,(h===null||h===void 0?void 0:h.type)===n.GroupType.Related&&((u=_ge(h.id))===null||u===void 0?void 0:u.blur())),n.config.enableMessageBanner&&pi.findIndex(n=>n.id===h.id)!=-1&&((f=_ge(h.id))===null||f===void 0?void 0:f.blur()),n.config.supportDMA&&bi.some(n=>n.id===h.id)&&((e=_ge(h.id))===null||e===void 0?void 0:e.blur()),this.setSelectedStyleSuspended(h,!1)),t==d?(this._selectedItem=null,n.Host.searchBoxHasFocus()||n.Host.setFocusInSearchBox(null,"rvm_select")):(this._selectedItem=t,t&&(this.isDSBItem(t)&&n.Host.searchBoxHasFocus()&&n.Host.setFocusInWebView("rvm_dsb_select"),t.selected=!0,((o=this._partialQuery)===null||o===void 0?void 0:o.scope)===n.Scope.Work&&(this._selectedItem.hasPreviewPaneOpened=!0),(s=t.onSelected)===null||s===void 0?void 0:s.call(t),this.setSelectedStyleSuspended(t,!n.Host.searchBoxHasFocus()))),i&&t&&(t.arrowOrTabAction=!0),this.renderSelection(this._selectedItem,h),this.isScopeElement(t)&&this._headerFooterViewModel.select(t,!1),i){let i=t?t.query:null;i&&this._partialQuery.scopePrefix&&(i=this._partialQuery.scopePrefix.trim()+": "+i);n.Host.updateQueryWithoutRefetching(i)}}}resetIconTimers(n,t){let i=typeof n=="undefined"||!n,r=typeof n=="undefined"||n;if(i){if(t)for(let n of this._renderGroupsIconsCBs)n();this._renderGroupsIconsCBs=[];this._renderGroupsTimerForIcons&&(sb_ct(this._renderGroupsTimerForIcons),this._renderGroupsTimerForIcons=null)}if(r){if(t)for(let n of this._renderTopResultsIconsCBs)n();this._renderTopResultsIconsCBs=[];this._renderTopResultsTimerForIcons&&(sb_ct(this._renderTopResultsTimerForIcons),this._renderTopResultsTimerForIcons=null)}}setupIcon(t,i,r,u){if(n.config.noFetchIcons||n.config.reactGroups){u();return}let f=()=>{r.isTopResult?this.renderTopResults():this.renderGroups(),this.resetIconTimers(r.isTopResult,!0)},e=t=>{r.iconsPendingReturn==0?(f(),t&&t()):r.isTopResult?(t&&this._renderTopResultsIconsCBs.push(t),this._renderTopResultsTimerForIcons||(this._renderTopResultsTimerForIcons=n.safeSetTimeout(()=>{this._renderTopResultsTimerForIcons=null,f()},fi,"renderTRIconsAsync"))):(t&&this._renderGroupsIconsCBs.push(t),this._renderGroupsTimerForIcons||(this._renderGroupsTimerForIcons=n.safeSetTimeout(()=>{this._renderGroupsTimerForIcons=null,f()},fi,"renderGRPIconsAsync")))};if(++r.iconsPendingReturn,!i.suppressed&&i.getIcon){n.InstrumentationHelper.notifyIconPending(t,r.isTopResult,"RootViewModel.setupIcon.if");let f=this._partialQuery;i.getIcon(er.getImageSize(f,i,r.isTopResult),f=>{i.icon=f;let o=()=>{--r.iconsPendingReturn,this._partialQuery&&t==n.SequenceNumberManager.getSequenceNumber()&&(n.InstrumentationHelper.notifyIconReadyOrFailed(t,r.isTopResult),(r.isTopResult&&n.contains(this.topResults,i)||!r.isTopResult&&this.groups.some(t=>n.contains(t.suggestions,i)))&&e(u))};n.populateImageRatio(i.icon,i.type,o)})}else if(!i.suppressed&&i.icon&&n.canIconFail(i.icon)){n.InstrumentationHelper.notifyIconPending(t,r.isTopResult,"RootViewModel.setupIcon.elseIf");let f=i.icon.getFallbackIcon,o=(n,t)=>t(i.icon);const s=i.icon.isValidSize,h=()=>{i.getIcon=f,this.setupIcon(t,i,r,u),n.InstrumentationHelper.notifyIconReadyOrFailed(t,r.isTopResult)},c=()=>{i.icon.isSmall=!0,i.getIcon=o,this.setupIcon(t,i,r,u),n.InstrumentationHelper.notifyIconReadyOrFailed(t,r.isTopResult)};i.icon.onIconError=h;i.icon.onIconRendered=(f,e)=>{s(f,e)||i.icon.isSmall?(n.InstrumentationHelper.notifyIconReadyOrFailed(t,r.isTopResult),u()):c()};--r.iconsPendingReturn;e()}else--r.iconsPendingReturn,u()}static getImageSize(t,i,r){return t.isSearchHomeZI?i.type=="TOPL"?7:8:t.scope==n.Scope.Apps&&!t.queryToFetch?3:n.displayedInGridLayout(i.type)?2:r?0:1}isSuggestionOrGroup(n){return!this.isScopeElement(n)}isSuggestion(t){return!n.isGroup(t)&&!this.isScopeElement(t)&&!this.isAdvancedOption(t)}isDSBItem(n){return!!(n===null||n===void 0?void 0:n.dsb)}isLeftRightArrowKey(n){return n==37||n==39}isAdvancedOption(n){return typeof n.layout=="number"}isFlyout(n){return this.isFlyoutVisible()&&w.indexOf(n)>=0}isBodyOrSuggestion(n){return n&&(n.tagName.toLowerCase()=="body"||n.tagName.toLowerCase()=="iframe"||n.className&&n.classList.contains("suggestion"))}submit(t,i,r,u,e){var h,c,l,a;let s=e?5:i?6:1,o=n.getCurrentActiveElement();if(n.DialogBox&&n.DialogBox.isVisible()){n.DialogBox.submit();return}if(this._previewPane&&this._previewPane.hasFocus()){let n=this._previewPane.getSelectedItem();if(n&&n.click&&n.optionType===undefined){n.click(t,s);return}}else if(!this._selectedItem||!this.isScopeElement(this._selectedItem)||this._menuFactory.isMenuVisible()||this._popoverFactory&&this._popoverFactory.isPopoverVisible()){if((n.RuntimeConfig.QfMode==5||n.RuntimeConfig.QfMode==9)&&!this._selectedItem){n.Host.submitFileExplorerTextSuggestion(this._partialQuery.queryToFetch);return}}else{_ge(this._selectedItem.id).click();return}let y=this._menuFactory.getSelectedItem();if(y){y.click&&y.click(t,s,u);return}let p=this._popoverFactory?this._popoverFactory.getSelectedItem():null;if(p){this._popoverFactory.submit(p);return}if(((h=this._selectedItem)===null||h===void 0?void 0:h.id)===v){this.click(t,this._selectedItem,s,u);return}let w=!this.isBodyOrSuggestion(o);if(w){n.Host.isRequestFocusAvailable()?o.id==lt||o.id==ct?o.click():o.id==vt||o.id==f||o.id==yt?o.click():(this._partialQuery.scope===n.Scope.Work&&((l=(c=this._selectedItem)===null||c===void 0?void 0:c.typeWithSource)===null||l===void 0?void 0:l.type)===n.GroupType.Related||((a=this._selectedItem)===null||a===void 0?void 0:a.id)==at)&&o.click():o.click();return}if(this._lastUpdatedSequenceNumber!=r&&(!this._selectedItem||this._selectedItem==this.topResults[0])){this._pendingSubmitSequenceNumber=r;this._pendingSubmitModifierKeys=u;this._pendingSubmitTimeStamp=t;return}this._selectedItem?this.click(t,this._selectedItem,s,u):this.groups.length>0&&this._partialQuery.fullPartialQuery&&this.showDisableEnterMessage()}doubleClickGuardedHandler(t){let i;return(r,u)=>{i&&n.getCurrentTime()-i<=250||(i=n.getCurrentTime(),t(r,u))}}click(t,i,r,u){var e,o;if(this._page.hideTemporaryMessage(),this.isAdvancedOption(i)){i.click&&i.click(t,r,u);return}let f=n.isGroup(i)||this.isSubItem(i)?null:i;if(!i.instItem||f&&f.isReformulation||n.InstrumentationHelper.instrumentItemClick(t,i.instItem,i.sequenceNumber,f?f.instrumentPingBack:null,r,u),!f){i.click&&i.click(t,r,u);return}u=u||n.Host.getModifierKeyState();u.ctrlKey&&u.shiftKey?this.launchVerb(f,et,t):u.shiftKey?this.launchVerb(f,ot,t):((e=f.removeIcon)===null||e===void 0?void 0:e.selected)&&((o=f.removeIcon)===null||o===void 0?void 0:o.click)&&r===1?f.removeIcon.click(t,r,u):f.click&&f.click(t,r,u);this.onSuggestionLaunch(f,this._partialQuery)}onSuggestionLaunch(t,i,r){n.isChildSuggestion(t)&&t.parent&&(t=t.parent);this._itemLaunchEventHandlers.forEach(n=>n(t,i,r));n.getGroupType(t)!=n.GroupType.QuickSearch&&(this._addedManualLbshToMru=!0)}launchVerb(t,i,r){let u=di("launchVerb",t,n.config.rawVerbs,!1,u=>{let f=!1;for(let t of u)if(t.verb&&t.verb.toLocaleLowerCase()==i.toLocaleLowerCase()){t.executeSync?n.safeExecute(()=>t.executeSync(),"verb.executeSync",null,i):n.Async.safeChain("verb.executeAsync",()=>t.executeAsync(),()=>n.Host.manuallyDismissApp(),null,null,i);f=!0;break}f||t.click(r,0)},()=>!0);u||t.click(r,0)}getGroupHeaderClickAction(t,i,r,u){let f,e,o=null,s=null;if(n.RuntimeConfig.ScopesAvailable){let r=n.getScope(i.type);if(this.isWorkScope())return f=null,i.type!==n.GroupType.Related||(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isWorkScopeListViewEnabled())?i.type===n.GroupType.WorkSuggestions||i.type===n.GroupType.Related||(t===null||t===void 0?void 0:t.isWorkScopeZI)||i.type===n.GroupType.MRUHistory||(f=()=>{var t;_w.bfbWsbTel&&bfbWsbTel.logWorkScopeClick(`${n.GroupType[i.type]}GroupHeader`,{redirectTo:n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.mapRedirectTarget(u.type)});(t=this._headerFooterViewModel)===null||t===void 0?void 0:t.clickHandler(r,"groupHeader",i)}):f=()=>{const t=this.groups.findIndex(t=>t.type===n.GroupType.Related);t>-1&&(this.groups[t].isGroupContainerCollapsed=!this.groups[t].isGroupContainerCollapsed,this._selectedItem.isGroupContainerCollapsed=this.groups[t].isGroupContainerCollapsed)},[f,null,null,null,null];if(r!=n.Scope.All)if(i.type==n.GroupType.SearchSuggestions&&t.isSearchHomeZI)e=n.Host.getLocString("OpenPrivacyPortalButtonText"),o=n.Host.getLocString("ManageSearchHistory"),f=()=>n.Host.launchPrivacyPortalAsync();else return n.isL2(t)||!n.isScopeEnabled(r,n.ScopeConfig[r])?[null,null,null,null,null]:(f=()=>this._headerFooterViewModel.clickHandler(r,"groupHeader",i),[f,null,null,null,null])}if(!f)switch(i.type){case n.GroupType.Store:f=()=>n.Host.launchStoreSearchAsync(t.queryToFetch);break;case n.GroupType.SearchSuggestions:f=()=>this.launchSearch(t,r);break;case n.GroupType.PathCompletion:f=()=>n.Host.launchFolder(ir(t,this._partialQuery));break;case n.GroupType.Upsell:if(t.isSearchHomeZI)return s={content:"&#xE711",type:2},e=n.Host.getLocString("DismissUpsell"),o=n.Host.getLocString("DismissUpsell"),f=this._upsellViewModel.getDismissButtonAction(),[f,null,e,o,s];break;case n.GroupType.AnaheimDataTile:if(n.canShowAnaheimDataSHTileE2E())return s={content:"&#xE711",type:2,className:"anaheimDataTileDismissGroup"},e=n.Host.getLocString("DismissAnaheimData"),o=n.Host.getLocString("DismissAnaheimData"),f=()=>{n.config.enableAnaheimDataTSTile&&(n.LightweightStorage.setItem("AnaheimDataTSTileDismissed","1"),n.InstrumentationHelper.logClientInstEvent("Select","AnaheimDataTSTileDismissed",null)),n.Host.refreshCurrentPane()},[f,null,e,o,s];break;case n.GroupType.AnaheimDataList:if(n.canShowAnaheimDataSHListE2E())return s={content:"&#xE711",type:2,className:"anaheimDataListDismissGroup"},e=n.Host.getLocString("DismissAnaheimData"),o=n.Host.getLocString("DismissAnaheimData"),f=()=>{(n.config.enableAnaheimDataHS||n.config.enableAnaheimDataRC)&&(n.LightweightStorage.setItem("AnaheimDataBHListDismissed","1"),n.InstrumentationHelper.logClientInstEvent("Select","AnaheimDataBHListDismissed",null)),n.Host.refreshCurrentPane()},[f,null,e,o,s];break;case n.GroupType.PromoBanner:return s={content:"&#xE711",type:2},e=n.Host.getLocString("DismissUpsell"),o=n.Host.getLocString("DismissUpsell"),f=this._upsellViewModel.getDismissButtonAction(),[f,null,e,o,s]}if(f){if(!r)throw"No QS code for: "+n.GroupType[i.type];let t=n.InstrumentedItem.getNonSuggestionInstrumentedItem(r,n.SyntheticQSCodesMaps.KValues);return[f,t,e,o,s]}return[null,null,null,null,null]}shouldShowPlusIconInGroupHeader(t,i){if(n.getScope(t)==n.Scope.Web||t==n.GroupType.Store)return!1;if(t==n.GroupType.Apps&&this._partialQuery.queryToFetch.length<n.config.minLengthForIBAonL1)return!0;if(t==n.GroupType.Apps||t==n.GroupType.Settings){let r=i[t==n.GroupType.Apps?"PP":"ST"];return!(r&&r.maxedOut)}return!0}shouldHideGroupHeader(t,i){const u=n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.getTenantName(),r=i===n.Host.getLocString("MsbVerticalSuggestionGroupName")||i===n.Host.getLocString("MsbWorkVerticalSuggestionGroupName",u);if(this._partialQuery.scope!==n.Scope.Work||r){if(r&&(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isWorkScopeListViewEnabled())&&t==n.GroupType.Related)return!0}else return!1;return t===n.GroupType.VisualSearch?!0:t===n.GroupType.MsbOnRampButton?!0:!1}addGroup(t,r,u,f,e){var h,c;if(i(this.groups,t))throw new Error("Trying to add repeated group "+t);let y=pu[t.type],[l,a,p,k,w]=this.getGroupHeaderClickAction(this._partialQuery,t,y,r),s=ur(this._partialQuery,t.type,r,!!l);const v=((h=this._partialQuery)===null||h===void 0?void 0:h.scope)===n.Scope.Work,d=v&&t.source===5;if(t.source){const i=n.getGroupSourceDisplayName(t.source);i&&(!v||d)&&((n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.isTenantMsbEnabled())&&t.source==1&&t.type==n.GroupType.Documents?s.title=i+" - "+s.title:s.title+=" - "+i)}let g=fr(t.type,this._popoverFactory,this._partialQuery.isSearchHomeZI,u),o=[];n.isTopHitChildGroup(t)&&!v?o.push("topHitConnectedToGroup"):t.type==n.GroupType.TopApps||this._partialQuery.isSearchHomeZI&&t.type==n.GroupType.People&&!n.config.msbEnablePeopleZQ||t.type==n.GroupType.AnaheimDataTile?o.push("topItemsGroup"):t.type==n.GroupType.QuickSearch?o.push("balloonSuggGroup"):t.type==n.GroupType.QuickWorkSearch?(o.push("quickWorkSearchGroup"),n.msbHost&&n.msbHost.features.isHideTopAppEnabled()&&n.isMsbEnterprise()&&!n.msbHost.isGccHighTenant()&&o.push("topMostGroup")):t.type==n.GroupType.VisualSearch?o.push("snipSuggGroup"):t.type==n.GroupType.Upsell?(o.push("upsellSuggGroup"),n.shouldEnableAnaheimResetDefault()&&o.push("edgeUpsellDefaultTopBanner")):t.type==n.GroupType.PromoBanner?o.push("skypePromoSuggGroup"):t.type==n.GroupType.MRUHistory||t.type==n.GroupType.CuratedSuggestions?o.push("leftPaneZIsuggestions"):t.type==n.GroupType.People&&(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isPeopleZeroQueryEnabled(this._partialQuery))?o.push("recommendedSuggGroup"):t.type==n.GroupType.RecommendedDocs||t.type==n.GroupType.Documents&&n.isRecommendedDocsGroupEnabled(this._partialQuery)?(o.push("recommendedSuggGroup"),n.msbHost&&n.msbHost.features.isHideTopAppEnabled()&&n.isMsbEnterprise()&&!n.msbHost.isGccHighTenant()&&o.push("topMostGroup")):t.type==n.GroupType.AnaheimDataList?o.push("anaheimDataGroup"):t.type==n.GroupType.AnaheimDataTopHit?o.push("anaheimDataGroup"):t.type==n.GroupType.AnaheimDataQF?o.push("anaheimDataGroup"):t.type==n.GroupType.TrendingSearchData?o.push("trendingSearchDataGroup"):t.type==n.GroupType.CuratedSettings&&o.push("curatedSettingsGroup");(n.config.enableMRU10&&!n.config.useCobaltCSS&&n.isZeroInputAllScope(this._partialQuery)||((c=this._partialQuery)===null||c===void 0?void 0:c.isWorkScopeZI))&&o.push("mru10");let b={type:t.type,typeWithSource:t,id:"gr"+t.type+(t.source||""),text:s.title,secondaryText:p,secondaryIcon:w,narratorText:s.narratorText,tooltip:k,click:l,onlyAnnotationIsClickable:l&&(!!p||!!w),suggestions:[],instRegionName:n.GroupType[t.type],instItem:a,selected:!1,cssClasses:o.join(" ")||undefined,sequenceNumber:u,showPlusIconInHeader:this.shouldShowPlusIconInGroupHeader(t.type,e),hideGroupHeader:this.shouldHideGroupHeader(t.type,s.title),popover:g};return a&&n.InstrumentationHelper.instrumentSyntheticInstrumentedItem(u,y,a),this._resultsCounter.groups.push({typeWithSource:t,suggestions:[]}),this.insertGroup(b,f),b}insertGroup(t,i){let u=i.findIndex(i=>n.sameGroup(i,t.typeWithSource)),r=!1;for(let f=0;f<this.groups.length;f++){let e=i.findIndex(t=>n.sameGroup(t,this.groups[f].typeWithSource));if(e>u){this.groups.splice(f,0,t);r=!0;break}}r||this.groups.push(t)}handlePendingSubmit(t){if(this._pendingSubmitSequenceNumber==this._lastUpdatedSequenceNumber)try{if(this.topResults.length==0)(this.groups.length>0||t.length>0)&&this.showDisableEnterMessage();else{let t=this.topResults[0];return n.InstrumentationHelper.instrumentItemClick(this._pendingSubmitTimeStamp,t.instItem,t.sequenceNumber,t.instrumentPingBack,1,this._pendingSubmitModifierKeys),this._pendingSubmitModifierKeys&&this._pendingSubmitModifierKeys.ctrlKey&&this._pendingSubmitModifierKeys.shiftKey?this.launchVerb(t,et,this._pendingSubmitTimeStamp):this._pendingSubmitModifierKeys&&this._pendingSubmitModifierKeys.shiftKey?this.launchVerb(t,ot,this._pendingSubmitTimeStamp):t.click(this._pendingSubmitTimeStamp,0,this._pendingSubmitModifierKeys),0}}finally{this.resetPendingSubmitSequenceNumber()}return 1}showDisableEnterMessage(){this._page.showTemporaryMessage(n.Host.getLocString("EnterOnAmbiguousTopHitMessageText"))}showIndexingMessage(t){var i;t?(this._turnOnIndexingInstItem=null,this._launchIndexingDataModel=null):(this._turnOnIndexingInstItem=n.InstrumentedItem.getNonSuggestionInstrumentedItem("IMIO",n.SyntheticQSCodesMaps.KValues),i={id:v,selected:null,text:n.Host.getLocString("WindowsIndexingDisabledAction"),title:null,instItem:this._turnOnIndexingInstItem,click:(t,i)=>{let r=n.SequenceNumberManager.getSequenceNumber();r>this._lastUpdatedSequenceNumber&&n.InstrumentationHelper.instrumentSyntheticInstrumentedItem(r,"IMIO",this._turnOnIndexingInstItem);n.InstrumentationHelper.instrumentItemClick(t,this._turnOnIndexingInstItem,r,null,i,null);n.LocalDataProvider.launchIndexingOptions(!1)},layout:1,isSelectable:!0});this._launchIndexingDataModel={messageText:t?n.Host.getLocString("WindowsIndexingInProgressMessage"):n.Host.getLocString("WindowsIndexingDisabledMessage"),icon:t?{content:"&#xE895",type:2}:null,messageClassName:"indexingMessage",title:t?n.Host.getLocString("WindowsIndexingInProgressToolTip"):n.Host.getLocString("WindowsIndexingDisabledToolTip"),action:i};this._page.updateTemporaryMessageView(this._launchIndexingDataModel);this._shouldHideWorkUpsell=!0}hideIndexingMessage(){this._turnOnIndexingInstItem=null;this._page.updateTemporaryMessageView(null);this._shouldHideWorkUpsell=!1}shouldShowWorkUpsellMessage(){var t;const i=n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isWorkUpsellApplicable();if(i&&!this._shouldHideWorkUpsell)try{const i=JSON.parse(n.LightweightStorage.getItem(h));if(!this.isWorkUpsellExpired(i))return(i===null||i===void 0?void 0:i.clicked)!==s&&((t=this._partialQuery)===null||t===void 0?void 0:t.scope)==n.Scope.All}catch(r){return!1}return!1}isWorkUpsellExpired(t){const i=new Date,u=i.getDate(),r=i.getTime(),f=i.setDate(u+(n.config.msbWorkScopeBannerExpiryInDays||0));if(t&&t.expireDate&&!this.isOldVersion(t.version))return r>t.impressionsExpireDate&&r<t.expireDate&&(t.impressionsExpireDate=i.setDate(u+1),t.impressionsCount=0,this.setWorkUpsellInfo(t)),t.version==1&&t.expireDate>f&&t.clicked!=s&&n.isMsbInternalTenant()&&(t.expireDate=f,this.setWorkUpsellInfo(t)),r>t.expireDate||t.impressionsCount>=ki&&r<t.impressionsExpireDate;else{const t={clicked:0,expireDate:f,version:n.config.msbWorkScopeBannerIndicatorVersion,impressionsCount:0,impressionsExpireDate:i.setDate(u+1)};return this.setWorkUpsellInfo(t),!1}}isOldVersion(t){return t?t<n.config.msbWorkScopeBannerIndicatorVersion:!0}setWorkUpsellInfo(t){n.LightweightStorage.setItem(h,JSON.stringify(t))}updateWorkUpsell(t,i){try{if(t){const n=this.createWorkUpsellModel();n&&(this.updateWorkUpsellImpressionsCount(i),this._page.updateWorkUpsellAreaView(n))}else{const i=new Date,r=i.getTime();let t=JSON.parse(n.LightweightStorage.getItem(h));(t===null||t===void 0?void 0:t.clicked)==s||r>(t===null||t===void 0?void 0:t.expireDate)?this._page.removeWorkUpsellAreaView():this._page.updateWorkUpsellAreaView(undefined)}}catch(r){SharedLogHelper.LogError("updateWorkUpsell",r);this._page.updateWorkUpsellAreaView(undefined)}}updateWorkUpsellImpressionsCount(t){try{let i=JSON.parse(n.LightweightStorage.getItem(h));t&&i.impressionsCount<ki&&(i.impressionsCount=i.impressionsCount+1,this.setWorkUpsellInfo(i));_w.bfbWsbTel&&bfbWsbTel.logWorkScopeImpression("WsbWorkUpsell")}catch(i){throw new Error("Trying to get Work Upsell information form local storage");}}createWorkUpsellModel(){const t=n.config.useCobaltCSS;try{let i=JSON.parse(n.LightweightStorage.getItem(h)),r=n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.getTenantName();return{title:n.Host.getLocString("WorkUpsellTitle"),message:n.Host.getLocString("WorkUpsellMessage"),icon:{type:0,content:t?n.getImageUrl("ODSWG.f9357954-5e91-44ae-bf9e-4b01af111786"):n.getImageUrl("ODSWG.7d74e98f-f8f8-4514-b56c-a703d2feee72")},buttonMessage:n.Host.getLocString("WorkUpsellButtonMessage"),buttonDismissMessage:n.Host.getLocString("WorkUpsellCobaltDismissButtonMessage"),tooltip:n.Host.getLocString("WorkUpsellButtonTooltip",r),buttonClickHandler:()=>{var t;(t=this._headerFooterViewModel)===null||t===void 0?void 0:t.clickHandler(n.Scope.Work,"WsbWorkUpsell");i.clicked=s;this.setWorkUpsellInfo(i);this._page.updateWorkUpsellAreaView(undefined);_w.bfbWsbTel&&bfbWsbTel.logWorkScopeClick("WsbWorkUpsell")},dismissClickHandler:()=>{i.clicked=s,this.setWorkUpsellInfo(i),this._page.updateWorkUpsellAreaView(undefined),_w.bfbWsbTel&&bfbWsbTel.logWorkScopeClick("WsbWorkUpsellDismiss")}}}catch(i){return undefined}}getAvailableSpace(t){if(n.isL2(this._partialQuery)&&this._partialQuery.queryToFetch)return Number.MAX_VALUE;let i=this._page.getSuggestionsContainerHeight();return(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isTopBrandingBarEnabled())&&(i-=ii+10),n.config.extraTopPadding&&!n.RuntimeConfig.SearchBoxOnTop&&(i-=n.config.extraTopPadding),n.RuntimeConfig.ScopesAvailable&&(i-=pr),t.topResults.length==0||n.RuntimeConfig.FlatListWithoutGroups||(i-=hr),t.topResults.forEach(t=>i-=nr(t,n.isL2(this._partialQuery))),t.groups.forEach(n=>i-=nf(this._partialQuery,n)),t.groups.some(t=>t.typeWithSource&&n.isTopHitChildGroup(t.typeWithSource))&&t.groups.some(t=>t.typeWithSource&&!n.isTopHitChildGroup(t.typeWithSource))&&(i-=yr),i}getAvailableSpaceForZeroInputHomeTopSection(t,i){let r=this._page.getSuggestionsContainerWidth();if(n.shouldShowStaticSearchHome(this._partialQuery)||n.shouldShowDSBLayout(this._partialQuery))return r;r-=n.RuntimeConfig.AlwaysWide?wr:br;r-=rt;let u=t?t.suggestions.filter(n=>n&&!n.suppressed).length:0;u+=i.suppressed?0:1;let f=n.RuntimeConfig.AlwaysWide?kr:dr;return r-=(f+rt)*u,n.config.useCobaltCSS&&(r+=2*rt),r}canFitSuggestion(t,r,u){if(n.config.enableFullFitSearchTheWebMaxSuggestions&&r.type==n.GroupType.SearchSuggestions&&!this._partialQuery.isSearchHomeZI&&!t&&this.getAvailableSpace(this._resultsCounter)>=43)return u.suppressed&&(u.suppressed=!1),!0;if(u.suppressed||n.getTweakedSetting("scrollBarInL1")||u.handoffType===21)return!0;let e=gi(this._resultsCounter),f;return t?(f={typeWithSource:r,suggestions:[]},e.groups.push(f)):f=i(e.groups,r),f.suggestions.push({mainTextWrapsToTwoLines:u&&l(u,r.type,!1),isSuppressed:u&&u.suppressed,hasTwoLines:u&&n.contains(u.classNames,"forceNoWrapOutsideTopResult")}),this._partialQuery.isSearchHomeZI?this.canFitSuggestionInZeroInputHome(r,u):this.getAvailableSpace(e)>=0}canFitSuggestionInZeroInputHome(t,r){if(r.type==="SNSC"||t.type===n.GroupType.TrendingSearchData||(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isQwsEnabled())&&(t.type===n.GroupType.QuickWorkSearch||t.type===n.GroupType.RecommendedDocs)||n.config.msbEnablePeopleZQ&&this._partialQuery.scope==n.Scope.People)return!0;let u=i(this.groups,t);return t.type==n.GroupType.MRUHistory?!0:rr(t.type)?this.getAvailableSpaceForZeroInputHomeTopSection(u,r)>=0:(u?u.suggestions.length:0)<this.getMaxNumberOfRecentItems(t.type)}getCountOfSuggestionsToReduce(){let t=0,i=SearchAppWrapper.CortanaApp.height;(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isTopBrandingBarEnabled())&&n.isTwoPanesZIEnabled()&&(i-=ii);let f=n.shouldShowStaticSearchHome(this._partialQuery)||n.shouldShowDSBLayout(this._partialQuery),u=i-ut,r=n.canShowSearchHomeUpsell(this._partialQuery)&&f;return f?i<fu?t=r?7:4:i<uu?t=r?6:3:i<ru?t=r?5:2:i<ut?t=r?4:1:i>ut&&r&&(u<a/3?t=4:u<a/2?t=3:u<a/1.5?t=2:u<a&&(t=1)):i<iu?t=4:i<tu?t=3:i<nu?t=2:i<gr&&(t=1),t}getMaxNumberOfRecentItems(t){if(t==n.GroupType.MRUHistory||t==n.GroupType.RecommendedDocs||t==n.GroupType.CuratedSuggestions){if(n.shouldShowDSBFullWidth()&&n.config.enableMRUDSBV2)return n.config.MRUMaxItemsDSBV2;let t=n.ScopeConfig[n.Scope.All].enabledDataSourcesForZeroInput,i=t.some(n=>n&&n.suggestionGroupToggler&&n.suggestionGroupToggler.isHidden()),r=n.RuntimeConfig.PreviewPaneAvailable&&n.shouldEnableQuickSearches(n.Host.getLanguage().toLowerCase())&&!i||n.shouldShowStaticSearchHome(this._partialQuery)||n.shouldShowDSBLayout(this._partialQuery);if(r)return n.isL2(this._partialQuery)&&this._partialQuery.scope!==n.Scope.Work?10:this._partialQuery.isSearchHomeZI&&n.msbHost&&!n.msbDsbHost&&n.isMsbEnterprise()&&!n.msbHost.isGccHighTenant()&&n.msbHost.features.isHideTopAppEnabled()&&n.msbHost.isTenantMsbEnabled()?6:n.config.activityInZI-this.getCountOfSuggestionsToReduce()}return n.config.activityInZI}getMaxNumberOfGroupsToFitMinSuggestionsPerGroup(){if(n.isL2(this._partialQuery)&&this._partialQuery.queryToFetch||n.getTweakedSetting("scrollBarInL1"))return Number.MAX_VALUE;if(this._partialQuery.isSearchHomeZI)return n.msbHost&&n.msbHost.features.isQwsRecDocsEnabled()&&n.msbHost.features.isQwsTopListEnabled()&&n.isMsbEnterprise()&&!n.msbHost.isGccHighTenant()?(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbSHGroupsLimit)?n.TestHookUrlParameters.msbSHGroupsLimit:5+(n.config.msbQwsDynamicDisableEnabled?2:0)+(n.config.msbEnableDocumentZQ?1:0):5;let t=gi(this._resultsCounter);for(let i of t.groups)while(i.suggestions.length<n.config.minSuggestionsPerGroup)i.suggestions.push(i.suggestions[0]);while(this.getAvailableSpace(t)>0){let i={suggestions:[]};for(let t=0;t<n.config.minSuggestionsPerGroup;++t)i.suggestions.push({mainTextWrapsToTwoLines:!1,isSuppressed:!1,hasTwoLines:!1});t.groups.push(i)}return t.groups.length-1}onSuggestionAddedToGroup(t,r){if(this.updateNarratorWithPreviewMessage(t),n.isChildSuggestion(t)){t.displayed=!0;let i=t.parent;t.id=i.id+"_"+i.childSuggestions.indexOf(t);n.isJumpListSuggestion(t)&&t.tooltip===undefined&&n.Async.safeChain("getJumpListDescription",()=>t.jumpListItem.getDescriptionAsync(),i=>{t.tooltip=i,this.groups.some(i=>n.contains(i.suggestions,t))&&this.renderGroups()})}this.setRemoveIcon(t);let u=i(this._resultsCounter.groups,r.typeWithSource);u.suggestions.push({mainTextWrapsToTwoLines:l(t,r.typeWithSource.type,!1),isSuppressed:t.suppressed,hasTwoLines:n.contains(t.classNames,"forceNoWrapOutsideTopResult")});n.displayedInGridLayout(r.typeWithSource.type)&&r.suggestions.filter(n=>!n.suppressed).length>0&&(r.cssClasses+=n.isL2(this._partialQuery)?" gridLayout":" gridLayout gridLayoutMedium")}onGroupsCleared(){this._pendingSuggestionsInExistingGroups=[];this._pendingSuggestionsInMissingGroups=[];this._resultsCounter.groups=[];this._turnOnIndexingInstItem&&n.InstrumentationHelper.instrumentSyntheticInstrumentedItem(this._lastUpdatedSequenceNumber,"IMIO",this._turnOnIndexingInstItem)}launchSearch(t,i){let r=t.queryToFetch;n.config.enableMoreEdgeProtocol?n.Host.launchSearchAsync(r,this._navigationHelper.getSearchUrl(t.fullPartialQuery,r,i),!1,i):n.Host.launchSearchAsync(r,this._navigationHelper.getSearchUrl(t.fullPartialQuery,r,i),!1)}setRemoveIcon(t){let i=t.getExtraVerbs&&t.getExtraVerbs(!1).some(n=>n.verb=="RemoveFromDeviceHistory"),e=t.type=="HS"&&n.config.removeSuggUrl,r=t.getExtraVerbs&&t.getExtraVerbs(!1).some(n=>n.verb=="HideFromRecentHistory"),o=n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.forceRemoveIcon,u=t.getExtraVerbs&&t.getExtraVerbs(!1).some(n=>n.verb=="RemoveFromDeviceHistoryAll"),f=this._partialQuery.isSearchHomeZI&&t.type=="ANAH";if(o||i||e||u||f||r){let e="RemoveFromWebHistory";u?e="RemoveFromDeviceHistoryAll":i||f?e="RemoveFromDeviceHistory":r&&(e="HideFromRecentHistory");t.removeIcon={icon:{content:"&#xE711",type:2},title:n.Host.getLocString(e),selected:!1,click:(i,r)=>{this._page.hideTemporaryMessage(),n.InstrumentationHelper.instrumentItemClickForContextMenu(i,t.instItem,t.sequenceNumber,t.instrumentPingBack,r,null,e),this.launchVerb(t,e,i),n.Host.setFocusInSearchBox(null,"remove")}}}}setOpenIcon(t){t.openIcon={icon:{content:"&#xE8A7",type:2},title:"Open",selected:!1,click:(i,r)=>{this._page.hideTemporaryMessage(),n.InstrumentationHelper.instrumentItemClickForContextMenu(i,t.instItem,t.sequenceNumber,t.instrumentPingBack,r,null,"open"),this.launchVerb(t,"open",i),n.Host.setFocusInSearchBox(null,"open")}}}updateNarratorWithPreviewMessage(t){let r=n.RuntimeConfig.AlwaysWide?"PreviewPaneButtonNarratorMessageWidePane":"PreviewPaneButtonNarratorMessage",i=n.Host.getLocString(r);t.narratorText&&t.previewPaneType&&t.narratorText.indexOf(i)==-1&&(t.narratorText+=", "+i)}shouldShowMessageBanner(){var t;return n.config.enableMessageBanner&&((t=this._partialQuery)===null||t===void 0?void 0:t.scope)==n.Scope.All&&SearchAppWrapper.CortanaApp.isUserOnboarded()}buildMessageBannerModel(){if(!this.shouldShowMessageBanner())return null;let t=SearchAppWrapper.CortanaApp.getSearchAppLaunchCount();if(t>=y)return null;return{message:n.Host.getLocString("ReclaimSBMessage"),buttonKeepMessage:n.Host.getLocString("ReclaimSBKeepButtonMessage"),buttonUndoMessage:n.Host.getLocString("ReclaimSBUndoButtonMessage"),buttonDismissMessage:n.Host.getLocString("ReclaimSBDismissButtonMessage"),buttonKeepClickHandler:(t,i,r)=>{SearchAppWrapper.CortanaApp.setSearchAppLaunchCount(y),this.sendTelemetryForClick("RSBK",t,i,r,"SearchboxKeep"),n.Host.refreshCurrentPane()},buttonUndoClickHandler:(n,i,r)=>{let u=SearchAppWrapper.CortanaApp.revertToPreviousSearchBoxMode();u?SearchAppWrapper.CortanaApp.setSearchAppLaunchCount(y):SearchAppWrapper.CortanaApp.setSearchAppLaunchCount(t==0?0:t-1);this.sendTelemetryForClick("RSBU",n,i,r,"SearchboxUndo");SearchAppWrapper.CortanaApp.dismissApp()},dismissClickHandler:(t,i,r)=>{SearchAppWrapper.CortanaApp.setSearchAppLaunchCount(y),this.sendTelemetryForClick("RSBD",t,i,r,"SearchboxDismiss"),n.Host.refreshCurrentPane()}}}shouldShowDmaBanner(){return n.isThirdPartySearchAllowed()&&n.Host.canShowNotificationBanner()}buildDmaBannerModel(){if(!this.shouldShowDmaBanner())return null;return{title:n.Host.getLocString("DmaNotificationTitle"),message:n.Host.getLocString("DmaNotificationMessage"),buttonMessage:n.Host.getLocString("DmaNotificationButtonMessage"),buttonDismissMessage:n.Host.getLocString("DmaNotificationCobaltDismissButtonMessage"),buttonClickHandler:()=>{n.Host.launchSearchPermissions(),this._page.updateNotificationBannerAreaView(undefined),n.Host.setBannerInteraction()},dismissClickHandler:()=>{this._page.updateNotificationBannerAreaView(undefined),n.Host.setBannerInteraction()}}}sendTelemetryForClick(t,i,r,u,f){const o=n.SequenceNumberManager.getSequenceNumber();let e=n.InstrumentedItem.getNonSuggestionInstrumentedItem(t,n.SyntheticQSCodesMaps.KValues,n.SyntheticQSCodesMaps.HandoffsForNonSuggestions[t]);e=n.InstrumentationHelper.updateMessageBannerClickItemProps(e,f);n.InstrumentationHelper.instrumentSyntheticInstrumentedItem(o,t,e);n.InstrumentationHelper.instrumentItemClick(i,e,o,null,r,u)}onBeforeRenderTopResults(t,i,r,u,f){var o;this.topResults.forEach(n=>{this.setRemoveIcon(n),this.updateNarratorWithPreviewMessage(n)});n.config.enableOpenIconForTopHits&&this.topResults.length>=1&&this.setOpenIcon(this.topResults[0]);let s=1;this.topResults.length!=1||this.topResults[0].hasChildSuggestionsDisplayed||r.some(t=>n.isChildSuggestion(t))&&(((o=this._partialQuery)===null||o===void 0?void 0:o.scope)!==n.Scope.Work&&(this.topResults[0].hasChildSuggestionsDisplayed=!0),s=0);let h=!1,c=this.getSelectableItems();if(n.RuntimeConfig.FirstSuggestionSelectedByDefault){if(!this._selectedItem||!n.contains(c,this._selectedItem)||this.isScopeElement(this._selectedItem)||this._selectedItem==i[0]&&this.topResults[0]!=i[0]||this._selectedItem!=c[0]||this._selectedItem.previewPaneNeedsRefreshAfterDeduping){let t=this._partialQuery.queryToFetch&&this.topResults.length>0?this.topResults[0]:null;n.isThirdPartySearchAllowed()&&this._partialQuery.scope==n.Scope.ThirdPartyWeb&&(t=this.topResults.length>0?this.topResults[0]:null);const i=this._selectedItem&&this.isSuggestion(this._selectedItem)?this._selectedItem:null;if(n.config.synthWebNoBestMatch&&n.isNullOrUndefined(t)){let i=[n.GroupType.SearchSuggestions,n.GroupType.Websites],u=r.filter(t=>!n.contains(i,n.getGroupType(t)));u.length==0&&(t=r.length>0?r[0]:null)}this._previewPane&&n.RuntimeConfig.PreviewPaneAvailable&&(h=!1,n.safeExecute(()=>this._previewPane.onTopHitUpdated(this._partialQuery,i,t,this.getSuggestions(!1)),"ppOnTopHitUpdated"));this.select(t,!1);this._page.scrollToTop()}}else t&&this.select(null,!1);let l=this.topResults.length>0,e=t=>!t.suppressed&&t.staticGroupType!=n.GroupType.VisualSearch,a=r&&r.length>0;if(this._headerFooterViewModel&&!h){let t=l||r.some(e)||this.groups.some(n=>n.suggestions.some(e))||this._pendingSuggestionsInMissingGroups.some(n=>n.suggestions.some(e))||this._pendingSuggestionsInExistingGroups.some(n=>n.suggestions.some(e));!n.canShowWorkScopeZiPageContent(this._partialQuery)||n.canShowCuratedSuggestionInEnterpriseScope(this._partialQuery)||r.some(t=>t.staticGroupType==n.GroupType.MRUHistory)||(t=!1);this._headerFooterViewModel.render(this._partialQuery,l,t,u,f,a)}return s}isRankable(t){return n.config.enableAnaheimRelevance==2?t.typeWithSource.type!=n.GroupType.Websites&&t.typeWithSource.type!=n.GroupType.LocalPlaces&&!t.suggestions.some(n.enforceOriginalOrder):t.typeWithSource.type!=n.GroupType.SearchSuggestions&&t.typeWithSource.type!=n.GroupType.ChatWithBing&&t.typeWithSource.type!=n.GroupType.Websites&&t.typeWithSource.type!=n.GroupType.LocalPlaces&&!t.suggestions.some(n.enforceOriginalOrder)}isNotRankableWithRecourse(t){return t.typeWithSource.type==n.GroupType.Emails}openPreviewPane(t,i){i.stopPropagation();this._previewPane.showPreview(this._partialQuery,t);const r=n.getGroupType(t);if((n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isWorkMruEnabled())&&n.isWorkScopeMruGroupType(t)||r==n.GroupType.SearchSuggestions||n.isChildSuggestion(t))this.onSuggestionLaunch(t,this._partialQuery);this.select(t,!0);n.config.reactGroups&&this.selectGroupItem(t);n.Host.setFocusInSearchBox(null,"openPreviewPane")}mayNeedFlush(){return!n.RuntimeConfig.FlatListWithoutGroups}update(t,i,r,u,f,e,o,s,h,c){var p;let w=this.topResults;if(t&&(this._contentQuery=this._partialQuery,this._renderTopResultsTimerForIcons=null,this._renderGroupsTimerForIcons=null),n.config.enableMRUHint)for(let t of i)t.mruHintEnabled&&(t.uxHint=n.Host.getLocString("MruBestMatch"));let[b,it]=this.updateTopResults(t,i,r,u,f,h);it();this._resultsCounter.topResults=[];for(let t of this.topResults){t.previewPaneNeedsRefreshAfterDeduping=!1;let i=1+(t.primaryMetadata?1:0)+(t.secondaryMetadata?1:0);this._resultsCounter.topResults.push({mainTextWrapsToTwoLines:l(t,null,!0),numberOfLines:i,isHtmlAnswer:!!t.htmlContent,isSuppressed:!1,grid:n.displayedInGridLayout(t.type)})}if(this._autoComplete&&this.topResults.length>0&&this._selectedItem==this.topResults[0]&&this._autoComplete.apply(this.topResults[0]),this.handlePendingSubmit(f)==0)return this.toggleProgressBar(!0),0;this._partialQuery&&this._partialQuery.isSearchHomeZI&&this.toggleProgressBar(!h);let k=!1,v=0,rt=this.createIconRenderInfo(),g=n.config.msbDsbExtraInfoNoInstDebug==!0&&(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.isEduTenant()),nt=t=>{if(k){let i=this.groups.map(n=>n.typeWithSource.type);if(!this._contentQuery.queryToFetch&&v==0){let i=this._cvidAtLastRender!=n.Host.getConversationId();this._cvidAtLastRender=n.Host.getConversationId();n.InstrumentationHelper.instrumentZiRendered(u,i,t)}n.InstrumentationHelper.instrumentRenderFinished(u,o,i,v!=0,!this._contentQuery.queryToFetch)}},d=(t,i)=>{var e,o;let f=!1;if(this.isRankable(i)&&this._partialQuery&&this._partialQuery.queryToFetch)for(let n=0;n<i.suggestions.length;n++)if(t.rankingScore>i.suggestions[n].rankingScore){i.suggestions.splice(n,0,t);f=!0;break}if(n.config.enableQFSWBestPos&&t.type!="SW"&&i.suggestions.length>0&&t.handoffType==0)if(n.config.swBestPosition=="QFSWPositionT1")i.suggestions.length<3&&(i.suggestions.splice(i.suggestions.length-1,0,t),f=!0);else if(n.config.swBestPosition=="QFSWPositionT2")i.suggestions.splice(i.suggestions.length-1,0,t),f=!0;else if(n.config.swBestPosition=="QFSWPositionT3")for(let n=0;n<i.suggestions.length;n++)if(t.rankingScore>i.suggestions[n].rankingScore){i.suggestions.splice(n,0,t);f=!0;break}if(!f){const u=((e=this._partialQuery)===null||e===void 0?void 0:e.scope)===n.Scope.Work,r=!t.childSuggestions&&t.handoffType===21;u&&!((o=this._partialQuery)===null||o===void 0?void 0:o.isWorkScopeZI)&&!r&&i.suggestions.length>=n.config.msbWorkScopeGroupSuggestionLimit&&(t.suppressed=!0);(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isWorkScopeListViewEnabled())&&r&&this.groups.findIndex(i=>{var r;return((r=i.suggestions[0])===null||r===void 0?void 0:r.type)===n.getMsbSuggestionTypeFromSubverticalOnlineSuggestionType(t.type)})!==-1&&(t.suppressed=!0);i.suggestions.push(t)}++v;this.setupIcon(u,t,rt,()=>{--v;let n=g?"From: setupIcon root view model. handOffType: "+t.handoffType+"grouptype: "+i.type+"Search Home: "+this._partialQuery.isSearchHomeZI+"Wait 4 more res: "+r:null;nt(n)});this.onSuggestionAddedToGroup(t,i)},a=this.getMaxNumberOfGroupsToFitMinSuggestionsPerGroup()-this.groups.length,y=!1,tt=()=>{if(a!=0&&r||this.flush(d,u,s),this.groups.sort((t,i)=>s.findIndex(i=>n.sameGroup(i,t.typeWithSource))-s.findIndex(t=>n.sameGroup(t,i.typeWithSource))),this._partialQuery&&this._partialQuery.queryToFetch)for(let n of this.groups){if(this.isRankable(n))n.suggestions.sort((n,t)=>t.rankingScore-n.rankingScore);else if(this.isNotRankableWithRecourse(n)){let t=n.suggestions.map(n=>n.notAResult).findIndex(n=>n);t!=-1&&n.suggestions.splice(n.suggestions.length-1,0,n.suggestions.splice(t,1)[0])}this.populateGroupHeaderFlags(n)}};if(t||f.length>0||e.length>0){this.renderGroupsAfter(()=>{for(let n of e){let t=this.removeSuggestion(n,c);t&&(a+=1)}let i=(t,i)=>{let[f,r]=this.getGroupData(t);if(r){r.count&&r.count++;const u=n.config.minSuggestionsPerGroup&&!i?n.config.minSuggestionsPerGroup-r.suggestions.length:999;u>0&&this.canFitSuggestion(!1,f,t)?d(t,r):this._partialQuery.isSearchHomeZI||this.queueSuggestionInExistingGroup(t,r)}else a>0&&this.canFitSuggestion(!0,f,t)?(r=this.addGroup(f,t,u,s,c),this.shouldTrackGroupCount(r)&&(r.count=1),d(t,r),a-=1):this._partialQuery.isSearchHomeZI||this.queueSuggestionInMissingGroup(t,f,c)};for(let n of w){let[,t]=this.getGroupData(n);t&&t.count&&(t.count-=1)}const r=()=>this._contentQuery.isSearchHomeZI||n.getTweakedSetting("scrollBarInL1")||this.isWorkScope()||n.config.bypassSuggestionQueueForL2&&n.isL2(this._contentQuery);if(b&&!t){for(let t of f)n.contains(w,t)&&i(t,!0);for(let t of f)n.contains(w,t)||i(t,r())}else f.forEach(n=>i(n,r()));for(let n of this.topResults){let[,t]=this.getGroupData(n);t&&t.count&&(t.count+=1)}if(tt(),n.config.enableQFChatBeforeSuggestion){const[t,i]=this.groups.reduce((t,i,r)=>(i.type===n.GroupType.ChatWithBing&&t[0]===-1?t[0]=r:i.type===n.GroupType.SearchSuggestions&&t[1]===-1&&(t[1]=r),t),[-1,-1]);t!==-1&&i!==-1&&t>=i&&this.groups[t].suggestions.length>=n.config.minChatSuggestionToPromoteGroup&&([this.groups[t],this.groups[i]]=[this.groups[i],this.groups[t],])}});const r=n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isWorkUpsellApplicable();let i=!1;if(r&&this._partialQuery.queryToFetch&&(i=this.shouldShowWorkUpsellMessage(),this.updateWorkUpsell(i,this._isWorkUpsellShown!=i)),this._isWorkUpsellShown=i,this.isWorkScope()&&((p=this.groups)===null||p===void 0?void 0:p.length)>1&&!(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isWorkScopeListViewEnabled())){const t=this.groups.findIndex(t=>t.type===n.GroupType.Related);t>-1&&(this.groups[t].maxSuggestionsToShow=eu)}y=!0;k=!0}else a!=0&&r||(this._pendingSuggestionsInMissingGroups.some(n=>n.suggestions.length>0)||this._pendingSuggestionsInExistingGroups.some(n=>n.suggestions.length>0))&&(this.renderGroupsAfter(()=>tt()),y=!0,k=!0);if(b||y){let n;b?y||(n=!0):n=!1;this.resetIconTimers(n,!0)}let ut=this.groups.findIndex(t=>t.type==n.GroupType.MRUHistory);if(ut>-1){let t=this.groups.findIndex(t=>t.type==n.GroupType.CuratedSuggestions);t>-1&&this.groups.splice(t,1)}let ft=g?"From: 2nd call at update. AllDataSourceArrived: "+h+"Search Home: "+this._partialQuery.isSearchHomeZI+"Wait 4 more res: "+r:null;return nt(ft),h&&this.toggleProgressBar(!1),(n.config.mruSearchHome&&this._partialQuery.isSearchHomeZI&&this._partialQuery.scope==n.Scope.All||n.canShowWorkScopeZiPageContent(this._partialQuery))&&this.sortMRUList(),1}sortMRUList(){let t=this.groups.filter(t=>t.type==n.GroupType.MRUHistory),i=this.groups.filter(t=>t.type!=n.GroupType.MRUHistory);const r=this.getMaxNumberOfRecentItems(n.GroupType.MRUHistory);if(t.length>0){n.LightweightStorage.removeItem(li);let u=t[0];u.suggestions.sort((n,t)=>t.lastLaunchTime-n.lastLaunchTime);u.suggestions.length>r&&(u.suggestions=u.suggestions.splice(0,r));let f=-1;this.groups.forEach((t,i)=>{f=t.type==n.GroupType.MRUHistory?i:f});i.splice(f,0,u);this.groups=i;this.renderGroups()}else n.LightweightStorage.setItem(li,"1")}canGoToL2(n){return n.click&&!n.instItem}populateGroupHeaderFlags(t){if(this.isWorkScope()&&t.type!=n.GroupType.WorkSuggestions&&t.suggestions.length>n.config.msbWorkScopeGroupSuggestionLimit)t.showCountInHeader=!0,t.count=t.suggestions.length;else if(this.canGoToL2(t)){let n=t.suggestions.every(n=>n.suppressed);t.showCountInHeader=n}}shouldTrackGroupCount(n){return this.canGoToL2(n)}getGroupData(t){let r={type:n.getGroupType(t),source:t.sourceForGroup};return n.enableMRUSearchHome()&&r.type==n.GroupType.MRUHistory&&(r.source=undefined),[r,i(this.groups,r)]}removePendingSuggestionFromExistingGroup(n,t){for(let i=0;i<this._pendingSuggestionsInExistingGroups.length;++i){let r=this._pendingSuggestionsInExistingGroups[i];if(r.group==t){let t=r.suggestions.indexOf(n);if(t==-1)throw new Error("Pending suggestion not found in existing group");else{r.suggestions.splice(t,1);r.suggestions.length==0&&this._pendingSuggestionsInExistingGroups.splice(i,1);return}}}throw new Error("Pending suggestion not found: pending suggestions in existing groups is empty");}removePendingSuggestionFromMissingGroup(t,i){for(let r=0;r<this._pendingSuggestionsInMissingGroups.length;++r){let u=this._pendingSuggestionsInMissingGroups[r];if(n.sameGroup(u.typeWithSource,i)){let n=u.suggestions.indexOf(t);if(n==-1)throw new Error("Pending suggestion not found in missing group");else{u.suggestions.splice(n,1);u.suggestions.length==0&&this._pendingSuggestionsInMissingGroups.splice(r,1);return}}}throw new Error("Pending suggestion not found: pending suggestions in missing groups is empty");}queueSuggestionInExistingGroup(n,t){let i=tr(this._pendingSuggestionsInExistingGroups,t.typeWithSource);i?i.suggestions.push(n):(i={group:t,suggestions:[n]},this._pendingSuggestionsInExistingGroups.push(i))}queueSuggestionInMissingGroup(n,t,r){let u=i(this._pendingSuggestionsInMissingGroups,t);u?u.suggestions.push(n):(u={typeWithSource:t,suggestions:[n],extraSignalsMap:r},this._pendingSuggestionsInMissingGroups.push(u))}partialFlush(n,t,i,r){while(n>0&&i.length>0){let u=i[0];this.canFitSuggestion(!1,t.typeWithSource,u)&&r(u,t);i.splice(0,1);n-=1}}flush(t,i,r){for(let u of this._pendingSuggestionsInMissingGroups){let f=u.suggestions[0];if(f&&this.canFitSuggestion(!0,u.typeWithSource,f)){let e=this.addGroup(u.typeWithSource,f,i,r,u.extraSignalsMap);this.shouldTrackGroupCount(e)&&(e.count=u.suggestions.length);this.partialFlush(n.config.minSuggestionsPerGroup,e,u.suggestions,t);u.suggestions.forEach(n=>this.queueSuggestionInExistingGroup(n,e));u.suggestions=[]}}while(this._pendingSuggestionsInExistingGroups.some(n=>n.suggestions.length>0))for(let i of this._pendingSuggestionsInExistingGroups){let r=n.config.minSuggestionsPerGroup?1:i.suggestions.length;this.partialFlush(r,i.group,i.suggestions,t)}}removeSuggestion(t,r){let f={type:n.getGroupType(t),source:t.sourceForGroup},u=i(this.groups,f);if(u)if(n.tryRemove(u.suggestions,t)){let f=i(this._resultsCounter.groups,u.typeWithSource),e=l(t,u.typeWithSource.type,!1);if(n.removeFirstWhere(f.suggestions,n=>n.mainTextWrapsToTwoLines==e),n.displayedInGridLayout(u.typeWithSource.type)&&u.suggestions.filter(n=>!n.suppressed).length==0&&(u.cssClasses=""),u.suggestions.length==0){n.tryRemove(this.groups,u);this._resultsCounter.groups=this._resultsCounter.groups.filter(n=>n!=f);let t=tr(this._pendingSuggestionsInExistingGroups,u.typeWithSource);return t&&this._pendingSuggestionsInMissingGroups.push({typeWithSource:u.typeWithSource,suggestions:t.suggestions,extraSignalsMap:r}),!0}}else this.removePendingSuggestionFromExistingGroup(t,u);else this.removePendingSuggestionFromMissingGroup(t,f);return!1}isScopeElement(n){return this._headerFooterViewModel&&this._headerFooterViewModel.isScopeElement(n)}createIconRenderInfo(n){let t={iconsPendingReturn:0,isTopResult:n};return this._iconRenderInfos.push(t),t}getCurrentTopResults(){return this.topResults.slice(0)}getTopResultsWhichFitInCanvas(n){return n}resetAriaSelected(n){n&&this._page.render(()=>{let t=_ge(n.id);t&&(t.setAttribute("aria-selected","false"),t.setAttribute("aria-selected","true"))})}updateTopResults(t,i,r,u,f,e){var h;t!=(u!=this._lastUpdatedSequenceNumber)&&((h=i[0])===null||h===void 0?void 0:h.scope)!=n.Scope.ThirdPartyWeb&&SharedLogHelper.LogError("updateTopResult",t+" != (sequenceNumber "+u+" != lastUpdateSequenceNumber "+this._lastUpdatedSequenceNumber+")",new Error("Precondition failed"));this._lastUpdatedSequenceNumber=u;t&&(this.groups=[],this.onGroupsCleared());let v=this._selectedItem,o=this.topResults;i=this.getTopResultsWhichFitInCanvas(i);i.forEach(t=>{n.RuntimeConfig.QfMode==5||n.RuntimeConfig.QfMode==9||t.staticGroupType&&t.staticGroupType==n.GroupType.Upsell||!t.secondaryMetadata||t.secondaryMetadata.indexOf(n.Host.getLocString("LastModified")+": ")!==0||(t.template=1,t.narratorText=n.getNarratorText(t))});let s=!n.sequenceEqual(i,o)||o.some(n=>n.needsRefreshAfterDeduping);s&&(this.topResults=i.slice(0));let c=!1,l=s?i.length:0,y=this.createIconRenderInfo(!0),a=()=>{c&&(n.config.enableLocalInstrumentation&&n.InstrumentationHelper.instrumentRenderedLocalSuggestion(u,i),n.InstrumentationHelper.instrumentTopResultRendered(u,i.map(n=>n.type),l!=0))};if(s)this.renderTopResultsAfter(()=>{for(let t of this.topResults)t.needsRefreshAfterDeduping=!1,n.contains(o,t)?l-=1:this.setupIcon(u,t,y,()=>{l-=1,a()});this.onBeforeRenderTopResults(t,o,f,r,e)}),this._page.updateMessageBannerAreaView(this.buildMessageBannerModel()),c=!0;else{let n=this.onBeforeRenderTopResults(t,o,f,r,e);n==0&&(this.renderTopResults(),c=!0)}return this._selectedItem&&(v!=this._selectedItem||t)&&n.contains(this.topResults,this._selectedItem)&&this.resetAriaSelected(this._selectedItem),[s,a]}renderGroupsAfter(n){let t=this._groupRenderingDisabled;this._groupRenderingDisabled=!0;try{n()}finally{this._groupRenderingDisabled=t;this.renderGroups()}}renderTopResults(t){this._topResultsRenderingDisabled||(this._page.updateTopResultsView({query:this._contentQuery,topResults:this.topResults,groups:this.groups},t),n.InstrumentationHelper.updateSuggestionsList(this.topResults,this.groups))}renderTopResultsAfter(n){let t=this._topResultsRenderingDisabled;this._topResultsRenderingDisabled=!0;try{n()}finally{this._topResultsRenderingDisabled=t;this.renderTopResults();for(let n of this.topResults)n.executeScript&&n.executeScript()}}static handleSuggestionDragStartEvent(t,i){if(!n.isSearchDragAndDropEnabled()){t.preventDefault();t.stopPropagation();return}const r=i===null||i===void 0?void 0:i.deviceItem;if(!r){t.preventDefault();t.stopPropagation();return}t.dataTransfer.effectAllowed="copyLink";r&&t.dataTransfer.setData("text/plain",r.serializedTileId)}}n.RootViewModel=er})(WSB||(WSB={}))